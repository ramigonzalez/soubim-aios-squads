# Wave 3 Log: Story 7.4 — Backend Gmail API Poller

**Date:** 2026-02-27
**Story:** 7.4 — Backend Gmail API Poller (Email Ingestion)
**Wave:** 3
**Status:** Complete

---

## Summary

Built the scheduled Gmail email poller service for email ingestion into the DecisionLog system. The poller authenticates with Gmail via OAuth2 (user credentials or service account), polls for unread project-related emails on a configurable interval, deduplicates by thread ID + message ID, creates Source records with status='pending', and generates AI one-line summaries via Claude. The scheduler runs via APScheduler integrated into FastAPI's lifespan.

## Files Created

| File | Purpose |
|------|---------|
| `decision-log-backend/app/services/gmail_auth.py` | Gmail OAuth2 authentication service (user creds + service account) |
| `decision-log-backend/app/services/gmail_poller.py` | Gmail polling service (fetch, match, dedup, store, AI summary) |
| `decision-log-backend/app/services/email_matcher.py` | Email-to-project matching service (label + subject fallback) |
| `decision-log-backend/app/scheduler.py` | APScheduler background job manager |
| `decision-log-backend/app/api/routes/admin.py` | Admin scheduler status endpoint |
| `decision-log-backend/tests/unit/test_gmail_poller.py` | Gmail poller unit tests (35 tests) |
| `decision-log-backend/tests/unit/test_email_matcher.py` | Email matcher unit tests (9 tests) |
| `decision-log-backend/tests/unit/test_gmail_auth.py` | Auth service unit tests (5 tests) |

## Files Modified

| File | Change |
|------|--------|
| `decision-log-backend/app/config.py` | Added 7 Gmail config fields + `is_gmail_configured()` method |
| `decision-log-backend/app/main.py` | Added scheduler startup/shutdown in lifespan + admin router |
| `decision-log-backend/requirements.txt` | Added google-api-python-client, google-auth, google-auth-oauthlib, google-auth-httplib2, APScheduler |

## Test Results

```
49 passed, 0 failed
```

- test_gmail_poller.py: 35 tests (HTML stripping, body extraction, address parsing, date parsing, dedup, exponential backoff, AI summary, poll cycle orchestration, label resolution)
- test_email_matcher.py: 9 tests (label matching with prefix stripping, subject fallback, case insensitivity, empty states)
- test_gmail_auth.py: 5 tests (OAuth2 flow, service account flow, credential reuse, not-configured error)

Full test suite (94 passed, 21 skipped) -- no regressions on pre-existing tests.

## Key Design Decisions

1. **Deduplication**: Uses composite check `(email_thread_id, webhook_id, source_type='email')` -- same message never stored twice, but distinct messages in same thread ARE stored separately
2. **Label Resolution**: Gmail label IDs are resolved to names via API; system labels (INBOX, UNREAD, etc.) excluded from project matching
3. **Exponential Backoff**: Retries on 429/500/503 with 2^attempt seconds (1, 2, 4, 8, 16s), max 5 retries; non-retryable errors (403, 404) raised immediately
4. **AI Summary**: Non-blocking -- failure leaves `ai_summary` null, does not prevent Source creation
5. **Scheduler**: `max_instances=1` prevents overlapping polls; `coalesce=True` skips missed triggers
6. **Minimum Interval**: 5-minute minimum enforced to prevent API quota exhaustion
7. **Project Model Fix**: Story spec referenced `project.title` but actual model uses `project.name` -- corrected in implementation

## Architecture Notes

- Gmail poller is opt-in: if `GMAIL_CLIENT_ID`/`GMAIL_SERVICE_ACCOUNT_JSON` not set, scheduler starts without the Gmail job
- All Gmail API calls go through `_call_gmail_api()` which handles retry logic and API call counting
- Admin endpoint `GET /api/admin/scheduler/status` requires director role
