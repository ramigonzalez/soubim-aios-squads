# Wave 3 Log: Story 10.1 — Email Item Extraction Pipeline

**Story:** 10.1 — Email Item Extraction Pipeline (8 SP)
**Wave:** 3
**Date:** 2026-02-27
**Status:** Complete

---

## Summary

Built the AI extraction pipeline for email sources. The pipeline extracts project items (all 5 types: idea, topic, decision, action_item, information) from email body content using a dedicated Claude API prompt. Handles thread deduplication, quoted reply stripping, and discipline inference from ProjectParticipant roster.

## Files Created

| File | Purpose |
|------|---------|
| `decision-log-backend/app/prompts/extract_email.md` | Email extraction prompt template |
| `decision-log-backend/app/services/email_extractor.py` | EmailExtractor service (strip_quoted_replies, Claude API call, thread overlap) |
| `decision-log-backend/app/services/ingestion_pipeline.py` | Ingestion pipeline with email/meeting dispatch |
| `decision-log-backend/tests/test_email_extractor.py` | 24 unit tests covering all acceptance criteria |
| `decision-log-backend/tests/fixtures/emails/test_email_decision.txt` | Fixture: email with decision items |
| `decision-log-backend/tests/fixtures/emails/test_email_action_items.txt` | Fixture: email with action items |
| `decision-log-backend/tests/fixtures/emails/test_email_thread.txt` | Fixture: threaded email with quoted replies |
| `decision-log-backend/tests/fixtures/emails/test_email_mixed.txt` | Fixture: email with all 5 item types |
| `decision-log-backend/tests/fixtures/emails/test_email_fyi.txt` | Fixture: informational email |

## Files Modified

None (ingestion_pipeline.py was created new since it did not previously exist in the codebase).

## Implementation Details

### Email Extraction Prompt (`extract_email.md`)
- Provides full context (project name, email subject, sender, date, participants)
- Classification signals for all 5 item types
- Explicit instructions to ignore quoted replies
- Output format: JSON array with item_type, statement, who, affected_disciplines, owner, due_date

### EmailExtractor Service (`email_extractor.py`)
- `strip_quoted_replies()`: Removes quoted content starting at `>`, `On...wrote:`, `---Original Message---`, `---------- Forwarded message`
- `EmailExtractor.extract()`: Builds prompt, calls Claude API, parses JSON response
- `EmailExtractor.check_thread_overlap()`: Detects previously processed sibling emails in same thread
- Handles markdown code block wrapping in API responses
- Graceful error handling: returns `[]` on API failure or invalid JSON

### Ingestion Pipeline (`ingestion_pipeline.py`)
- `process_approved_source()`: Dispatches to EmailExtractor for `source_type='email'`, extraction_v2 for meetings
- Stores extracted items as ProjectItem records with proper field mapping
- Updates source status to `processed` on success

## Test Results

```
24 passed, 0 failed

TestStripQuotedReplies (8 tests):
  - Removes > lines, ---Original Message---, On...wrote:, forwarded messages
  - Preserves non-quoted content, handles empty body, only-quoted body
  - Validates against actual thread fixture file

TestEmailExtractor (7 tests):
  - Extraction produces items with correct structure (mocked Claude API)
  - Handles markdown code block responses
  - Empty body and only-quoted body return empty list
  - Failed API call and invalid JSON return empty list gracefully

TestThreadOverlap (4 tests):
  - Detects processed sibling emails in same thread
  - Returns false when no siblings processed, no thread_id, or siblings pending

TestPipelineIntegration (2 tests):
  - Email branch calls EmailExtractor and updates status to processed
  - Pipeline stores correct ProjectItem records

TestPromptBuilding (3 tests):
  - Prompt includes email subject, participants, and body content
```

## Design Decisions

1. **Lazy import of EmailExtractor in pipeline**: Uses `from app.services.email_extractor import EmailExtractor` inside the conditional branch to avoid circular imports and unnecessary loading when processing non-email sources.

2. **strip_quoted_replies as module-level function**: Kept as a standalone function (not a method) for easy unit testing and potential reuse.

3. **Thread overlap as warning, not blocker**: When overlap is detected, a warning is logged but extraction proceeds. The quoted reply stripping already prevents duplicate item extraction.

4. **Prompt file loaded at init**: Template is read once when EmailExtractor is instantiated, not on every call.

---

## Acceptance Criteria Checklist

- [x] Email extraction prompt created at `app/prompts/extract_email.md`
- [x] Prompt handles all 5 item types with classification signals
- [x] Prompt instructs to ignore quoted replies
- [x] EmailExtractor service created with Claude API integration
- [x] Quoted reply stripping implemented (>, On...wrote:, ---Original Message---, Forwarded message)
- [x] Thread deduplication / overlap detection
- [x] Pipeline integration dispatches to EmailExtractor for email sources
- [x] Source status updated to processed after extraction
- [x] Error handling: failed extraction returns empty list
- [x] 5 curated email test fixtures created
- [x] 24 unit tests passing
