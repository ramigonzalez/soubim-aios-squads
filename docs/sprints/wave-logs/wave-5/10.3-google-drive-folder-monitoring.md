# Wave 5 â€” Story 10.3: Google Drive Folder Monitoring

**Agent:** @dev (Dex)
**Date:** 2026-02-28
**Status:** Complete

## Summary

Implemented automatic Google Drive folder monitoring for document ingestion. Projects can be configured with a Drive folder ID; a background scheduler polls configured folders for new PDF/DOCX files, downloads them, extracts text via DocumentProcessor, and creates Source records (status: pending) in the ingestion queue. Deduplication prevents re-processing via drive_file_id. A new PATCH endpoint and ProjectForm component allow directors to configure folder IDs per project.

## Files Created

| File | Purpose |
|------|---------|
| `decision-log-backend/app/services/drive_client.py` | Google Drive API client (service account auth, list files, download, verify access) |
| `decision-log-backend/app/services/drive_monitor.py` | Folder monitoring service (poll projects, download files, create Source records) |
| `decision-log-backend/app/services/document_processor.py` | Text extraction from PDF (pdfplumber) and DOCX (python-docx) files |
| `decision-log-backend/app/scheduler.py` | APScheduler BackgroundScheduler with Drive polling job |
| `decision-log-backend/tests/unit/test_drive_client.py` | 10 unit tests for DriveClient |
| `decision-log-backend/tests/unit/test_drive_monitor.py` | 9 unit tests for DriveMonitor |
| `decision-log-frontend/src/components/organisms/ProjectForm.tsx` | Project create/edit form with Drive Folder ID field |
| `decision-log-frontend/src/tests/components/ProjectForm.test.tsx` | 13 tests for ProjectForm component |
| `docs/sprints/wave-logs/wave-5/10.3-google-drive-folder-monitoring.md` | This wave log |

## Files Modified

| File | Changes |
|------|---------|
| `decision-log-backend/app/database/models.py` | Added `drive_folder_id`, `last_drive_poll` to Project; added `drive_file_id` (unique) + index to Source |
| `decision-log-backend/app/config.py` | Added `google_drive_enabled`, `google_drive_service_account_key`, `drive_poll_interval_minutes` settings + `is_drive_configured()` method |
| `decision-log-backend/app/main.py` | Integrated `app_scheduler.start()` in lifespan startup, `app_scheduler.shutdown()` in shutdown |
| `decision-log-backend/app/api/routes/projects.py` | Added `ProjectUpdate` Pydantic model + `PATCH /{project_id}` endpoint (director-only) |
| `decision-log-backend/requirements.txt` | Added google-api-python-client, google-auth, apscheduler, pdfplumber, python-docx |
| `decision-log-frontend/src/types/project.ts` | Added `project_type`, `drive_folder_id` fields to Project interface |
| `docs/stories/10.3-google-drive-folder-monitoring.md` | Marked all AC/tasks complete, updated file list and change log |

## Key Decisions

1. **Synchronous polling** -- DriveMonitor uses synchronous methods (not async) since APScheduler BackgroundScheduler runs in a thread pool, not an async event loop. This avoids complexity of mixing async/sync contexts.
2. **Lazy Google API imports** -- `google.oauth2` and `googleapiclient` are imported inside `DriveClient.__init__` to avoid import errors when the libraries are not installed (disabled environments).
3. **AI summary deferred** -- Source records are created with `ai_summary=None` rather than generating summaries inline. Summary generation is deferred to the ingestion approval workflow, keeping the polling loop fast.
4. **DocumentProcessor created** -- Story 10.2 (dependency) was not yet implemented, so a minimal `DocumentProcessor` with PDF and DOCX support was created to unblock this story.
5. **Scheduler created from scratch** -- No scheduler.py existed in the codebase. Created a new `AppScheduler` class with singleton pattern, designed to support multiple polling jobs independently.
6. **PATCH endpoint added** -- Projects route had no update endpoint. Added `PATCH /api/projects/{id}` with director-only authorization to enable Drive folder configuration.
7. **ProjectForm created** -- No ProjectForm component existed (Story 6.2 not yet implemented). Created a complete form with the Google Drive Folder ID field included from the start.

## Test Results

**Backend (19 tests): ALL PASSING**
```
tests/unit/test_drive_client.py - 10 passed
tests/unit/test_drive_monitor.py - 9 passed
Duration: 0.18s
```

**Frontend (13 tests): ALL PASSING**
```
src/tests/components/ProjectForm.test.tsx - 13 passed
Duration: 0.69s
```

**Full frontend suite: 147 passed, 2 skipped (pre-existing)**

Note: Pre-existing backend tests (test_auth, test_database, test_projects, test_migration_v2) have import errors due to missing `bcrypt` and `psycopg2` modules in this worktree environment -- these are not related to Story 10.3 changes.
