# Wave 4 Log: Story 10.2 — Document Ingestion (PDF & DOCX)

**Date:** 2026-02-27
**Sprint:** Sprint 7 (Week 11-12)
**Story Points:** 8
**Status:** Complete

---

## Summary

Implemented full document ingestion pipeline for PDF and DOCX files. Users can upload documents through the frontend, the backend extracts text, generates an AI summary, creates a Source record with `ingestion_status='pending'`, and when approved, the ingestion pipeline dispatches to the DocumentExtractor which uses Claude to extract structured project items.

---

## Files Created

| File | Purpose |
|------|---------|
| `decision-log-backend/app/api/routes/documents.py` | POST `/projects/{id}/documents` — multipart upload, validation, text extraction, AI summary, Source creation |
| `decision-log-backend/app/services/document_processor.py` | `DocumentProcessor` class — PDF text extraction via pdfplumber, DOCX via python-docx |
| `decision-log-backend/app/services/document_extractor.py` | `DocumentExtractor` class — fills prompt template, calls Claude API, parses JSON items |
| `decision-log-backend/app/services/ingestion_pipeline.py` | `process_source()` — dispatches approved sources to appropriate extractor, creates ProjectItem records |
| `decision-log-backend/app/prompts/extract_document.md` | Comprehensive extraction prompt covering meeting minutes, technical specs, reports — outputs JSON array of 5 item types |
| `decision-log-backend/tests/unit/test_document_processor.py` | 12 unit tests — PDF/DOCX extraction, edge cases, invalid content handling |
| `decision-log-frontend/src/components/molecules/DocumentUploadButton.tsx` | Upload button with file picker, upload state (idle/uploading/success/error), multipart FormData POST |
| `decision-log-frontend/src/tests/components/DocumentUploadButton.test.tsx` | 9 unit tests — rendering, file picker, upload states, API call verification |

## Files Modified

| File | Change |
|------|--------|
| `decision-log-backend/app/main.py` | Added `documents` router import and registration (`prefix="/api"`, tags=`["documents"]`) |
| `decision-log-backend/requirements.txt` | Added `pdfplumber>=0.10.0` and `python-docx>=1.0.0` |
| `decision-log-frontend/src/pages/ProjectDetail.tsx` | Imported and rendered `DocumentUploadButton` in header area next to view toggle |
| `docs/stories/10.2-document-ingestion-pdf-docx.md` | Marked AC checkboxes complete, updated file list and change log |

---

## Key Decisions

1. **Auth pattern:** Used `request.state.user` (set by auth middleware) matching the existing `projects.py` pattern, rather than a `Depends(get_current_user)` pattern that doesn't exist in this codebase.

2. **AI summary generation:** Sync call to Claude within the upload handler. Falls back to first 200 chars of text if the API call fails. Keeps the upload flow simple for V1.

3. **Ingestion pipeline:** Created as a new file (`ingestion_pipeline.py`) since it did not previously exist. Designed with a dispatcher pattern (`if source.source_type == "document"`) that can be extended for `email` and `meeting` types.

4. **File storage:** Local filesystem `uploads/documents/{project_id}/{source_id}.{ext}` with `os.makedirs(exist_ok=True)`. Production migration to object storage deferred.

5. **Frontend feedback:** Used inline state-based feedback (idle/uploading/success/error) with auto-reset timers instead of a toast library, since no toast library exists in the project.

6. **Test fixtures:** Generated PDF and DOCX fixtures programmatically in tests using `reportlab` and `python-docx` rather than committing binary fixture files.

---

## Items Not Implemented (Deferred)

- **Embedding generation** for extracted items (depends on vector infrastructure not yet built)
- **Enrichment pipeline** run after extraction (depends on enrichment service)
- **Drag-and-drop** upload support (optional enhancement per story)
- **OCR** for scanned PDFs (explicitly out of scope for V1)

---

## Test Results

### Backend (12 tests)
```
tests/unit/test_document_processor.py::test_pdf_single_page PASSED
tests/unit/test_document_processor.py::test_pdf_multi_page PASSED
tests/unit/test_document_processor.py::test_pdf_empty_pages PASSED
tests/unit/test_document_processor.py::test_pdf_invalid_content PASSED
tests/unit/test_document_processor.py::test_docx_single_paragraph PASSED
tests/unit/test_document_processor.py::test_docx_multiple_paragraphs PASSED
tests/unit/test_document_processor.py::test_docx_skips_empty_paragraphs PASSED
tests/unit/test_document_processor.py::test_docx_invalid_content PASSED
tests/unit/test_document_processor.py::test_empty_content PASSED
tests/unit/test_document_processor.py::test_unsupported_file_type PASSED
tests/unit/test_document_processor.py::test_case_insensitive_file_type PASSED
tests/unit/test_document_processor.py::test_supported_types_constant PASSED
======================== 12 passed in 1.34s =========================
```

### Frontend (9 tests + full suite regression)
```
DocumentUploadButton > renders upload button with correct text         PASSED
DocumentUploadButton > renders upload icon (svg element)               PASSED
DocumentUploadButton > has a hidden file input accepting .pdf and .docx PASSED
DocumentUploadButton > opens file picker when button is clicked        PASSED
DocumentUploadButton > shows uploading state during upload             PASSED
DocumentUploadButton > shows success state after successful upload     PASSED
DocumentUploadButton > calls API with correct FormData and headers     PASSED
DocumentUploadButton > shows error state on upload failure             PASSED
DocumentUploadButton > button is not disabled in idle state            PASSED

Full suite: 11 test files, 143 passed, 2 skipped — no regressions
```
