# Wave 4 â€” Story 8.2: Frontend Milestone Flag Toggle

**Agent:** @dev (Dex)
**Date:** 2026-02-27
**Status:** Complete

## Summary

Implemented the milestone flag toggle feature allowing admin users (role: `director`) to mark/unmark project items as milestones from three integration points:

1. **Project History rows** (ProjectItemRow via Timeline) -- star icon visible on hover for non-milestones, always visible for flagged milestones
2. **DrilldownModal** -- star icon in modal header next to the item statement (size: md)
3. **MilestoneTimeline** -- star icon on MilestoneNode for unflagging milestones directly from the timeline view

## Files Created

| File | Purpose |
|------|---------|
| `src/components/molecules/MilestoneStarToggle.tsx` | Reusable star toggle molecule with sm/md sizes, showOnHoverOnly mode, keyboard support |
| `src/tests/components/MilestoneStarToggle.test.tsx` | 13 unit tests covering visual states, interaction, accessibility, and event propagation |

## Files Modified

| File | Changes |
|------|---------|
| `src/components/molecules/ProjectItemRow.tsx` | Replaced inline star button with MilestoneStarToggle; fixed hover-only behavior (milestones always visible) |
| `src/components/organisms/DrilldownModal.tsx` | Added onToggleMilestone/isAdmin props; MilestoneStarToggle in header next to h2 statement |
| `src/components/molecules/MilestoneNode.tsx` | Added onToggleMilestone/isAdmin props; star toggle as rightmost element |
| `src/components/organisms/MilestoneTimeline.tsx` | Added onToggleMilestone/isAdmin props; passes them to all MilestoneNode instances |
| `src/components/organisms/Timeline.tsx` | Added onToggleMilestone/isAdmin props; passes them to SourceGroupAccordion and orphan ProjectItemRow |
| `src/pages/ProjectDetail.tsx` | Imports useAuthStore + useToggleMilestone; derives isAdmin; creates handleToggleMilestone; passes props to all three views |
| `docs/stories/8.2-frontend-milestone-flag-toggle.md` | Marked all AC checkboxes, updated file list and change log |

## Key Decisions

1. **Reused existing `useToggleMilestone` hook** from `useProjectItemMutation.ts` instead of creating a new `useMilestoneToggle` hook as the story originally proposed. The existing hook already has optimistic updates, rollback on error, and cache invalidation for both `projectItems` and `milestones` query keys.

2. **No toast library** -- used `console.error` for error feedback since no toast library exists in the codebase and the story instructions specified not to install new packages.

3. **Role check uses `director` only** -- the `User` type defines roles as `'director' | 'architect' | 'client'`, with no `'admin'` value. The `director` role corresponds to the admin pattern used in the backend's `_require_admin`.

4. **Props threading** -- the toggle handler and isAdmin flag are threaded from ProjectDetail page through MilestoneTimeline/Timeline organisms down to individual row/node molecules, maintaining separation of concerns (molecules remain stateless display components).

## Test Results

```
Test Files  25 passed (25)
Tests       312 passed | 2 skipped (314)
```

All 13 new MilestoneStarToggle tests pass. No regressions in the existing 299 tests.
