# Wave 4 Log: Story 9.3 — Multi-Discipline Circles

**Date:** 2026-02-27
**Story:** 9.3-multi-discipline-circles
**Agent:** @dev (worktree agent + manual merge)

---

## Summary

Implemented the DisciplineCircle and DisciplineCircles atoms and integrated them into DrilldownModal, MilestoneNode, and ProjectDetail. Updated discipline filter logic to V2 multi-discipline OR matching using `affected_disciplines[]`. Added `getDisciplineLabel()` utility and 23 unit tests.

---

## Files Created

| File | Purpose |
|------|---------|
| `src/components/atoms/DisciplineCircle.tsx` | Single discipline circle atom: colored circle with initial letter, isPrimary ring indicator, size prop (sm/md/lg), title tooltip |
| `src/components/atoms/DisciplineCircles.tsx` | Stacked circles with overflow: max prop, "+N" overflow with CSS tooltip showing remaining names, React.memo wrapper, size passthrough |
| `src/tests/components/MultiDisciplineIntegration.test.tsx` | 23 tests covering DisciplineCircle rendering, DisciplineCircles overflow/tooltip/memo, and filter OR logic |

## Files Modified

| File | Changes |
|------|---------|
| `src/lib/utils.ts` | Added `getDisciplineLabel()` (human-readable labels for 15+ disciplines). Updated `getDisciplineInitial()` fallback from `'?'` to first character of discipline name. |
| `src/components/organisms/DrilldownModal.tsx` | Merged with 8.2 milestone toggle. Added full discipline list using `DisciplineCircle` atoms + `getDisciplineLabel()` labels. Uses `affected_disciplines[]` array. |
| `src/pages/ProjectDetail.tsx` | Updated discipline filter from V1 single-match (`d.discipline`) to V2 OR logic using `affected_disciplines.some()`. V1 fallback preserved. |
| `src/components/molecules/MilestoneNode.tsx` | Replaced inline DisciplineCircles pill function with atom import `DisciplineCircles` from `atoms/`. Added `size="sm"` prop. Removed unused `getDisciplinePillColors` and `abbreviateDiscipline` imports. |
| `src/tests/components/MilestoneTimeline.test.tsx` | Updated discipline assertion from abbreviations ("Struct", "Arch") to circle initials ("S", "A") matching atom behavior. |

---

## Merge Notes

The 9.3 worktree agent worked from the original codebase (before 8.2 and 10.2 changes were merged), requiring manual conflict resolution:

1. **DrilldownModal.tsx** — Agent's version used V1 `Decision` type and lacked 8.2 MilestoneStarToggle. Manually merged to combine 8.2 milestone toggle + 9.3 multi-discipline display with V2 `ProjectItem` type.
2. **ProjectDetail.tsx** — Agent's version overwrote 8.2+10.2 changes (MilestoneTimeline, DocumentUploadButton, auth store). Only the discipline filter logic was extracted and merged.
3. **utils.ts** — Agent duplicated existing `getDisciplineCircleColor`/`getDisciplineInitial` functions with different return types (Tailwind classes vs hex colors). Only `getDisciplineLabel()` was added as a new function.
4. **DisciplineCircle.tsx** — Agent changed from hex color inline styles to Tailwind bg classes. Kept existing hex color approach, only added `lg` size option.
5. **MilestoneNode.tsx** — Agent noted this "didn't exist" but it did (from 8.1). Post-merge, replaced inline pill-style DisciplineCircles with the atom import.

---

## Key Decisions

1. **Kept hex color approach:** Existing `getDisciplineCircleColor` returns hex values used with `style={{ backgroundColor }}`. Agent's Tailwind class approach was rejected to avoid breaking existing consumers.

2. **CSS tooltip pattern:** Used `group-hover/overflow` with named groups for the overflow tooltip, consistent with `ParticipantIndicator` approach. No Radix dependency.

3. **getDisciplineInitial fallback:** Changed from `'?'` to `discipline.charAt(0).toUpperCase()` for better UX with unknown disciplines.

4. **V2 filter logic with V1 fallback:** Filter checks `affected_disciplines[]` first, falls back to single `discipline` field for V1 data.

---

## Test Results (Post-Merge)

```
Test Files  27 passed (27)
     Tests  344 passed | 2 skipped (346)
  Duration  2.75s

9.3 new tests: 23 passed (23)
- DisciplineCircle: 7 tests
- DisciplineCircles: 10 tests
- Multi-discipline filter OR logic: 6 tests
```

---

## Issues Encountered

- **Cross-worktree merge conflicts:** The primary challenge was merging changes from 3 parallel stories (8.2, 10.2, 9.3) that each modified overlapping files from different baselines.
- **Component atom mismatch:** MilestoneTimeline test expected pill abbreviations but atom renders circle initials — test updated.
- **getDisciplineInitial '?' fallback:** Would have caused test failure for unknown disciplines — fixed to use first character.
