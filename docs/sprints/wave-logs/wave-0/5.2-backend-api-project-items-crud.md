# Wave Log: Story 5.2 — Backend API — Project Items CRUD

## Wave: 0
## Status: completed
## Agent: @dev (Dex)

## Files Created
| File | Lines | Description |
|------|-------|-------------|
| `app/api/models/project_item.py` | ~120 | Pydantic models: ItemType, SourceType, Discipline enums; ProjectItemCreate/Update/Response; ImpactsSchema, ConsensusEntry |
| `app/api/routes/project_items.py` | ~270 | V2 items router: GET list with filters, GET detail, POST create, PATCH update, GET milestones |
| `tests/unit/test_project_items_api.py` | ~320 | 27 tests covering models, CRUD, backward compat, facets, response format |

## Files Modified
| File | Changes | Description |
|------|---------|-------------|
| `app/api/routes/decisions.py` | Rewrote for V2 compat | Filters `item_type='decision'`, adds `Deprecation: true` header, transforms to V1 field names |
| `app/main.py` | Added router import + registration | `project_items.router` registered at `/api` |

## Key Decisions
| Decision | Rationale | Alternatives Considered |
|----------|-----------|------------------------|
| Used `contains([d])` for JSONB discipline filter | SQLite-compatible JSON contains; works with both SQLite and PG | PG-specific `@>` operator (not SQLite-compatible) |
| OR logic for multi-discipline filter | User expects "show items matching ANY selected discipline" | AND logic (more restrictive, less intuitive) |
| `_item_to_response` helper function | DRY — reused across all endpoints | Inline serialization (duplicated code) |
| Facets computed from all items (not just filtered) | Consistent facet counts regardless of current filter state | Facets from filtered results (confusing UX) |

## Deviations from Story Spec
- `statement` field falls back to `decision_statement` in response (handles V1 data that only has decision_statement)
- `timestamp` field defaults to empty string for manual input items (no meeting timestamp)
- Consensus defaults to empty dict `{}` for manual items (not None)

## Test Results
```
27 passed, 0 failed in 0.88s
```

## Quality Check Results
```
All 27 tests passing. No new type errors. No lint errors introduced.
```

## Warnings for Downstream Stories
- `ProjectItemCreate.affected_disciplines` uses `List[Discipline]` enum — downstream stories must use enum values, not raw strings
- `_item_to_response` uses `item.statement or item.decision_statement` fallback — V1 items without `statement` field are handled
- Facets use Python-side counting (not SQL aggregation) — may need optimization for large datasets

## Blockers Encountered
None

## Quality Gate Review
- **Reviewer**: Self-review (YOLO mode)
- **Date**: 2026-02-27
- **Verdict**: PASS
