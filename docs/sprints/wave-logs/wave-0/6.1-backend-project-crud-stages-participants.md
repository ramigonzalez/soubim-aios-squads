# Wave Log: Story 6.1 — Backend — Project CRUD, Stages, Participants

## Wave: 0
## Status: completed
## Agent: @dev (Dex)

## Files Created
| File | Lines | Description |
|------|-------|-------------|
| `app/database/migrations/003_add_stages_templates.py` | ~80 | Migration SQL for project_stages, stage_templates tables, FK on projects |
| `app/api/models/project.py` | ~75 | Pydantic: StageCreate/Update/Response, ParticipantCreate/Update, ProjectCreate/Update, StageTemplateResponse |
| `app/api/routes/stages.py` | ~150 | Stage schedule router: GET list, POST set schedule, PATCH update, GET templates |
| `app/api/routes/participants.py` | ~150 | Participants CRUD: GET list, POST add, PATCH update, DELETE remove |
| `tests/unit/test_stages_api.py` | ~160 | 13 tests: ORM, validation, templates |
| `tests/unit/test_participants_api.py` | ~245 | 14 tests: CRUD, validation, extended project |

## Files Modified
| File | Changes | Description |
|------|---------|-------------|
| `app/database/models.py` | Added ProjectStage, StageTemplate models; updated Project.actual_stage_id FK | New ORM models with relationships, indexes, constraints |
| `app/api/routes/projects.py` | Complete rewrite for V2 | Extended CRUD: POST with stages+participants, PATCH with actual_stage_id, DELETE archive, V2 list response |
| `app/main.py` | Added stages + participants router imports + registrations | Both routers at `/api` prefix |

## Key Decisions
| Decision | Rationale | Alternatives Considered |
|----------|-----------|------------------------|
| `use_alter=True` on Project.actual_stage_id FK | Circular dependency: projects → project_stages → projects | Deferred FK constraint (more complex) |
| Stage dates stored as DateTime | Consistent with rest of codebase | Date type (required conversion) |
| POST /stages replaces all stages | Simpler mental model for users; schedule is set as a whole | Individual stage CRUD (more complex, partial updates) |
| Projects.py fully rewritten | V2 response shape incompatible with V1 service layer | Extend V1 service (would require larger refactor) |
| Creator auto-added as project member | Project creator should always have access | Separate step to add self (extra API call) |

## Deviations from Story Spec
- `actual_stage_id` FK uses `use_alter=True` to handle circular dependency between Project and ProjectStage tables
- Migration 003 is conceptual SQL (tables auto-created by SQLAlchemy metadata.create_all)
- Stage templates are seeded via test fixtures, not via migration (no PG available for migration execution)

## Test Results
```
27 passed, 0 failed in 0.40s (stages: 13, participants: 14)
Full regression: 143 passed, 21 skipped, 0 failures in 14.63s
```

## Quality Check Results
```
All tests passing. No new regressions. Pre-existing PG-dependent test_database errors unaffected.
```

## Warnings for Downstream Stories
- `Project.stages` relationship uses `foreign_keys` parameter to resolve ambiguity with `actual_stage_id`
- `StageCreate.stage_from/stage_to` are `date` type but stored as `DateTime` — conversion via `datetime.combine()`
- `ProjectCreate.title` maps to `Project.name` (not `Project.title`) — V2 API uses `title`, DB uses `name`
- `GET /stage-templates` is at `/api/stage-templates` (not nested under projects)
- Template seeding in production requires running migration 003 SQL or seeding via init_db

## Blockers Encountered
None

## Quality Gate Review
- **Reviewer**: Self-review (YOLO mode)
- **Date**: 2026-02-27
- **Verdict**: PASS
