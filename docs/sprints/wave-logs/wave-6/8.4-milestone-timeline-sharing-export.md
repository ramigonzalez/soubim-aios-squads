# Wave 6 — Story 8.4: Milestone Timeline Sharing & Export

**Agent:** @dev (Dex) — worktree agent-a75a3497
**Date:** 2026-02-28
**Status:** Complete

## Summary
Added sharing and export capabilities to the Milestone Timeline. Backend CRUD for shared links with token-based public access. Frontend ShareDialog with copy-to-clipboard and revoke. Public SharedMilestoneTimeline page at `/shared/milestones/:token`. PDF and JPEG export using html2canvas + jsPDF.

## Files Created
| File | Purpose |
|------|---------|
| `decision-log-backend/app/api/routes/shared_links.py` | 4 endpoints: POST create, GET list, DELETE revoke (admin), GET /shared/milestones/:token (public) |
| `decision-log-frontend/src/hooks/useSharedLinks.ts` | React Query hooks: useShareLinks, useCreateShareLink, useRevokeShareLink, useSharedTimeline |
| `decision-log-frontend/src/components/molecules/ShareDialog.tsx` | Radix Dialog with generate/copy/revoke link management |
| `decision-log-frontend/src/pages/SharedMilestoneTimeline.tsx` | Public read-only page, no auth, no nav bar, "Shared view" badge |
| `decision-log-frontend/src/lib/exportTimeline.ts` | exportAsPDF() and exportAsJPEG() using html2canvas + jsPDF |
| `decision-log-frontend/src/tests/components/ShareDialog.test.tsx` | 13 tests for ShareDialog component |
| `decision-log-frontend/src/tests/components/SharedMilestoneTimeline.test.tsx` | 11 tests for public shared page |
| `decision-log-backend/tests/unit/test_shared_links.py` | 19 backend tests across 6 test classes |

## Files Modified
| File | Changes |
|------|---------|
| `decision-log-backend/app/database/models.py` | Added SharedLink model (id, project_id, share_token, resource_type, created_by, expires_at, revoked_at, view_count) |
| `decision-log-backend/app/main.py` | Registered shared_links_router at /api prefix |
| `decision-log-backend/app/api/middleware/auth.py` | Added /api/shared/ to public_paths list |
| `decision-log-frontend/src/App.tsx` | Added /shared/milestones/:token route before ProtectedRoute |
| `decision-log-frontend/src/components/organisms/MilestoneTimeline.tsx` | Added forwardRef wrapping, readOnly prop (hides MilestoneFilterBar), ref on nav element |
| `decision-log-frontend/src/pages/ProjectDetail.tsx` | Added share/export state, milestoneTimelineRef, export handlers, Share/Export toolbar (admin-only), ShareDialog |
| `decision-log-frontend/package.json` | Added html2canvas and jspdf dependencies |

## Key Decisions
1. Token generation uses `secrets.token_urlsafe(32)` for 256-bit entropy.
2. Shared links default to 30-day expiry.
3. Public endpoint increments view_count on each access.
4. Export uses html2canvas to capture the DOM element referenced by milestoneTimelineRef.
5. MilestoneTimeline wrapped in forwardRef to support ref-based export capture.
6. Share/Export toolbar only visible to admin (director) role users.

## Merge Notes
- Worktree wrote a simplified MilestoneTimeline.tsx — discarded in favor of applying forwardRef/readOnly changes to main's existing component.
- SharedMilestoneTimeline.test.tsx needed MilestoneTimeline mock added during merge (real component uses internal hooks).
- Backend tests require psycopg2 for PostgreSQL — 2 pure-logic tests pass, 17 need DB (pre-existing env limitation).

## Test Results
```
Frontend:
  ShareDialog.test.tsx: 13 passed
  SharedMilestoneTimeline.test.tsx: 11 passed (after merge fix)

Backend:
  test_shared_links.py: 2 passed, 17 errors (psycopg2 not installed — pre-existing env issue)
```
