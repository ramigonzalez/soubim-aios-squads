# Story 3.3: Authentication & Login

**Story ID:** 3.3
**Assigned to:** @dev
**Sprint:** Sprint 4 (Week 6)
**Status:** Draft
**Estimation:** 5 story points (2-3 days)

---

## Summary

Implement complete authentication flow with login page, JWT token handling, protected routes, user context management, and logout functionality. Provides secure access control for the DecisionLog dashboard.

---

## Acceptance Criteria

- [ ] Login page component created
  - [ ] Email input with validation
  - [ ] Password input with visibility toggle
  - [ ] Submit button with loading state
  - [ ] Error message display
  - [ ] Remember me checkbox (optional)
- [ ] Authentication flow working:
  - [ ] POST `/api/auth/login` with credentials
  - [ ] JWT token stored in HTTP-only cookie
  - [ ] User info stored in Zustand state
  - [ ] Redirect to `/projects` on success
  - [ ] Show error message on failure
- [ ] Protected routes implemented:
  - [ ] Redirect to `/login` if not authenticated
  - [ ] Persist authentication across page refreshes
  - [ ] Check token validity on mount
- [ ] Logout functionality:
  - [ ] Clear token and user state
  - [ ] Redirect to login page
  - [ ] Call `/api/auth/logout` endpoint
- [ ] Session management:
  - [ ] Handle expired tokens (401 → auto-logout)
  - [ ] Refresh user data on app load
- [ ] Tests passing: `npm run test` (80%+ coverage)

---

## Tasks

### Task 1: Create Login Page Component (1 day)

1. **Create `src/pages/Login.tsx`**
   ```typescript
   import { useState, FormEvent } from 'react'
   import { useNavigate } from 'react-router-dom'
   import { useMutation } from '@tanstack/react-query'
   import { api } from '../services/api'
   import { useAuthStore } from '../store/authStore'
   import { getErrorMessage } from '../lib/errors'
   import { Button } from '../components/ui/button'
   import { Input } from '../components/ui/input'
   import { Label } from '../components/ui/label'
   import { Alert, AlertDescription } from '../components/ui/alert'

   export function LoginPage() {
     const [email, setEmail] = useState('')
     const [password, setPassword] = useState('')
     const [showPassword, setShowPassword] = useState(false)
     const navigate = useNavigate()
     const setUser = useAuthStore((state) => state.setUser)

     const loginMutation = useMutation({
       mutationFn: () => api.login({ email, password }),
       onSuccess: (response) => {
         setUser(response.user)
         navigate('/projects')
       },
     })

     const handleSubmit = (e: FormEvent) => {
       e.preventDefault()
       if (!email || !password) return
       loginMutation.mutate()
     }

     return (
       <div className="min-h-screen flex items-center justify-center bg-gray-50">
         <div className="max-w-md w-full space-y-8 p-8 bg-white rounded-lg shadow-md">
           <div>
             <h2 className="text-3xl font-bold text-center">DecisionLog</h2>
             <p className="mt-2 text-center text-gray-600">
               Sign in to your account
             </p>
           </div>

           <form onSubmit={handleSubmit} className="space-y-6">
             <div>
               <Label htmlFor="email">Email address</Label>
               <Input
                 id="email"
                 name="email"
                 type="email"
                 autoComplete="email"
                 required
                 value={email}
                 onChange={(e) => setEmail(e.target.value)}
                 className="mt-1"
                 placeholder="you@example.com"
               />
             </div>

             <div>
               <Label htmlFor="password">Password</Label>
               <div className="relative mt-1">
                 <Input
                   id="password"
                   name="password"
                   type={showPassword ? 'text' : 'password'}
                   autoComplete="current-password"
                   required
                   value={password}
                   onChange={(e) => setPassword(e.target.value)}
                   placeholder="••••••••"
                 />
                 <button
                   type="button"
                   onClick={() => setShowPassword(!showPassword)}
                   className="absolute right-2 top-2 text-gray-500 hover:text-gray-700"
                 >
                   {showPassword ? 'Hide' : 'Show'}
                 </button>
               </div>
             </div>

             {loginMutation.isError && (
               <Alert variant="destructive">
                 <AlertDescription>
                   {getErrorMessage(loginMutation.error)}
                 </AlertDescription>
               </Alert>
             )}

             <Button
               type="submit"
               className="w-full"
               disabled={loginMutation.isPending || !email || !password}
             >
               {loginMutation.isPending ? 'Signing in...' : 'Sign in'}
             </Button>
           </form>
         </div>
       </div>
     )
   }
   ```

2. **Install Shadcn/ui components**
   ```bash
   npx shadcn-ui@latest add button
   npx shadcn-ui@latest add input
   npx shadcn-ui@latest add label
   npx shadcn-ui@latest add alert
   ```

### Task 2: Implement Protected Routes (0.5 days)

1. **Create `src/components/ProtectedRoute.tsx`**
   ```typescript
   import { ReactNode, useEffect } from 'react'
   import { Navigate, useLocation } from 'react-router-dom'
   import { useQuery } from '@tanstack/react-query'
   import { useAuthStore } from '../store/authStore'
   import { api } from '../services/api'

   interface Props {
     children: ReactNode
   }

   export function ProtectedRoute({ children }: Props) {
     const location = useLocation()
     const { user, setUser, isAuthenticated } = useAuthStore()

     // Try to fetch current user if not authenticated
     const { data, isLoading, isError } = useQuery({
       queryKey: ['currentUser'],
       queryFn: () => api.getCurrentUser(),
       enabled: !isAuthenticated,
       retry: false,
     })

     useEffect(() => {
       if (data) {
         setUser(data)
       }
     }, [data, setUser])

     if (isLoading) {
       return (
         <div className="min-h-screen flex items-center justify-center">
           <div className="text-center">
             <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
             <p className="mt-4 text-gray-600">Loading...</p>
           </div>
         </div>
       )
     }

     if (isError || !isAuthenticated) {
       // Redirect to login, preserving the attempted location
       return <Navigate to="/login" state={{ from: location }} replace />
     }

     return <>{children}</>
   }
   ```

2. **Update Router with protected routes**
   ```typescript
   // src/Router.tsx
   import { Routes, Route, Navigate } from 'react-router-dom'
   import { LoginPage } from './pages/Login'
   import { ProjectsPage } from './pages/Projects'
   import { ProjectDetailPage } from './pages/ProjectDetail'
   import { ProtectedRoute } from './components/ProtectedRoute'

   export function Router() {
     return (
       <Routes>
         <Route path="/login" element={<LoginPage />} />

         <Route
           path="/projects"
           element={
             <ProtectedRoute>
               <ProjectsPage />
             </ProtectedRoute>
           }
         />

         <Route
           path="/projects/:id"
           element={
             <ProtectedRoute>
               <ProjectDetailPage />
             </ProtectedRoute>
           }
         />

         <Route path="/" element={<Navigate to="/projects" replace />} />
       </Routes>
     )
   }
   ```

### Task 3: Create Navigation Header with Logout (0.5 days)

1. **Create `src/components/Header.tsx`**
   ```typescript
   import { useNavigate } from 'react-router-dom'
   import { useMutation } from '@tanstack/react-query'
   import { useAuthStore } from '../store/authStore'
   import { api } from '../services/api'
   import { Button } from './ui/button'
   import {
     DropdownMenu,
     DropdownMenuContent,
     DropdownMenuItem,
     DropdownMenuLabel,
     DropdownMenuSeparator,
     DropdownMenuTrigger,
   } from './ui/dropdown-menu'
   import { User } from 'lucide-react'

   export function Header() {
     const navigate = useNavigate()
     const { user, logout } = useAuthStore()

     const logoutMutation = useMutation({
       mutationFn: () => api.logout(),
       onSettled: () => {
         logout()
         navigate('/login')
       },
     })

     const handleLogout = () => {
       logoutMutation.mutate()
     }

     return (
       <header className="bg-white border-b border-gray-200">
         <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
           <div className="flex justify-between items-center h-16">
             <div className="flex items-center">
               <h1 className="text-xl font-bold text-blue-600">DecisionLog</h1>
             </div>

             <div className="flex items-center gap-4">
               <span className="text-sm text-gray-600">{user?.name}</span>

               <DropdownMenu>
                 <DropdownMenuTrigger asChild>
                   <Button variant="ghost" size="icon">
                     <User className="h-5 w-5" />
                   </Button>
                 </DropdownMenuTrigger>

                 <DropdownMenuContent align="end">
                   <DropdownMenuLabel>
                     {user?.email}
                   </DropdownMenuLabel>
                   <DropdownMenuSeparator />
                   <DropdownMenuItem onClick={handleLogout}>
                     {logoutMutation.isPending ? 'Logging out...' : 'Logout'}
                   </DropdownMenuItem>
                 </DropdownMenuContent>
               </DropdownMenu>
             </div>
           </div>
         </div>
       </header>
     )
   }
   ```

2. **Install additional Shadcn components**
   ```bash
   npx shadcn-ui@latest add dropdown-menu
   npm install lucide-react
   ```

### Task 4: Add Session Persistence (0.5 days)

1. **Update auth store with persistence**
   ```typescript
   // src/store/authStore.ts
   import { create } from 'zustand'
   import { persist } from 'zustand/middleware'
   import { User } from '../types'

   interface AuthState {
     user: User | null
     isAuthenticated: boolean
     setUser: (user: User | null) => void
     logout: () => void
   }

   export const useAuthStore = create<AuthState>()(
     persist(
       (set) => ({
         user: null,
         isAuthenticated: false,
         setUser: (user) => set({ user, isAuthenticated: !!user }),
         logout: () => {
           set({ user: null, isAuthenticated: false })
           document.cookie = 'access_token=; Max-Age=0; path=/;'
         },
       }),
       {
         name: 'auth-storage',
         partialize: (state) => ({
           user: state.user,
           isAuthenticated: state.isAuthenticated,
         }),
       }
     )
   )
   ```

2. **Add token validation on app mount**
   ```typescript
   // src/App.tsx
   import { useEffect } from 'react'
   import { QueryClient, QueryClientProvider } from '@tanstack/react-query'
   import { BrowserRouter } from 'react-router-dom'
   import { Router } from './Router'
   import { useAuthStore } from './store/authStore'
   import { api } from './services/api'

   const queryClient = new QueryClient({
     defaultOptions: {
       queries: {
         refetchOnWindowFocus: false,
         retry: 1,
         staleTime: 5 * 60 * 1000,
       },
     },
   })

   function App() {
     const { setUser, isAuthenticated } = useAuthStore()

     useEffect(() => {
       // Validate token on mount
       if (isAuthenticated) {
         api.getCurrentUser()
           .then(setUser)
           .catch(() => {
             // Token invalid, logout
             useAuthStore.getState().logout()
           })
       }
     }, [])

     return (
       <QueryClientProvider client={queryClient}>
         <BrowserRouter>
           <Router />
         </BrowserRouter>
       </QueryClientProvider>
     )
   }

   export default App
   ```

### Task 5: Write Tests (0.5 days)

1. **Create `tests/pages/Login.test.tsx`**
   ```typescript
   import { describe, it, expect, vi } from 'vitest'
   import { render, screen, fireEvent, waitFor } from '@testing-library/react'
   import { BrowserRouter } from 'react-router-dom'
   import { QueryClient, QueryClientProvider } from '@tanstack/react-query'
   import { LoginPage } from '../../src/pages/Login'
   import { api } from '../../src/services/api'

   vi.mock('../../src/services/api')

   const queryClient = new QueryClient({
     defaultOptions: { queries: { retry: false } },
   })

   const wrapper = ({ children }: { children: React.ReactNode }) => (
     <QueryClientProvider client={queryClient}>
       <BrowserRouter>
         {children}
       </BrowserRouter>
     </QueryClientProvider>
   )

   describe('LoginPage', () => {
     it('renders login form', () => {
       render(<LoginPage />, { wrapper })

       expect(screen.getByLabelText(/email/i)).toBeInTheDocument()
       expect(screen.getByLabelText(/password/i)).toBeInTheDocument()
       expect(screen.getByRole('button', { name: /sign in/i })).toBeInTheDocument()
     })

     it('submits form with credentials', async () => {
       const mockLogin = vi.fn().mockResolvedValue({
         user: { id: '1', email: 'test@example.com', name: 'Test User', role: 'director' }
       })
       vi.mocked(api.login).mockImplementation(mockLogin)

       render(<LoginPage />, { wrapper })

       fireEvent.change(screen.getByLabelText(/email/i), {
         target: { value: 'test@example.com' },
       })
       fireEvent.change(screen.getByLabelText(/password/i), {
         target: { value: 'password' },
       })
       fireEvent.click(screen.getByRole('button', { name: /sign in/i }))

       await waitFor(() => {
         expect(mockLogin).toHaveBeenCalledWith({
           email: 'test@example.com',
           password: 'password',
         })
       })
     })

     it('shows error on failed login', async () => {
       vi.mocked(api.login).mockRejectedValue(new Error('Invalid credentials'))

       render(<LoginPage />, { wrapper })

       fireEvent.change(screen.getByLabelText(/email/i), {
         target: { value: 'wrong@example.com' },
       })
       fireEvent.change(screen.getByLabelText(/password/i), {
         target: { value: 'wrong' },
       })
       fireEvent.click(screen.getByRole('button', { name: /sign in/i }))

       await waitFor(() => {
         expect(screen.getByText(/invalid credentials/i)).toBeInTheDocument()
       })
     })

     it('toggles password visibility', () => {
       render(<LoginPage />, { wrapper })

       const passwordInput = screen.getByLabelText(/password/i)
       const toggleButton = screen.getByText(/show/i)

       expect(passwordInput).toHaveAttribute('type', 'password')

       fireEvent.click(toggleButton)
       expect(passwordInput).toHaveAttribute('type', 'text')
       expect(screen.getByText(/hide/i)).toBeInTheDocument()
     })
   })
   ```

2. **Create `tests/components/ProtectedRoute.test.tsx`**
   ```typescript
   import { describe, it, expect, vi } from 'vitest'
   import { render, screen } from '@testing-library/react'
   import { BrowserRouter, Routes, Route } from 'react-router-dom'
   import { QueryClient, QueryClientProvider } from '@tanstack/react-query'
   import { ProtectedRoute } from '../../src/components/ProtectedRoute'
   import { useAuthStore } from '../../src/store/authStore'

   const queryClient = new QueryClient()

   describe('ProtectedRoute', () => {
     it('renders children when authenticated', () => {
       useAuthStore.setState({
         isAuthenticated: true,
         user: { id: '1', email: 'test@example.com', name: 'Test', role: 'director' }
       })

       render(
         <QueryClientProvider client={queryClient}>
           <BrowserRouter>
             <ProtectedRoute>
               <div>Protected Content</div>
             </ProtectedRoute>
           </BrowserRouter>
         </QueryClientProvider>
       )

       expect(screen.getByText('Protected Content')).toBeInTheDocument()
     })

     it('redirects to login when not authenticated', () => {
       useAuthStore.setState({ isAuthenticated: false, user: null })

       render(
         <QueryClientProvider client={queryClient}>
           <BrowserRouter>
             <Routes>
               <Route path="/login" element={<div>Login Page</div>} />
               <Route
                 path="/"
                 element={
                   <ProtectedRoute>
                     <div>Protected Content</div>
                   </ProtectedRoute>
                 }
               />
             </Routes>
           </BrowserRouter>
         </QueryClientProvider>
       )

       expect(screen.getByText('Login Page')).toBeInTheDocument()
     })
   })
   ```

---

## Dev Notes

### Authentication Flow

```
1. User enters credentials → LoginPage
2. POST /api/auth/login → Backend
3. Backend validates → Returns JWT in cookie + user info
4. Frontend stores user in Zustand
5. Redirect to /projects
6. ProtectedRoute checks authentication
7. If valid → Render content
8. If invalid → Redirect to /login
```

### Token Storage

- **Primary**: HTTP-only cookie (set by backend)
- **Fallback**: Authorization header (if cookie not available)
- **User data**: Zustand store with localStorage persistence

### Session Management

- Token expires after 24 hours (configured in backend)
- Auto-logout on 401 error
- Validate token on app mount
- Persist user data across page refreshes

---

## File List

**Modified/Created:**
- `src/pages/Login.tsx` (new) - Login page component
- `src/components/ProtectedRoute.tsx` (new) - Protected route wrapper
- `src/components/Header.tsx` (new) - Navigation header with logout
- `src/store/authStore.ts` (modify) - Add persistence
- `src/Router.tsx` (modify) - Add protected routes
- `src/App.tsx` (modify) - Add token validation
- `tests/pages/Login.test.tsx` (new) - Login tests
- `tests/components/ProtectedRoute.test.tsx` (new) - Protected route tests
- `package.json` (modify) - Add zustand persistence, lucide-react

---

## Testing Strategy

### Unit Tests

```typescript
// Test coverage areas:
- ✅ Login form rendering
- ✅ Form submission with valid credentials
- ✅ Error handling on failed login
- ✅ Password visibility toggle
- ✅ Protected route access control
- ✅ Redirect behavior
- ✅ Session persistence
- ✅ Logout functionality
```

### Manual Testing

```bash
# Test login flow
1. Start dev server: npm run dev
2. Navigate to /projects (should redirect to /login)
3. Enter invalid credentials (should show error)
4. Enter valid credentials (should redirect to /projects)
5. Refresh page (should stay logged in)
6. Click logout (should redirect to /login)
7. Try to access /projects (should redirect to /login)
```

### Coverage Target

- Minimum: 80%
- Target: 90%+
- Run: `npm run test -- --coverage`

---

## Change Log

| Date | Change |
|------|--------|
| 2026-02-08 | Created story |

---

**Related Stories:** 3.2 (API Service), 3.4 (Projects List)
**Blocked By:** 3.2
**Blocks:** 3.4, 3.5, 3.6 (authenticated features)
