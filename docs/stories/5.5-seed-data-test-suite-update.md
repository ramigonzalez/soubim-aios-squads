# Story 5.5: Seed Data & Test Suite Update

**Epic:** E5 - DecisionLog V2 Backend Models & Migration
**Assigned to:** @dev
**Sprint:** Sprint 2 (Week 2)
**Status:** TODO
**Estimation:** 3 story points (1 day)
**Created:** 2026-02-16

---

## Summary

Update backend seed data to include realistic ProjectItem records across all 5 item types (idea, topic, decision, action_item, information), with proper V2 taxonomy fields including `affected_disciplines[]`, `is_milestone`, `is_done`, and structured V2 consensus/impacts. Update frontend and backend test suites to use new model names, test type filtering, and validate milestone/done toggles.

This story ensures development and testing environments have realistic multi-type data that exercises all new V2 features.

---

## Acceptance Criteria

- [ ] AC1: Seed data includes items of all 5 types (idea, topic, decision, action_item, information) across multiple sources
- [ ] AC2: At least 3 items marked as milestones in seed data (1 decision, 1 action_item, 1 information)
- [ ] AC3: All seed items use affected_disciplines[] arrays (not single discipline field)
- [ ] AC4: Decision items include structured V2 impacts and consensus JSON
- [ ] AC5: Seed data includes ProjectParticipant records for at least 2 projects
- [ ] AC6: Seed data includes Source records (meeting, email, document, manual_input types)
- [ ] AC7: All existing backend tests updated to use ProjectItem model and new field names
- [ ] AC8: All existing frontend tests updated to handle item_type and affected_disciplines[]
- [ ] AC9: New test cases cover: item type filtering, milestone toggle, is_done toggle
- [ ] AC10: `npm run frontend:test` and `npm run frontend:lint` pass
- [ ] AC11: Backend tests pass (`pytest` in decision-log-backend/)

---

## Tasks

### 1. Backend Seed Data Update (4h)

- [ ] 1.1 Create Source records in seed.py (0.5h)
  - At least 2 meeting sources with dates, titles, participants
  - At least 1 email source with sender, recipients
  - At least 1 document source
  - Enable manual_input by ensuring it's a valid source_type

- [ ] 1.2 Create ProjectParticipant records (0.5h)
  - Roster of 5-6 participants for "Residential Tower Alpha"
  - Mix of disciplines: architecture, structural, mep, client, contractor
  - Include names, emails, primary_discipline, secondary_disciplines[]

- [ ] 1.3 Create ProjectItem seed data (2h)
  - 20+ items across all 5 types:
    - 4-5 ideas (early brainstorming, no consensus)
    - 3-4 topics (discussion points, multi-discipline)
    - 5-6 decisions (with consensus, impacts, milestones)
    - 4-5 action_items (some with owner/due_date, some is_done)
    - 2-3 information (reference docs, milestone announcements)
  - Mark 3 items as milestones (is_milestone=True)
  - Mark 2-3 action items as done (is_done=True)
  - Use affected_disciplines[] arrays (1-3 disciplines per item)
  - Decision items: include V2 consensus and impacts JSON

- [ ] 1.4 Create StageSchedule seed data for E6 (0.5h)
  - 3-4 stage records for project 1
  - Include stage names, start/end dates, milestone references

- [ ] 1.5 Verify seed.py runs without errors (0.5h)
  - Test: `python3 decision-log-backend/app/database/seed.py`
  - Confirm all foreign key relationships resolve
  - Confirm JSON fields parse correctly

### 2. Backend Test Suite Update (2h)

- [ ] 2.1 Update existing model tests (0.5h)
  - Replace Decision model refs with ProjectItem
  - Update field names: discipline → affected_disciplines, etc.
  - Test consensus/impacts JSON validation

- [ ] 2.2 Update existing API route tests (1h)
  - Update GET /api/items response assertions
  - Update POST /api/items request bodies to V2 schema
  - Test query params: item_type, is_milestone, is_done

- [ ] 2.3 Add new test cases (0.5h)
  - Test item type filtering: `GET /api/items?item_type=decision`
  - Test milestone filtering: `GET /api/items?is_milestone=true`
  - Test PATCH /api/items/{id} for is_done toggle
  - Test multi-discipline queries

### 3. Frontend Test Suite Update (2h)

- [ ] 3.1 Update component tests using item data (1h)
  - Update DecisionCard test to use item_type prop
  - Update Timeline test to expect affected_disciplines[]
  - Update FiltersSidebar test to include item type filters
  - Mock API responses with V2 schema

- [ ] 3.2 Add new test cases for V2 features (0.5h)
  - Test milestone indicator rendering (MilestoneIcon)
  - Test done checkbox toggle for action_items
  - Test multi-discipline badge rendering

- [ ] 3.3 Run test suite and fix failures (0.5h)
  - `npm run frontend:test` (all tests pass)
  - `npm run frontend:lint` (no errors)
  - Fix type errors from schema changes

---

## Dev Notes

### Example Seed Data Structures

#### Source Record (Meeting)
```python
Source(
    id=1,
    project_id=1,
    source_type="meeting",
    title="Foundation Review Meeting",
    date=datetime(2026, 2, 10, 14, 0),
    participants=["alice@arch.com", "bob@struct.com", "carol@mep.com"],
    metadata={"location": "Conference Room A", "duration_minutes": 90}
)
```

#### ProjectParticipant Record
```python
ProjectParticipant(
    id=1,
    project_id=1,
    name="Alice Chen",
    email="alice@arch.com",
    primary_discipline="architecture",
    secondary_disciplines=["sustainability"],
    role="Lead Architect"
)
```

#### ProjectItem Record (Decision with Milestone)
```python
ProjectItem(
    id=1,
    project_id=1,
    item_type="decision",
    source_type="meeting",
    source_id=1,
    statement="Foundation design will use mat slab instead of pile foundation",
    context="Soil analysis shows stable bearing capacity at 8ft depth",
    affected_disciplines=["structural", "civil", "architecture"],
    is_milestone=True,
    is_done=False,
    created_date=datetime(2026, 2, 10, 14, 30),
    consensus={
        "structural": {"status": "AGREE", "notes": "Reduces cost by $50k"},
        "civil": {"status": "AGREE", "notes": "Soil report supports this"},
        "architecture": {"status": "CONDITIONAL", "notes": "Must verify basement waterproofing"}
    },
    impacts={
        "cost_impact": "-$50,000",
        "timeline_impact": "-1 week",
        "risk_level": "low",
        "affected_areas": ["foundation", "basement"]
    },
    owner=None,
    due_date=None
)
```

#### ProjectItem Record (Action Item with Owner)
```python
ProjectItem(
    id=5,
    project_id=1,
    item_type="action_item",
    source_type="meeting",
    source_id=1,
    statement="Submit foundation drawings to building department",
    context="Required for permit approval",
    affected_disciplines=["structural"],
    is_milestone=False,
    is_done=False,
    created_date=datetime(2026, 2, 10, 15, 0),
    consensus=None,
    impacts=None,
    owner="bob@struct.com",
    due_date=datetime(2026, 2, 20)
)
```

#### ProjectItem Record (Information Milestone)
```python
ProjectItem(
    id=10,
    project_id=1,
    item_type="information",
    source_type="email",
    source_id=2,
    statement="Building permit approved by city",
    context="Permit #2026-RES-00123, valid for 18 months",
    affected_disciplines=["architecture", "contractor"],
    is_milestone=True,
    is_done=False,
    created_date=datetime(2026, 2, 12, 9, 0),
    consensus=None,
    impacts=None,
    owner=None,
    due_date=None
)
```

### V2 Consensus Format Rules
- Only decision items have consensus
- Keys are discipline names from the 15-discipline enum
- Each discipline has: `{"status": "AGREE" | "DISAGREE" | "CONDITIONAL", "notes": string | null}`
- Not all disciplines need entries (only affected ones)

### V2 Impacts Format Rules
- Only decision items have impacts
- Required fields: `cost_impact`, `timeline_impact`, `risk_level`, `affected_areas`
- `cost_impact`: string like "+$5000" or "-$10,000" or "No change"
- `timeline_impact`: string like "+2 weeks" or "-3 days" or "No impact"
- `risk_level`: "low" | "medium" | "high"
- `affected_areas`: array of strings (e.g., ["foundation", "structure"])

### Test Data Distribution
- **Project 1 (Residential Tower Alpha):** 20 items, 4 sources, 6 participants
- **Project 2 (optional):** 5 items, 1 source, 2 participants (for cross-project tests)

### Milestone Items (at least 3)
1. Decision: Foundation design choice (structural milestone)
2. Action Item: Permit submission deadline (regulatory milestone)
3. Information: Permit approval announcement (project milestone)

---

## File List

### New Files
- None

### Modified Files
- `decision-log-backend/app/database/seed.py` — Add V2 seed data
- `decision-log-backend/app/tests/test_models.py` — Update to ProjectItem model
- `decision-log-backend/app/tests/test_routes.py` — Update to V2 API schema
- `decision-log-frontend/src/tests/components/DecisionCard.test.tsx` — Update to item_type prop
- `decision-log-frontend/src/tests/components/Timeline.test.tsx` — Update to affected_disciplines
- `decision-log-frontend/src/tests/components/FiltersSidebar.test.tsx` — Add item type filter tests

---

## Testing Strategy

### Backend Tests
```bash
cd decision-log-backend
pytest app/tests/ -v
```
- Verify all model tests use ProjectItem
- Verify API tests handle V2 query params (item_type, is_milestone, is_done)
- Verify seed data loads without FK errors

### Frontend Tests
```bash
cd decision-log-frontend
npm run frontend:test
npm run frontend:lint
```
- All component tests pass with V2 props
- New tests cover milestone/done toggles
- Type errors resolved for affected_disciplines[]

### Manual Testing
1. Run seed script: `python3 decision-log-backend/app/database/seed.py`
2. Start backend: `npm run backend:dev`
3. Query API: `curl http://localhost:8000/api/items?item_type=decision`
4. Verify 5-6 decision items returned
5. Query milestones: `curl http://localhost:8000/api/items?is_milestone=true`
6. Verify 3 milestone items returned

---

## Change Log

| Date       | Author | Changes                          |
|------------|--------|----------------------------------|
| 2026-02-16 | @dev   | Story created                    |

---

## Related Stories

**Blocked By:**
- 5.1 DB Migration — ProjectItem, Source, ProjectParticipant tables must exist
- 5.2 API Routes — V2 endpoints and models must be implemented

**Blocks:**
- 6.2 Add/Edit Item Form — Form needs seed data to test against
- 8.1 Milestone Timeline — Timeline needs milestone seed data to render

**Related:**
- 5.3 Item Type Enum — Uses 5 item types defined in enum
- 5.4 V2 Consensus & Impacts — Uses V2 consensus/impacts formats
- 7.1 Type Filter Component — Filter needs seed data with all 5 types

---

**End of Story 5.5**
