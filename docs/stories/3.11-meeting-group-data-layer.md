# Story 3.11: Meeting Group Data Layer

**Story ID:** 3.11
**Assigned to:** @dev + @data-engineer
**Sprint:** Sprint 5 (Timeline Redesign)
**Status:** Ready for Review
**Estimation:** 3 story points (1 day)
**Design Spec:** `docs/ux/FRONTEND-SPEC-3-layer-timeline.md`
**Handoff:** `docs/handoffs/UMA-to-DEV-3-layer-timeline.md`

---

## Summary

Extend the decisions API and frontend types to support the 3-layer timeline hierarchy (Date > Meetings > Decisions). The backend already stores `meeting_type` and `participants` on the `Transcript` model but does not include them in the decisions API response. The frontend `Decision` type is missing `transcript_id` and `meeting_participants`. This story closes those data gaps so Story 3.12 can build the 3-layer UI.

---

## Data Gap Analysis

| Field Needed | Backend Model | API Response | Frontend Type | Gap |
|---|---|---|---|---|
| `transcript_id` | YES (`Decision.transcript_id`) | YES (line 81 in `decisions.py`) | **NO** (missing from `decision.ts`) | Frontend type only |
| `meeting_type` | YES (`Transcript.meeting_type`) | **NO** (not in JOIN) | YES (`decision.ts` line 8) | API needs to add to JOIN |
| `meeting_title` | YES | YES | YES | None |
| `meeting_date` | YES | YES | YES | None |
| `meeting_participants` | YES (`Transcript.participants` JSON) | **NO** (not in JOIN) | NO | API + Frontend type |

---

## Acceptance Criteria

### Backend API Changes

- [x] `list_decisions` endpoint: Add `Transcript.meeting_type` to the LEFT JOIN query and include `meeting_type` in each decision's response object
- [x] `list_decisions` endpoint: Add `Transcript.participants` to the LEFT JOIN query and include as `meeting_participants` in each decision's response object
- [x] `get_decision` endpoint: Same changes — add `meeting_type` and `meeting_participants` to the single-decision response
- [x] `meeting_type` returns the string from `Transcript.meeting_type` (e.g., "Design Review", "Coordination", "Client Meeting") or `null` if no transcript linked
- [x] `meeting_participants` returns the JSON array from `Transcript.participants` (e.g., `[{"name": "Carlos", "role": "Structural Engineer"}]`) or `null` if no transcript linked

### Frontend Type Changes

- [x] Add `transcript_id?: string` to the `Decision` interface in `decision-log-frontend/src/types/decision.ts`
- [x] Add `meeting_participants?: Array<{ name: string; role: string }>` to the `Decision` interface
- [x] Verify `meeting_type?: string` already in type — confirm API now populates it

### Seed Data Expansion

- [x] Add at least one meeting (transcript) with 6+ decisions to test the collapse threshold (>5 collapsed by default)
- [x] Ensure participant arrays have diverse discipline roles across meetings (e.g., Structural Engineer, MEP Engineer, Plumbing Engineer, Project Director, Architect, Landscape Architect)
- [x] Add at least one meeting with 5+ different discipline roles among participants to test overflow pill behavior ("+N more")

### Mock Data Updates

- [x] Add `transcript_id` to mock decisions in `decision-log-frontend/src/lib/mockData.ts`
- [x] Add `meeting_participants` arrays to mock decisions
- [x] Group some mock decisions under the same `transcript_id` to simulate meeting grouping
- [x] Include `meeting_type` values in mock data

### API Verification

- [x] API test: `GET /api/projects/{id}/decisions` returns `meeting_type`, `transcript_id`, and `meeting_participants` for each decision
- [x] API test: Fields are `null` when no transcript is linked (orphan decisions)
- [x] API test: `meeting_participants` structure matches `Array<{name: string, role: string}>`

---

## Tasks

### Task 1: Update Backend API (0.5 days)

**File:** `decision-log-backend/app/api/routes/decisions.py`

1. **Update `list_decisions` query** (line 35):
   - Add `Transcript.meeting_type` and `Transcript.participants` to the `db.query()` call
   - Update tuple unpacking in the loop (line 95) to capture the 2 new fields
   - Add `"meeting_type"` and `"meeting_participants"` to the response dict (lines 77-96)

2. **Update `get_decision` query** (line 121):
   - Same changes as above for the single-decision endpoint

3. **Update `meeting_type` filter** (currently not implemented):
   - The `meeting_type` query parameter exists in the function signature (line 18) but is never used in filtering
   - Add: `if meeting_type: query = query.filter(Transcript.meeting_type == meeting_type)`

### Task 2: Update Frontend Types (0.25 days)

**File:** `decision-log-frontend/src/types/decision.ts`

1. Add `transcript_id?: string` to the `Decision` interface
2. Add `meeting_participants?: Array<{ name: string; role: string }>` to the `Decision` interface

### Task 3: Expand Seed Data (0.25 days)

**File:** `decision-log-backend/app/database/seed.py`

1. Add 4-5 more decisions to an existing transcript (e.g., `t1` Structural Design Review) to create a 6+ decision meeting
2. Add more participants with diverse roles to existing transcripts
3. Add at least one transcript with 5+ participant disciplines

### Task 4: Update Mock Data (optional, for frontend dev)

**File:** `decision-log-frontend/src/lib/mockData.ts`

1. Add `transcript_id` values (use consistent UUIDs to group decisions under meetings)
2. Add `meeting_participants` arrays
3. Add `meeting_type` values

---

## Dev Notes

### Current API Response Shape (before changes)

```json
{
  "id": "uuid",
  "project_id": "uuid",
  "transcript_id": "uuid",
  "decision_statement": "...",
  "who": "...",
  "timestamp": "00:05:32",
  "discipline": "structural",
  "why": "...",
  "meeting_title": "Structural Design Review",
  "meeting_date": "2026-02-06",
  "created_at": "2026-02-06T09:05:32"
}
```

### Target API Response Shape (after changes)

```json
{
  "id": "uuid",
  "project_id": "uuid",
  "transcript_id": "uuid",
  "decision_statement": "...",
  "who": "...",
  "timestamp": "00:05:32",
  "discipline": "structural",
  "why": "...",
  "meeting_title": "Structural Design Review",
  "meeting_type": "Design Review",
  "meeting_date": "2026-02-06",
  "meeting_participants": [
    { "name": "Carlos", "role": "Structural Engineer" },
    { "name": "Gabriela", "role": "Project Director" }
  ],
  "created_at": "2026-02-06T09:05:32"
}
```

### Database Model Reference

The `Transcript` model already has these fields (verified in `models.py`):

```python
class Transcript(Base):
    meeting_type = Column(String(50))           # e.g., "Design Review"
    participants = Column(JSONType, nullable=False)  # JSON array of {name, role}
```

The seed data already populates these fields on all 6 transcripts with values like:
- `meeting_type`: "Design Review", "Coordination", "Client Meeting"
- `participants`: `[{"name": "Carlos", "role": "Structural Engineer"}, {"name": "Gabriela", "role": "Project Director"}]`

### Minimal Code Change

The backend change is small — adding 2 columns to the existing LEFT JOIN and 2 keys to the response dict. Estimated at ~20 lines of code changes.

---

## File List

**Modified Files:**
- `decision-log-backend/app/api/routes/decisions.py` — Add `meeting_type`, `participants` to JOIN and response
- `decision-log-frontend/src/types/decision.ts` — Add `transcript_id`, `meeting_participants` to interface
- `decision-log-backend/app/database/seed.py` — Expand with more decisions and diverse participants
- `decision-log-frontend/src/lib/mockData.ts` — Add new fields to mock data

---

## Testing Strategy

### Backend Tests

```
- API returns meeting_type for decisions linked to transcripts
- API returns meeting_participants for decisions linked to transcripts
- API returns null for meeting_type and meeting_participants when no transcript
- meeting_type filter parameter works correctly
- meeting_participants structure matches expected schema
```

### Type Verification

```bash
# Verify TypeScript compiles with new fields
cd decision-log-frontend && npx tsc --noEmit
```

---

**Related Stories:** 3.5 (Timeline v2), 3.12 (3-Layer Timeline — blocked by this story)
**Blocks:** 3.12 (3-Layer Meeting Group Timeline)
**Dependencies:** None (backend models already have the data)

---

## Change Log

| Date | Change |
|------|--------|
| 2026-02-09 | Created story based on data gap analysis for 3-layer timeline |
