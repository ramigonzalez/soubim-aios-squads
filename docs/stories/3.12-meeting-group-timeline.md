# Story 3.12: 3-Layer Meeting Group Timeline

**Story ID:** 3.12
**Assigned to:** @dev
**Sprint:** Sprint 5 (Timeline Redesign)
**Status:** Ready for Review
**Estimation:** 8 story points (3-4 days)
**Design Spec:** `docs/ux/FRONTEND-SPEC-3-layer-timeline.md`
**Handoff:** `docs/handoffs/UMA-to-DEV-3-layer-timeline.md`
**Blocked by:** Story 3.11 (Meeting Group Data Layer)
**Client Feedback:** Gabriela requested meeting-level grouping — "I need to see which meeting each decision came from"

---

## Summary

Transform the 2-layer timeline (Date > Decisions) into a 3-layer hierarchy (Date > Meetings > Decisions) by introducing a `MeetingGroup` component that groups decisions by their source transcript. Each meeting shows its title, type (color-coded badge), participating disciplines, participant count with tooltip, and a collapsible list of decisions. This mirrors how construction projects naturally organize work: days contain meetings, meetings contain decisions.

---

## UX Research Context

### Gabriela's Feedback (Feb 9, 2026)

> "When I look at Feb 7, I had a Client Alignment call in the morning and a Landscape Review in the afternoon — those are totally different contexts. Show me the meetings, then the decisions inside them."

### Key Design Decisions

- **Multi-discipline at meeting level:** Show ALL participating disciplines (from `meeting_participants[].role`), not just decision-makers
- **Multi-discipline at decision level:** Primary discipline (existing) + affected disciplines (from `consensus` keys)
- **Participant awareness:** `Users` icon + count with hover tooltip showing names/roles
- **Meeting type recognition:** Color-coded badges for instant type identification
- **Progressive collapse:** <=5 decisions expanded, >5 collapsed by default

### Component Architecture (Atomic Design)

```
Timeline (Organism)
├── For each date/discipline group:
│   ├── Group Header (date or discipline, with node)
│   └── For each meeting:
│       └── MeetingGroup (Molecule)
│           ├── Header Row 1: title + MeetingTypeBadge (Atom)
│           ├── Header Row 2: discipline badges + ParticipantIndicator (Atom) + count + chevron
│           └── Decision List (collapsible):
│               └── DecisionRow (Molecule) [repeating]
│                   ├── Row 1: statement + primary discipline + affected disciplines
│                   └── Row 2: who + timestamp
```

---

## Acceptance Criteria

### New Components

- [x] **`MeetingTypeBadge` atom** (`src/components/atoms/MeetingTypeBadge.tsx`):
  - Color-coded pill badge for meeting type
  - Client Meeting: `bg-rose-50 text-rose-700`
  - Coordination: `bg-teal-50 text-teal-700`
  - Design Review: `bg-amber-50 text-amber-700`
  - Internal: `bg-blue-50 text-blue-700`
  - Unknown/Other: `bg-gray-50 text-gray-600`
  - Style: `text-xs font-medium px-2 py-0.5 rounded-full`

- [x] **`ParticipantIndicator` atom** (`src/components/atoms/ParticipantIndicator.tsx`):
  - `Users` icon from lucide-react + participant count
  - Shadcn/ui `Tooltip` on hover showing participant names and roles
  - Tooltip content: "Participants" header + list of `{name} — {role}`
  - Tooltip accessible via keyboard focus (not hover-only)
  - Long lists: `max-h-48 overflow-y-auto`

- [x] **`MeetingGroup` molecule** (`src/components/molecules/MeetingGroup.tsx`):
  - Collapsible card: `bg-white border border-gray-200 rounded-lg shadow-sm`
  - Header row 1: meeting title + `MeetingTypeBadge`
  - Header row 2: discipline badges (from `meeting_participants[].role`) + `ParticipantIndicator` + decision count + chevron icon
  - Discipline badge overflow: show first 3 + "+N more" pill if >4 disciplines
  - Click header toggles collapse/expand with chevron rotation
  - <=5 decisions expanded by default, >5 collapsed

### Modified Components

- [x] **`DecisionRow` molecule** (`src/components/molecules/DecisionRow.tsx`):
  - Add `showMeetingTitle?: boolean` prop (default `true`; set to `false` when inside `MeetingGroup`)
  - Add `showAffectedDisciplines?: boolean` prop
  - When `showAffectedDisciplines=true`: derive affected disciplines from `decision.consensus` keys (filter to known disciplines, exclude primary)
  - Affected discipline badges: `text-xs px-1 py-0 rounded bg-gray-100 text-gray-500` (smaller, muted vs. primary badge)

- [x] **`Timeline` organism** (`src/components/organisms/Timeline.tsx`):
  - Add 3-layer grouping logic: `groupByDateWithMeetings()` and `groupByDisciplineWithMeetings()`
  - Sub-group decisions within each date/discipline by `transcript_id`
  - Render `MeetingGroup` components for each meeting within a group
  - Pass `showDate` to `MeetingGroup` in discipline grouping mode

- [x] **Updated `TimelineSkeleton`**:
  - Reflect 3-layer structure: date header > meeting card skeletons > decision row skeletons
  - 2 date groups x 2 meeting cards x 2 decision rows each
  - Uses `animate-pulse`

### Multi-Discipline Display

- [x] **Meeting level:** Show discipline badges for ALL participants (from `meeting_participants[].role` mapped to discipline names), not just decision-makers
- [x] **Meeting level:** If >4 discipline badges, show first 3 + "+N more" overflow pill (`bg-gray-100 text-gray-500 text-xs px-1.5 py-0.5 rounded`)
- [x] **Decision level:** Primary discipline badge (existing `discipline` field, prominent) + smaller affected discipline badges (derived from `consensus` keys)
- [x] **Role-to-discipline mapping:** Map participant roles to discipline names (e.g., "MEP Engineer" -> "mep", "Project Director" -> "architecture")

### Interaction

- [x] Meetings with <=5 decisions expanded by default, >5 collapsed
- [x] Click meeting header toggles collapse/expand with chevron rotation (180deg)
- [x] Hover meeting header: `bg-gray-100/50`
- [x] Hover participant icon shows tooltip with participant list
- [x] Click decision row still opens DrilldownModal (unchanged behavior)
- [x] Keyboard navigation: Tab through meeting headers and decisions (when expanded), Enter/Space to toggle/open

### Edge Cases

- [x] **Orphan decisions** (no `transcript_id`): shown as "Other Decisions" group with muted italic title, no meeting type badge, no participant indicator
- [x] **Single-decision meetings:** Display identically to multi-decision meetings (header + 1 row), always expanded
- [x] **Cross-discipline meetings in discipline mode:** Same meeting appears under each relevant discipline group, showing only that discipline's decisions, but meeting header shows all participants
- [x] **Long participant lists** (>6): Tooltip scrolls with `max-h-48 overflow-y-auto`
- [x] **Missing meeting type:** No `MeetingTypeBadge` rendered (graceful absence)
- [x] **Filtered-out meetings:** When filters remove all decisions from a meeting, hide the entire meeting group

### Accessibility (WCAG 2.1 AA)

- [x] Meeting group: `role="region"` with `aria-label="{meeting_title}, {N} decisions"`
- [x] Accordion: Header has `aria-expanded="true/false"`, `aria-controls="meeting-{id}-decisions"`
- [x] Decision list: `role="list"` on container, `role="listitem"` on each row
- [x] Keyboard: Tab header -> decisions (if expanded) -> next header. Enter/Space toggles.
- [x] ParticipantIndicator tooltip accessible via focus
- [x] Screen reader: Announces "Meeting: {title}, {type}, {N} participants, {M} decisions, expanded/collapsed"

### Should Have (Deferred)

- [ ] Meeting type filter in FilterBar (filter by Client Meeting / Coordination / Design Review)
- [ ] Filter meetings by participating discipline (beyond existing decision-level discipline filter)

---

## Tasks

### Task 1: Create MeetingTypeBadge Atom (0.25 days)

**File:** `src/components/atoms/MeetingTypeBadge.tsx`

1. Create component with `type: string` prop
2. Map meeting types to Tailwind color classes
3. Handle unknown types with gray fallback
4. Handle null/undefined gracefully (render nothing)

### Task 2: Create ParticipantIndicator Atom (0.25 days)

**File:** `src/components/atoms/ParticipantIndicator.tsx`

1. Create component with `participants: Array<{name: string, role: string}>` prop
2. Render `Users` icon + count
3. Add Shadcn/ui `Tooltip` with participant list
4. Install Tooltip if needed: `npx shadcn-ui@latest add tooltip`
5. Handle empty array (render nothing)

### Task 3: Create MeetingGroup Molecule (1 day)

**File:** `src/components/molecules/MeetingGroup.tsx`

1. Create collapsible card component
2. Header with title, MeetingTypeBadge, discipline badges, ParticipantIndicator, count, chevron
3. Implement role-to-discipline mapping for participant badges
4. Implement overflow logic (>4 disciplines -> "+N more" pill)
5. Accordion behavior with state management
6. Render `DecisionRow` list in collapsible body
7. Pass `showMeetingTitle={false}` and `showAffectedDisciplines={true}` to each DecisionRow

### Task 4: Update DecisionRow (0.5 days)

**File:** `src/components/molecules/DecisionRow.tsx`

1. Add `showMeetingTitle` prop (conditionally render meeting title)
2. Add `showAffectedDisciplines` prop
3. Implement `getAffectedDisciplines(decision)` — extract from consensus keys
4. Render secondary discipline badges (smaller, muted style)

### Task 5: Update Timeline Grouping Logic (1 day)

**File:** `src/components/organisms/Timeline.tsx`

1. Add `groupByDateWithMeetings()` function:
   - Group by date (existing), then sub-group by `transcript_id`
   - Create `MeetingGroupData` for each meeting
   - Handle orphan decisions (no `transcript_id`) as "Other Decisions"
2. Add `groupByDisciplineWithMeetings()` function:
   - Group by discipline (existing), then sub-group by `transcript_id`
   - Handle cross-discipline meetings (duplicate meeting under each discipline)
3. Render `MeetingGroup` components within each date/discipline group
4. Pass `showDate` to MeetingGroup in discipline mode

### Task 6: Update TimelineSkeleton (0.25 days)

**File:** `src/components/organisms/Timeline.tsx` (or separate file)

1. Update skeleton to show 3-layer structure
2. Date header skeleton + meeting card skeletons + decision row skeletons

### Task 7: Edge Cases (0.5 days)

1. Orphan decision handling with "Other Decisions" group
2. Cross-discipline meeting duplication in discipline mode
3. Empty meeting groups (filtered out)
4. Missing meeting_type graceful handling

### Task 8: Write Tests (1 day)

1. **`tests/components/MeetingTypeBadge.test.tsx`**
   - Renders correct color for each meeting type
   - Handles unknown types with gray fallback
   - Handles null/undefined

2. **`tests/components/ParticipantIndicator.test.tsx`**
   - Renders icon + count
   - Tooltip shows participant names and roles
   - Handles empty array

3. **`tests/components/MeetingGroup.test.tsx`**
   - Renders meeting header with title, type badge, disciplines, participants, count
   - Accordion: <=5 expanded, >5 collapsed
   - Click header toggles
   - Discipline overflow shows "+N more"
   - Keyboard interaction (Enter/Space)

4. **Update `tests/components/Timeline.test.tsx`**
   - 3-layer grouping by date with meetings
   - 3-layer grouping by discipline with meetings
   - Orphan decisions in "Other Decisions" group
   - Cross-discipline meetings in discipline mode

5. **Update `tests/components/DecisionRow.test.tsx`**
   - `showMeetingTitle=false` hides meeting title
   - `showAffectedDisciplines=true` shows secondary badges
   - Affected disciplines derived from consensus keys

---

## Dev Notes

### Grouping Data Structures

```typescript
interface MeetingGroupData {
  meetingTitle: string
  meetingType?: string
  meetingDate?: string
  transcriptId?: string
  participants: Array<{ name: string; role: string }>
  decisions: Decision[]
}

interface DateGroupData {
  date: string
  meetings: MeetingGroupData[]
  totalDecisions: number
}

interface DisciplineGroupData {
  discipline: string
  meetings: MeetingGroupData[]
  totalDecisions: number
}
```

### Role-to-Discipline Mapping

```typescript
const ROLE_DISCIPLINE_MAP: Record<string, string> = {
  'structural engineer': 'structural',
  'mep engineer': 'mep',
  'project director': 'architecture',
  'architect': 'architecture',
  'plumbing engineer': 'plumbing',
  'electrical engineer': 'electrical',
  'landscape architect': 'landscape',
  'sustainability engineer': 'landscape',
}
```

### Shadcn/ui Components Needed

```bash
npx shadcn-ui@latest add tooltip      # For ParticipantIndicator
npx shadcn-ui@latest add collapsible   # For MeetingGroup (optional — can use manual state)
```

### Performance Considerations

- MeetingGroup uses local state for expand/collapse (no global store)
- Collapsed meetings don't render decision rows (conditional rendering, not CSS hide)
- Grouping functions are memoized with `useMemo` on decisions array

---

## File List

**New Files:**
- `src/components/atoms/MeetingTypeBadge.tsx` — Meeting type color badge
- `src/components/atoms/ParticipantIndicator.tsx` — Participant count + tooltip
- `src/components/molecules/MeetingGroup.tsx` — Collapsible meeting card with role-to-discipline mapping
- `src/tests/components/MeetingTypeBadge.test.tsx` — MeetingTypeBadge tests (7 tests)
- `src/tests/components/ParticipantIndicator.test.tsx` — ParticipantIndicator tests (5 tests)
- `src/tests/components/MeetingGroup.test.tsx` — MeetingGroup tests (14 tests)

**Modified Files:**
- `src/components/molecules/DecisionRow.tsx` — Add `showMeetingTitle`, `showAffectedDisciplines` props, `getAffectedDisciplines()` helper
- `src/components/organisms/Timeline.tsx` — 3-layer grouping logic (`groupByDateWithMeetings`, `groupByDisciplineWithMeetings`, `buildMeetingGroups`) + MeetingGroup rendering + updated TimelineSkeleton

---

## Testing Strategy

### Unit Tests

```
- MeetingTypeBadge: correct colors for each type, unknown fallback, null handling
- ParticipantIndicator: icon + count, tooltip content, empty array
- MeetingGroup: header rendering, accordion behavior, discipline overflow, keyboard
- DecisionRow: showMeetingTitle, showAffectedDisciplines, secondary badges
- Timeline: 3-layer grouping by date, 3-layer grouping by discipline
- Timeline: orphan decisions, cross-discipline meetings, filtered-out meetings
```

### Integration Tests

```
- Full flow: Fetch decisions -> 3-layer timeline -> Click meeting header (toggle) -> Click decision row -> DrilldownModal
- Grouping mode switch: Date (3-layer) <-> Discipline (3-layer)
```

### Accessibility Tests

```
- Keyboard: Tab through meeting headers and decisions
- Screen reader: Meeting header announcements
- Accordion: aria-expanded state
- Tooltip: focus-accessible
```

### Coverage Target

- Minimum: 80%
- Target: 90%+
- Run: `npm run test -- --coverage`

---

**Related Stories:** 3.5 (Timeline v2), 3.6 (FilterBar), 3.7 (DrilldownModal), 3.11 (Data Layer — blocks this)
**Blocked By:** 3.11 (Meeting Group Data Layer)
**Extends:** 3.5 (Decision Timeline v2 functionality)

---

## Change Log

| Date | Change |
|------|--------|
| 2026-02-09 | Created story for 3-layer meeting group timeline based on Gabriela's feedback |
