# Story 1.3: Backend Project Endpoints

**Story ID:** 1.3
**Assigned to:** @dev
**Sprint:** Sprint 1 (Week 1)
**Status:** Draft
**Estimation:** 5 story points (1.5 days)

---

## Summary

Implement project management endpoints: list all projects, get project details with statistics. Support pagination and user authorization filtering.

---

## Acceptance Criteria

- [ ] `GET /api/projects` - List projects
  - [ ] Returns paginated list of projects accessible to current user
  - [ ] Pagination working (limit, offset)
  - [ ] Total count returned
  - [ ] Sorts by created_at DESC
  - [ ] Filters by archived status
  - [ ] 401 error if not authenticated
- [ ] `GET /api/projects/{project_id}` - Project detail
  - [ ] Returns full project info with statistics
  - [ ] Stats include:
    - [ ] total_decisions
    - [ ] decisions_last_week
    - [ ] decisions_by_discipline
    - [ ] decisions_by_meeting_type
  - [ ] Members list with roles
  - [ ] 401 if not authenticated
  - [ ] 404 if project not found
  - [ ] 403 if user doesn't have access
- [ ] RBAC working
  - [ ] director role → all projects
  - [ ] architect role → assigned projects only
  - [ ] client role → own projects only (Phase 2)
- [ ] Tests passing: `pytest tests/unit/test_projects.py` (80%+ coverage)
- [ ] Postman collection working

---

## Tasks

### Task 1: Create Project Service (1 day)
- [ ] Create `app/services/project_service.py`
  - [ ] `get_projects(user_id, limit, offset)` - List projects
    - [ ] Query projects accessible to user (based on role)
    - [ ] Apply pagination
    - [ ] Return (projects, total_count)
  - [ ] `get_project(project_id, user_id)` - Get single project
    - [ ] Verify user has access
    - [ ] Load project + members + stats
    - [ ] Calculate stats from decisions table
- [ ] Handle authorization
  - [ ] director → all projects
  - [ ] architect → only in project_members
  - [ ] client → only in project_members with own projects
- [ ] Test service functions independently

### Task 2: Implement List Projects Endpoint
- [ ] Update `app/api/routes/projects.py` GET /
  - [ ] Extract user from request middleware
  - [ ] Call project_service.get_projects()
  - [ ] Support query params: limit=50, offset=0, archived=false
  - [ ] Return ProjectsResponse (projects[], total, limit, offset)
  - [ ] Test with Postman
    - [ ] Valid user → list of projects
    - [ ] Pagination working
    - [ ] No unauthorized projects visible

### Task 3: Implement Project Detail Endpoint
- [ ] Update `app/api/routes/projects.py` GET /{project_id}
  - [ ] Extract user from request middleware
  - [ ] Verify user has access (403 if not)
  - [ ] Call project_service.get_project()
  - [ ] Calculate statistics:
    - [ ] COUNT(decisions) for each discipline
    - [ ] COUNT(decisions) for each meeting_type
    - [ ] COUNT(decisions) WHERE created_at >= 7 days ago
  - [ ] Return ProjectDetailResponse
  - [ ] Test with Postman
    - [ ] Valid project → 200 + stats
    - [ ] Invalid project → 404
    - [ ] Unauthorized → 403

### Task 4: Implement RBAC
- [ ] Add authorization checks
  - [ ] Director: all projects
  - [ ] Architect: projects where user in project_members
  - [ ] Client: projects where user is owner
- [ ] Add error responses
  - [ ] 403 Forbidden for unauthorized access
  - [ ] Error message: "permission_denied"
- [ ] Test RBAC
  - [ ] Create users with different roles
  - [ ] Verify each role sees correct projects

### Task 5: Write Tests
- [ ] Create `tests/unit/test_projects.py`
  - [ ] Test get_projects with different roles
  - [ ] Test pagination
  - [ ] Test get_project detail
  - [ ] Test 403 errors
  - [ ] Test 404 errors
  - [ ] Test statistics calculation
- [ ] Create `tests/integration/test_projects_api.py`
  - [ ] Test full endpoint flow with auth
  - [ ] Test authorization checks
  - [ ] Test pagination
  - [ ] Min 80% coverage

---

## Dev Notes

**Database Required:**
- Story 1.1 (schema) + Story 1.2 (auth) must be complete
- Need test data: projects, project_members with different roles

**Seed Data Needed:**
- Director user + 3 projects
- Architect user + 2 accessible projects
- Test decisions for stats

**Statistics Calculation:**
- GROUP BY discipline, COUNT(*) → decisions_by_discipline
- GROUP BY meeting_type, COUNT(*) → decisions_by_meeting_type
- WHERE created_at >= NOW() - INTERVAL 7 days → decisions_last_week

**Authorization Strategy:**
```python
# Director sees everything
if user.role == 'director':
    return all_projects

# Architect sees assigned projects
elif user.role == 'architect':
    return projects where user_id in project_members

# Client sees own projects
elif user.role == 'client':
    return projects where user_id = owner
```

---

## File List

**Modified/Created:**
- `app/services/project_service.py` (new) - Project business logic
- `app/api/routes/projects.py` (modify) - Implement endpoints
- `tests/unit/test_projects.py` (new) - Unit tests
- `tests/integration/test_projects_api.py` (new) - Integration tests
- `app/database/seed.py` (modify) - Add more test data

---

## Completion Notes

_Fill in after completing the story_

- **Date Completed:**
- **Actual Points:**
- **Issues Encountered:**
- **Lessons Learned:**

---

## Change Log

| Date | Change |
|------|--------|
| 2026-02-07 | Created story |

---

**Related Stories:** 1.1 (Database), 1.2 (Auth), 1.5 (Frontend Projects)
**Blocked By:** 1.1, 1.2
**Blocks:** 1.5 (frontend projects page)
