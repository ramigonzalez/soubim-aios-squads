# Story 9.4: Meeting Summary & Advanced Filters

**Story ID:** 9.4
**Epic:** E9 — Project History Enhancement
**Assigned to:** @dev
**Sprint:** Sprint 5 (Week 8)
**Status:** Ready for Review
**Estimation:** 8 story points (3-4 days)
**Review:** @ux-design-expert (Uma) — filter UX and summary display
**UX Guidelines:** `docs/ux/UX-UI-GUIDELINES.md` (Section 7: Interaction Patterns)

---

## Summary

Add two features to the Project History: (1) expandable AI-generated meeting summaries accessible via an icon button in each meeting source group header, and (2) advanced filter capabilities for source type and item type (extending the existing discipline/date/search filters). Filter state persists in both Zustand store and URL params for shareable links. Item count badges on each filter option show distribution at a glance.

---

## Acceptance Criteria

### Meeting Summary
- [x] `FileText` icon button appears in meeting `SourceGroupAccordion` header
- [x] Icon visible on hover: `opacity-0 group-hover:opacity-100 transition-opacity`
- [x] Click expands a summary section below the header, above item rows
- [x] Summary displays AI-generated text from `Source.ai_summary` field
- [x] Summary section styling:
  - [x] Background: `bg-blue-50/50`
  - [x] Padding: `px-4 py-3`
  - [x] Text: `text-sm text-gray-700 italic`
  - [x] Border: `border-b border-blue-100`
- [x] Collapse toggle: click icon again to hide summary
- [x] Summary state is local (component-level, not in store)
- [x] If no `ai_summary` available, icon is hidden
- [x] Summary section animates open/close: `transition-all duration-200`

### Source Type Filters
- [x] New filter group: "Source" with 4 toggle chips
- [x] Chips follow UX Guidelines Section 2.8 colors:
  - [x] Meeting: `Video` icon, active: `bg-indigo-100 text-indigo-700`
  - [x] Email: `Mail` icon, active: `bg-sky-100 text-sky-700`
  - [x] Document: `FileText` icon, active: `bg-orange-100 text-orange-700`
  - [x] Manual Input: `PenLine` icon, active: `bg-gray-200 text-gray-700`
- [x] Toggle behavior: click to activate/deactivate (multi-select)
- [x] Inactive style: `bg-gray-100 text-gray-600`
- [x] Item count badge on each chip showing how many items from that source

### Item Type Filters
- [x] New filter group: "Type" with 5 toggle chips
- [x] Chips follow UX Guidelines Section 2.7 colors:
  - [x] Decision: `CheckCircle2` icon, active: `bg-green-100 text-green-700`
  - [x] Topic: `MessageCircle` icon, active: `bg-amber-100 text-amber-700`
  - [x] Action Item: `Target` icon, active: `bg-blue-100 text-blue-700`
  - [x] Idea: `Lightbulb` icon, active: `bg-purple-100 text-purple-700`
  - [x] Information: `Info` icon, active: `bg-slate-100 text-slate-700`
- [x] Same toggle behavior and styling pattern as source chips

### Filter Logic
- [x] **AND across dimensions:** source + item type + discipline + date + search all combine
- [x] **OR within each dimension:** e.g., "Meeting" + "Email" shows items from either
- [x] Filters applied client-side to already-fetched data
- [x] Empty result: "No items match your filters." + "Clear filters" link
- [x] Filter response time: <200ms (client-side)
- [x] Debounce search input: 300ms

### Filter Bar Layout
- [x] Source and Item Type chips render in the existing FilterBar component
- [x] Layout: Search row → Filter chips row (Discipline | Source | Type | Date | Who) → Active chips row
- [x] Each filter group visually separated with a thin divider or label
- [x] "Clear all" button resets all filters including new ones

### Filter State Persistence
- [x] New filter dimensions added to `filterStore.ts`:
  ```typescript
  sourceTypes: SourceType[]        // selected source type filters
  itemTypes: ItemType[]            // selected item type filters
  toggleSourceType: (type: SourceType) => void
  toggleItemType: (type: ItemType) => void
  ```
- [x] URL param encoding: `?source=meeting,email&type=decision,topic&discipline=architecture`
- [x] On page load: URL params → filterStore hydration
- [x] On filter change: filterStore → URL params update (via `replaceState`)
- [x] Shareable: copy URL → open → same filters applied

### Item Count Badges
- [x] Each filter chip shows count of matching items: `(12)` badge
- [x] Count updates reactively as other filters are applied
- [x] Badge styling: `text-[10px] font-medium text-gray-400 ml-0.5`

---

## Tasks

### Task 1: Meeting Summary Component (0.75 days)

1. **Create `src/components/molecules/MeetingSummary.tsx`**
   ```typescript
   interface MeetingSummaryProps {
     summary: string
     isExpanded: boolean
   }

   export function MeetingSummary({ summary, isExpanded }: MeetingSummaryProps) {
     if (!isExpanded) return null
     return (
       <div className="bg-blue-50/50 px-4 py-3 border-b border-blue-100 animate-in fade-in duration-200">
         <p className="text-sm text-gray-700 italic">{summary}</p>
       </div>
     )
   }
   ```

2. **Modify `src/components/molecules/SourceGroupAccordion.tsx`**
   - Add `FileText` icon button in header (visible on hover)
   - Local state: `const [showSummary, setShowSummary] = useState(false)`
   - Render `MeetingSummary` between header and items
   - Only show icon if `source.ai_summary` is truthy

### Task 2: Update Filter Store (0.5 days)

1. **Modify `src/store/filterStore.ts`**
   ```typescript
   interface FilterState {
     // Existing
     disciplines: string[]
     dateFrom: string | null
     dateTo: string | null
     searchQuery: string
     meetingTypes: string[]

     // New V2 filters
     sourceTypes: SourceType[]
     itemTypes: ItemType[]

     // Actions
     toggleSourceType: (type: SourceType) => void
     toggleItemType: (type: ItemType) => void
     setSourceTypes: (types: SourceType[]) => void
     setItemTypes: (types: ItemType[]) => void
     reset: () => void
   }
   ```

### Task 3: Add Source/Type Chips to FilterBar (1 day)

1. **Modify `src/components/organisms/FilterBar.tsx`**
   - Add "Source" chip group with 4 toggle chips
   - Add "Type" chip group with 5 toggle chips
   - Each chip has icon + label + count badge
   - Group label: `text-xs text-gray-400 uppercase tracking-wide mr-2`
   - Layout: horizontal flex with chip groups separated by thin vertical divider

   ```tsx
   const SOURCE_CHIPS = [
     { value: 'meeting', label: 'Meeting', icon: Video, activeClass: 'bg-indigo-100 text-indigo-700' },
     { value: 'email', label: 'Email', icon: Mail, activeClass: 'bg-sky-100 text-sky-700' },
     { value: 'document', label: 'Document', icon: FileText, activeClass: 'bg-orange-100 text-orange-700' },
     { value: 'manual_input', label: 'Manual', icon: PenLine, activeClass: 'bg-gray-200 text-gray-700' },
   ]

   const TYPE_CHIPS = [
     { value: 'decision', label: 'Decision', icon: CheckCircle2, activeClass: 'bg-green-100 text-green-700' },
     { value: 'topic', label: 'Topic', icon: MessageCircle, activeClass: 'bg-amber-100 text-amber-700' },
     { value: 'action_item', label: 'Action', icon: Target, activeClass: 'bg-blue-100 text-blue-700' },
     { value: 'idea', label: 'Idea', icon: Lightbulb, activeClass: 'bg-purple-100 text-purple-700' },
     { value: 'information', label: 'Info', icon: Info, activeClass: 'bg-slate-100 text-slate-700' },
   ]
   ```

### Task 4: URL Param Persistence (0.5 days)

1. **Create `src/hooks/useFilterUrlSync.ts`**
   ```typescript
   import { useEffect } from 'react'
   import { useFilterStore } from '@/store/filterStore'
   import { useSearchParams } from 'react-router-dom'

   export function useFilterUrlSync() {
     const filters = useFilterStore()
     const [searchParams, setSearchParams] = useSearchParams()

     // Hydrate from URL on mount
     useEffect(() => {
       const source = searchParams.get('source')?.split(',') ?? []
       const type = searchParams.get('type')?.split(',') ?? []
       const discipline = searchParams.get('discipline')?.split(',') ?? []
       if (source.length) filters.setSourceTypes(source as SourceType[])
       if (type.length) filters.setItemTypes(type as ItemType[])
       if (discipline.length) filters.setDisciplines(discipline)
     }, []) // Run once on mount

     // Sync to URL on filter change
     useEffect(() => {
       const params = new URLSearchParams()
       if (filters.sourceTypes.length) params.set('source', filters.sourceTypes.join(','))
       if (filters.itemTypes.length) params.set('type', filters.itemTypes.join(','))
       if (filters.disciplines.length) params.set('discipline', filters.disciplines.join(','))
       if (filters.searchQuery) params.set('q', filters.searchQuery)
       setSearchParams(params, { replace: true })
     }, [filters.sourceTypes, filters.itemTypes, filters.disciplines, filters.searchQuery])
   }
   ```

### Task 5: Apply Combined Filters (0.5 days)

1. **Modify `src/pages/ProjectDetail.tsx`**
   ```typescript
   function applyFilters(items: ProjectItem[], filters: FilterState): ProjectItem[] {
     let result = items

     // Source type filter (OR within)
     if (filters.sourceTypes.length > 0) {
       result = result.filter(item => filters.sourceTypes.includes(item.source_type))
     }

     // Item type filter (OR within)
     if (filters.itemTypes.length > 0) {
       result = result.filter(item => filters.itemTypes.includes(item.item_type))
     }

     // Discipline filter (OR within, matches any in affected_disciplines)
     if (filters.disciplines.length > 0) {
       result = result.filter(item =>
         item.affected_disciplines.some(d => filters.disciplines.includes(d))
       )
     }

     // Date range filter
     if (filters.dateFrom) {
       result = result.filter(item => new Date(item.created_at) >= new Date(filters.dateFrom!))
     }
     if (filters.dateTo) {
       result = result.filter(item => new Date(item.created_at) <= new Date(filters.dateTo!))
     }

     // Search query (debounced)
     if (filters.searchQuery) {
       const q = filters.searchQuery.toLowerCase()
       result = result.filter(item =>
         item.statement.toLowerCase().includes(q) ||
         item.who?.toLowerCase().includes(q)
       )
     }

     return result
   }
   ```

### Task 6: Write Tests (1 day)

1. **Create `src/tests/components/MeetingSummary.test.tsx`**
   - Summary renders when expanded
   - Summary hidden when collapsed
   - Italic text styling
   - No render when summary is empty

2. **Update `src/tests/components/FilterBar.test.tsx`**
   - Source type chips render with correct icons and colors
   - Item type chips render with correct icons and colors
   - Toggle activates/deactivates chips
   - Count badges update correctly
   - Clear all resets source and item type filters
   - Combined filters reduce items correctly

3. **Create `src/tests/hooks/useFilterUrlSync.test.tsx`**
   - URL params hydrate filter store on mount
   - Filter changes update URL params
   - Empty filters produce clean URL

---

## Dev Notes

### Filter Architecture

```
FilterBar (Organism)
├── Search row (full-width)
├── Filter chips row:
│   ├── Discipline group (existing popovers)
│   ├── Divider
│   ├── Source chips (Meeting | Email | Document | Manual)
│   ├── Divider
│   ├── Type chips (Decision | Topic | Action | Idea | Info)
│   ├── Divider
│   ├── Date range (existing popover)
│   ├── Who (existing popover)
│   └── GroupBy toggle (right-aligned)
└── Active chips row (removable)

filterStore (Zustand) ←→ useFilterUrlSync ←→ URL params
         ↓
  applyFilters(items, filters)
         ↓
  Filtered items → Timeline Dense Rows
```

### Count Badges Calculation

```typescript
function getFilterCounts(allItems: ProjectItem[]) {
  return {
    sources: {
      meeting: allItems.filter(i => i.source_type === 'meeting').length,
      email: allItems.filter(i => i.source_type === 'email').length,
      document: allItems.filter(i => i.source_type === 'document').length,
      manual_input: allItems.filter(i => i.source_type === 'manual_input').length,
    },
    types: {
      decision: allItems.filter(i => i.item_type === 'decision').length,
      topic: allItems.filter(i => i.item_type === 'topic').length,
      action_item: allItems.filter(i => i.item_type === 'action_item').length,
      idea: allItems.filter(i => i.item_type === 'idea').length,
      information: allItems.filter(i => i.item_type === 'information').length,
    },
  }
}
```

**Important:** Count badges show total items per category (not post-filter counts). This gives users a sense of data distribution. Post-filter counts would be confusing as they'd change while clicking.

---

## File List

**New Files:**
- `src/components/molecules/MeetingSummary.tsx` — Expandable AI summary
- `src/hooks/useFilterUrlSync.ts` — URL ↔ filter store sync
- `src/tests/components/MeetingSummary.test.tsx`
- `src/tests/components/FilterBar.source-type.test.tsx`
- `src/tests/hooks/useFilterUrlSync.test.ts`

**Modified Files:**
- `src/components/organisms/FilterBar.tsx` — Add source/type chip groups, count badges
- `src/components/molecules/SourceGroupAccordion.tsx` — Add summary icon + MeetingSummary
- `src/pages/ProjectDetail.tsx` — Combined filter logic, useFilterUrlSync integration

---

## Testing Strategy

### Unit Tests
```
- [x] MeetingSummary renders and hides correctly
- [x] Source type chips toggle on/off
- [x] Item type chips toggle on/off
- [x] Combined filter logic: source + type + discipline + date + search
- [x] OR within dimension, AND across dimensions
- [x] Count badges show correct totals
- [x] URL params hydrate filters on mount
- [x] Filter changes update URL params
- [x] Clear all resets all filter dimensions
- [x] Empty result state shows message
- [x] Meeting summary icon hidden when no ai_summary
```

### Integration Tests
- Filter round-trip: set filters → refresh page → filters restored from URL

### Coverage Target: 80%+

---

## Change Log

| Date | Change |
|------|--------|
| 2026-02-20 | Created story |
| 2026-02-28 | Implemented all tasks (Tasks 1-6), all ACs met, 31 new tests passing |

---

**Related Stories:** 3.6 (FilterBar v1), 3.14 (filter redesign), 9.2 (SourceGroupAccordion), 9.1 (badge/icon atoms), 8.3 (milestone filters similar pattern)
**Blocked By:** 9.2 (SourceGroupAccordion must exist for summary integration), 9.1 (atoms for filter chips)
**Blocks:** 9.5 (rename uses updated filter bar)
