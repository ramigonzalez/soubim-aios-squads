# Story 9.2: Dense Rows Layout & Visual Layer Separation

**Story ID:** 9.2
**Epic:** E9 â€” Project History Enhancement
**Assigned to:** @dev
**Sprint:** Sprint 5 (Week 7)
**Status:** Draft
**Estimation:** 8 story points (3-4 days)
**Review:** @ux-design-expert (Uma) â€” Dense Rows visual validation
**UX Guidelines:** `docs/ux/UX-UI-GUIDELINES.md` (Section 11.2: Project History Dense Rows)
**Design Spec:** `docs/ux/FRONTEND-SPEC-timeline-polish-v3.md`

---

## Summary

Redesign the existing Timeline into a **Dense Rows** layout inspired by Linear/Notion. Three visual layers with clear differentiation: (1) UPPERCASE sticky date headers, (2) collapsible source group accordions with colored left border, and (3) compact single-line item rows (~32-40px height). This replaces the V1 card-based timeline with a high-density scannable layout optimized for reviewing 50+ project items. Uses `ItemTypeBadge`, `SourceIcon`, and `DisciplineCircles` atoms from Story 9.1.

---

## Acceptance Criteria

### Layer 1: Date Headers (UPPERCASE, Sticky)
- [ ] Date format: UPPERCASE short month + day + year: `FEB 8, 2026` (Overline style)
- [ ] Typography: `text-xs font-bold tracking-wide uppercase text-gray-500`
- [ ] Sticky position: `sticky top-0 z-10 bg-white/95 backdrop-blur-sm`
- [ ] Bottom border: `border-b border-gray-200`
- [ ] Item count badge: total items for that date, `text-xs text-gray-400 ml-2`
- [ ] Height: 32px (`py-2 px-4`)
- [ ] Groups items by `occurred_at` or `created_at` date

### Layer 2: Source Groups (Accordion, Left Border)
- [ ] Source group header shows: `SourceIcon` + source title + item count + metadata
- [ ] **Meeting sources:** title, time, participant count, duration, item count, summary icon
  - [ ] Left border: `border-l-2` colored by primary discipline (from participants)
  - [ ] Format: `ðŸ“¹ Client Alignment - Electrical | 3 items | 45min | ðŸ‘¥ 3`
- [ ] **Email sources:** subject, from, item count
  - [ ] Left border: `border-l-2 border-sky-400`
  - [ ] Format: `ðŸ“§ RE: Foundation specs updated | 1 item`
- [ ] **Document sources:** file name, file type, item count
  - [ ] Left border: `border-l-2 border-orange-400`
- [ ] **Manual input items** render directly under date header (no source group wrapper)
- [ ] Typography: `text-sm font-semibold text-gray-900`
- [ ] Collapsible accordion: expanded if â‰¤5 items, collapsed if >5
- [ ] Accordion chevron: `ChevronDown` rotating 180Â° on toggle
- [ ] Height: 48px (`py-3 px-4`)
- [ ] Transition: `transition-transform duration-200` on chevron

### Layer 3: Item Rows (Dense, Single-Line)
- [ ] **Create `ProjectItemRow` molecule** replacing `DecisionRow` for V2
- [ ] Row height: 32-40px (`py-2 px-4`)
- [ ] Row anatomy (left to right):
  1. `ItemTypeBadge` (icon only, no label) â€” 14px icon
  2. Statement text â€” `text-sm font-medium text-gray-900 truncate` (takes remaining width)
  3. `DisciplineCircles` â€” first 3 + "+N" overflow (sm size)
  4. Who â€” `text-xs text-gray-500 truncate max-w-[80px]`
  5. Timestamp/date â€” `text-xs text-gray-400 whitespace-nowrap`
  6. Milestone star (admin only, visible on hover) â€” `Star` icon, filled if milestone
- [ ] Spacing between columns: `gap-2`
- [ ] Row hover: `hover:bg-blue-50/50` with `transition-colors duration-150`
- [ ] Row click: opens DrilldownModal (Story 3.7)
- [ ] Keyboard: `role="button"`, `tabIndex={0}`, Enter to open modal
- [ ] Focus: `focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-1`

### Visual Differentiation Between Layers
- [ ] Layer separation via: UPPERCASE vs sentence case, indent depth, border-l color, background
- [ ] Date headers: no indent, uppercase, sticky, `bg-white/95`
- [ ] Source groups: slight indent (`pl-2`), `border-l-2` colored, `bg-white`
- [ ] Item rows: deeper indent (`pl-6`), no border-l, `bg-transparent`
- [ ] Clear visual parent-child: source group wraps its items (like V1's `bg-gray-50/80` inset from Story 3.13)

### Items Without Source Group
- [ ] Manual input items and orphan items render directly under their date header
- [ ] No accordion wrapper â€” just standalone item rows
- [ ] Slight visual distinction: no left border, standard indent

### Performance
- [ ] 50+ items render without visible lag
- [ ] Sticky date headers work smoothly during scroll
- [ ] Accordion expand/collapse is instant (no layout shift)
- [ ] Consider virtualization if >200 items (defer to testing)

### Responsive Design
- [ ] Desktop (1024px+): full layout as described
- [ ] Tablet (768px): tighter column widths, shorter truncation
- [ ] Mobile (375px): hide discipline circles, show only icon + statement + who, taller rows (48px)

---

## Tasks

### Task 1: Create ProjectItemRow Molecule (1 day)

1. **Create `src/components/molecules/ProjectItemRow.tsx`**
   ```typescript
   import { cn } from '@/lib/utils'
   import { ItemTypeBadge } from '@/components/atoms/ItemTypeBadge'
   import { DisciplineCircles } from '@/components/atoms/DisciplineCircles'
   import { Star } from 'lucide-react'
   import type { ProjectItem } from '@/types/projectItem'

   interface ProjectItemRowProps {
     item: ProjectItem
     onClick: (id: string) => void
     onToggleMilestone?: (id: string) => void
     isAdmin?: boolean
   }

   export function ProjectItemRow({ item, onClick, onToggleMilestone, isAdmin }: ProjectItemRowProps) {
     return (
       <div
         className="flex items-center gap-2 py-2 px-4 pl-6 hover:bg-blue-50/50
                    transition-colors duration-150 cursor-pointer group"
         onClick={() => onClick(item.id)}
         role="button"
         tabIndex={0}
         onKeyDown={(e) => e.key === 'Enter' && onClick(item.id)}
         aria-label={`${item.item_type}: ${item.statement}`}
       >
         <ItemTypeBadge type={item.item_type} />
         <span className="text-sm font-medium text-gray-900 truncate flex-1 min-w-0">
           {item.statement}
         </span>
         <DisciplineCircles disciplines={item.affected_disciplines} max={3} size="sm" />
         <span className="text-xs text-gray-500 truncate max-w-[80px] hidden sm:block">
           {item.who}
         </span>
         <span className="text-xs text-gray-400 whitespace-nowrap">
           {formatShortDate(item.created_at)}
         </span>
         {isAdmin && (
           <button
             className={cn(
               'opacity-0 group-hover:opacity-100 transition-opacity',
               item.is_milestone ? 'text-yellow-500' : 'text-gray-300 hover:text-yellow-400'
             )}
             onClick={(e) => { e.stopPropagation(); onToggleMilestone?.(item.id) }}
             aria-label={item.is_milestone ? 'Remove milestone' : 'Mark as milestone'}
           >
             <Star className="w-4 h-4" fill={item.is_milestone ? 'currentColor' : 'none'} />
           </button>
         )}
       </div>
     )
   }
   ```

### Task 2: Create SourceGroupAccordion Molecule (0.75 days)

1. **Create `src/components/molecules/SourceGroupAccordion.tsx`**
   ```typescript
   interface SourceGroupAccordionProps {
     source: Source
     items: ProjectItem[]
     onItemClick: (id: string) => void
     onToggleMilestone?: (id: string) => void
     isAdmin?: boolean
   }

   // Source group header with left border + accordion
   // Items rendered inside as ProjectItemRow list
   // Collapsed by default if >5 items
   ```
   - Uses `SourceIcon` for source type indicator
   - Left border color based on source type (meetings: discipline color, emails: sky, docs: orange)
   - Chevron rotation animation on expand/collapse
   - Item count badge

### Task 3: Redesign Timeline Organism (1 day)

1. **Modify `src/components/organisms/Timeline.tsx`**
   - Rename internal references to "Project History"
   - Replace existing 3-layer card layout with Dense Rows layout
   - Group items by date â†’ then by source within each date
   - Render: Date header â†’ SourceGroupAccordion(s) â†’ ProjectItemRow(s)
   - Sticky date headers
   - Handle items without source (manual input) as standalone rows

   ```typescript
   interface DenseTimelineGroup {
     date: string           // "2026-02-08"
     dateLabel: string      // "FEB 8, 2026"
     totalItems: number
     sources: {
       source: Source
       items: ProjectItem[]
     }[]
     orphanItems: ProjectItem[]  // manual input or items without source
   }

   function buildDenseGroups(items: ProjectItem[], sources: Source[]): DenseTimelineGroup[] {
     // Group by date, then by source within each date
     // Sort dates newest first
     // Sort sources within date by occurred_at
   }
   ```

### Task 4: Update Date Formatting (0.25 days)

1. **Add to `src/lib/utils.ts`:**
   ```typescript
   export function formatDenseDate(dateStr: string): string {
     const date = new Date(dateStr)
     const month = date.toLocaleString('en-US', { month: 'short' }).toUpperCase()
     const day = date.getDate()
     const year = date.getFullYear()
     return `${month} ${day}, ${year}` // "FEB 8, 2026"
   }
   ```

### Task 5: Write Tests (1 day)

1. **Create `src/tests/components/ProjectItemRow.test.tsx`**
   - Renders item type badge, statement, disciplines, who, date
   - Click triggers onClick
   - Keyboard Enter triggers onClick
   - Milestone star visible only for admin
   - Milestone star filled when is_milestone
   - Responsive: who hidden on mobile

2. **Create `src/tests/components/SourceGroupAccordion.test.tsx`**
   - Renders source icon and title
   - Shows item count
   - Expanded by default if â‰¤5 items
   - Collapsed by default if >5 items
   - Toggle expand/collapse on click
   - Left border color matches source type

3. **Update `src/tests/components/Timeline.test.tsx`**
   - Dense Rows layout renders
   - Date headers are UPPERCASE
   - Source groups are collapsible
   - Items grouped correctly by date then source
   - Sticky headers work
   - Manual input items render without source wrapper

---

## Dev Notes

### Dense Rows Layout Architecture

```
Timeline (Organism â€” redesigned for V2)
â”œâ”€â”€ Loading: Skeleton rows
â”œâ”€â”€ Empty: "No project items yet" message
â”œâ”€â”€ Error: Alert + retry
â””â”€â”€ For each date group:
    â”œâ”€â”€ DateHeader (UPPERCASE, sticky)
    â”‚   â”œâ”€â”€ "FEB 8, 2026"
    â”‚   â””â”€â”€ Item count badge
    â”œâ”€â”€ SourceGroupAccordion (Molecule) [repeating per source]
    â”‚   â”œâ”€â”€ Header: SourceIcon + title + meta + chevron
    â”‚   â”œâ”€â”€ Left border (border-l-2, colored)
    â”‚   â””â”€â”€ Items area (collapsible):
    â”‚       â””â”€â”€ ProjectItemRow (Molecule) [repeating]
    â”‚           â”œâ”€â”€ ItemTypeBadge (icon)
    â”‚           â”œâ”€â”€ Statement (truncated)
    â”‚           â”œâ”€â”€ DisciplineCircles
    â”‚           â”œâ”€â”€ Who
    â”‚           â”œâ”€â”€ Date
    â”‚           â””â”€â”€ Milestone star (admin, hover)
    â””â”€â”€ Orphan Items (no source wrapper)
        â””â”€â”€ ProjectItemRow [repeating]
```

### V1 â†’ V2 Migration Notes

| V1 Component | V2 Replacement | Status |
|-------------|---------------|--------|
| `DecisionRow` | `ProjectItemRow` | New â€” replaces for V2 views |
| `MeetingGroup` | `SourceGroupAccordion` | New â€” generalized for all source types |
| Card grid layout | Dense rows layout | Redesigned |
| Full date header | UPPERCASE short date | Reformatted |
| Decision-only | All 5 item types | Extended |

**Note:** `DecisionRow` and `MeetingGroup` are NOT deleted â€” they remain for V1 timeline (backward compat during transition). V2 Project History uses the new components.

### Row Height Comparison

| View | Row Height | Items/Screen (1080p) |
|------|-----------|---------------------|
| V1 Cards | ~180px | ~5-6 |
| V1 Compact Rows | 56-64px | ~12-15 |
| V2 Dense Rows | 32-40px | ~20-25 |

---

## File List

**New Files:**
- `src/components/molecules/ProjectItemRow.tsx` â€” Dense item row molecule
- `src/components/molecules/SourceGroupAccordion.tsx` â€” Collapsible source group
- `src/tests/components/ProjectItemRow.test.tsx`
- `src/tests/components/SourceGroupAccordion.test.tsx`

**Modified Files:**
- `src/components/organisms/Timeline.tsx` â€” Major redesign to Dense Rows layout
- `src/lib/utils.ts` â€” Add `formatDenseDate()` utility
- `src/tests/components/Timeline.test.tsx` â€” Updated for Dense Rows structure

---

## Testing Strategy

### Unit Tests
```
- âœ… ProjectItemRow renders all fields (badge, statement, circles, who, date)
- âœ… ProjectItemRow click and keyboard interaction
- âœ… ProjectItemRow milestone star admin visibility
- âœ… SourceGroupAccordion expand/collapse behavior
- âœ… SourceGroupAccordion left border color per source type
- âœ… Timeline Dense Rows: items grouped by date then source
- âœ… Timeline Dense Rows: UPPERCASE date headers
- âœ… Timeline Dense Rows: sticky headers
- âœ… Timeline Dense Rows: manual input items without source group
- âœ… Timeline Dense Rows: empty/loading/error states
- âœ… Responsive: mobile layout adjustments
```

### Performance Testing
- Load test with 50+ items: no visible lag
- Scroll performance with sticky headers: 60fps

### Coverage Target: 80%+

---

## Change Log

| Date | Change |
|------|--------|
| 2026-02-20 | Created story |

---

**Related Stories:** 3.5 (V1 Timeline), 3.13 (visual hierarchy polish), 9.1 (atom components), 9.3 (multi-discipline), 9.4 (meeting summary + filters)
**Blocked By:** 9.1 (ItemTypeBadge, SourceIcon, DisciplineCircles atoms), 5.3 (ProjectItem types)
**Blocks:** 9.4 (meeting summary renders within SourceGroupAccordion), 9.5 (rename to "Project History")
