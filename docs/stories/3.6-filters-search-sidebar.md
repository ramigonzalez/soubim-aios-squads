# Story 3.6: Filters & Search Bar (v2 — Redesigned)

**Story ID:** 3.6
**Assigned to:** @dev
**Sprint:** Sprint 5 (Week 7)
**Status:** Draft (v2 — Client Redesign)
**Estimation:** 8 story points (3-4 days)
**Design Spec:** `docs/ux/FRONTEND-SPEC-timeline-redesign-v2.md`
**Supersedes:** Original v1 sidebar design (functional requirements remain)
**Client Feedback:** Gabriela requested clean, elegant inline filter bar replacing the bulky sidebar; filter by discipline, date range, and decision maker (who)

---

## Summary

Create a horizontal inline filter bar for the decisions timeline with popover-based dropdowns for discipline, date range, and decision maker (who), plus free-text search and active filter chips. The filter bar replaces the previous fixed sidebar to give full width to timeline content. All filters work together with <200ms update performance.

**Key change from v1:** Replaced 256px fixed sidebar with a compact horizontal filter bar (~48-80px height) using popover dropdowns. Removed Meeting Type and Anomalies filters (deferred). Added Decision Maker (who) filter per Gabriela's request.

---

## UX Research Context

This story implements **critical filtering functionality** for Architects and directly supports:

**Research Insight 3: Discipline-First Mental Model (Primary)**
- **Critical Finding:** Architects think in discipline silos first: *"Show me all MEP decisions that affect my architecture work"*
- Discipline filter must be **prominent and easy to access** — first popover in the filter bar
- Multi-select checkboxes allow filtering by multiple disciplines simultaneously
- Default state: All disciplines shown, Architects narrow by checking specific disciplines

**Research Insight 2: Digest vs. Deep Dive Split**
- Filters enable Architects to **narrow the Deep Dive** (Timeline, Story 3.5)
- Filters transform the timeline from "all 200+ decisions" to "12 MEP decisions from last 2 weeks"

**Research Insight 4: Mobile-First for Gabriela During Maternity**
- Filters must work on **iPad and mobile** (responsive design)
- **Desktop:** Full horizontal filter bar visible
- **Mobile (< 768px):** Search always visible, filters collapse to single "Filters ({count})" button → opens Shadcn `Drawer` (bottom sheet)

**Research Insight 1: Trust Through Transparency**
- Filters don't hide decisions, they **focus attention** on relevant decisions
- "Clear all" button always visible to reset to full transparency
- Active filter chips show exactly what's being filtered

**Gabriela's Direct Feedback (2026-02-08):**
> "The sidebar is too big. I want something more clean and elegant. I want to filter by discipline, datetime, and if possible, by decision maker."

**Design System: Shadcn/ui Popover, Checkbox, Input, Drawer Components**
- Popover: Filter dropdowns (Discipline, Date, Who)
- Checkbox: Multi-select within popovers
- Input: Search box (debounced 300ms), date pickers
- Badge: Active filter count, discipline chips
- Drawer: Mobile filter panel (bottom sheet)

**Component Architecture: Atomic Design**
- **Organism:** FilterBar (horizontal bar with search + popovers + chips)
- **Molecule:** FilterPopover (reusable popover with checkbox list)
- **Molecule:** ActiveFilterChips (removable filter tags)
- **Atoms:** Checkbox, Input, Label, Button, Badge, Popover (from Shadcn/ui)

**User Flow:**
1. User lands on Project Detail page with Timeline (Story 3.5)
2. Sees compact filter bar above the timeline (search + 3 filter buttons)
3. Clicks "Discipline" → Popover opens with checkboxes → selects "MEP" + "Architecture"
4. Active chips appear: `[MEP ✕] [Architecture ✕]`
5. Timeline narrows to ~50 decisions instantly (<200ms)
6. Clicks "Date" → Popover with From/To pickers or quick presets
7. Clicks "Who" → Popover with decision maker checkboxes
8. Scans filtered decisions, clicks one for drill-down (Story 3.7)
9. Clicks "Clear (3)" to reset all filters

**Performance Requirements:**
- Filter update: <200ms from checkbox click to timeline refresh
- Debounced search: 300ms delay (prevents API spam while typing)
- URL persistence: Filters saved in query params (shareable links)

**Reference:** `docs/ux/FRONTEND-SPEC-timeline-redesign-v2.md` (Section 4.3)

---

## Acceptance Criteria

### Filter Bar Layout & Structure (v2 — Replaces Sidebar)
- [ ] `FilterBar` component: horizontal full-width bar above timeline content
- [ ] Container styling: `bg-white border border-gray-200 rounded-lg p-3 shadow-sm`
- [ ] Inline layout: Search input + Discipline button + Date button + Who button + Clear button
- [ ] Active filter chips row below the bar (only when filters active)
- [ ] Full-width (no sidebar stealing space from timeline)
- [ ] Height: ~48px collapsed, ~80px with active filter chips

### Search Input (Debounced)
- [ ] Free-text search input with Search icon (`lucide-react Search`, `w-4 h-4`)
- [ ] Positioned: left side of filter bar, flexible width
- [ ] Placeholder: "Search decisions..."
- [ ] Borderless inside bar: `border-0 focus:ring-0` (clean look)
- [ ] Searches across:
  - [ ] Decision statement field
  - [ ] Why/reasoning field
- [ ] **300ms debounce** to prevent API spam while typing
- [ ] Small `X` icon appears when text present (clear search)

### Discipline Filter (UX Insight 3: Primary Filter)
- [ ] Trigger: Shadcn/ui `Button` variant="outline" size="sm" with text "Discipline" + chevron-down icon
- [ ] Active indicator on trigger: shows count "Discipline (2)" when filters selected
- [ ] Opens Shadcn/ui `Popover` with checkbox list:
  - [ ] Architecture
  - [ ] MEP
  - [ ] Structural
  - [ ] Electrical
  - [ ] Plumbing
  - [ ] Landscape
- [ ] Checkboxes use Shadcn/ui `Checkbox` + `Label` components
- [ ] Popover width: `w-48`
- [ ] Clicking checkbox toggles discipline filter immediately (<200ms)

### Date Range Filter
- [ ] Trigger: Shadcn/ui `Button` variant="outline" size="sm" with text "Date" + chevron-down icon
- [ ] Active indicator: shows "Date (1)" when date range set
- [ ] Opens Shadcn/ui `Popover` with:
  - [ ] "From" date input (HTML5 `type="date"` with Shadcn/ui `Input` styling)
  - [ ] "To" date input
  - [ ] Quick presets section:
    - [ ] Last 7 days
    - [ ] Last 30 days
    - [ ] This month
    - [ ] All time
- [ ] Popover width: `w-64`
- [ ] Date inputs use native browser date picker on mobile

### Decision Maker (Who) Filter (NEW — v2)
- [ ] Trigger: Shadcn/ui `Button` variant="outline" size="sm" with text "Who" + chevron-down icon
- [ ] Active indicator: shows "Who (1)" when makers selected
- [ ] Opens Shadcn/ui `Popover` with:
  - [ ] Mini search input to filter names within popover
  - [ ] Checkboxes for unique `who` values extracted client-side from loaded decisions
- [ ] Decision maker list dynamically built from `decisions.map(d => d.who)` → unique sorted
- [ ] Popover width: `w-48`

### Active Filter Chips
- [ ] Chips row below the filter bar (container: `flex flex-wrap gap-1.5 mt-2`)
- [ ] Only renders when `activeFilterCount > 0`
- [ ] Each chip: `inline-flex items-center gap-1 text-xs px-2 py-1 rounded-full`
- [ ] Discipline chips use discipline color tokens: `bg-discipline-mep/10 text-discipline-mep`
- [ ] Who chips: `bg-gray-100 text-gray-700`
- [ ] Date range chip: "Feb 1 – Feb 7" format, `bg-gray-100 text-gray-700`
- [ ] Each chip has remove `X` button (`w-3 h-3`, removes that specific filter)
- [ ] Removing a chip via X updates filter store immediately

### Clear All Button
- [ ] Positioned: right side of filter bar, inline with dropdown buttons
- [ ] Style: `text-xs text-gray-500 hover:text-gray-700` with small X icon
- [ ] Label: `Clear ({count})` showing active filter count
- [ ] Only visible when `activeFilterCount > 0`
- [ ] Resets all filters to default state via `filterStore.reset()`
- [ ] Timeline refreshes to show all decisions after clear

### Combined Filtering & State Management
- [ ] All filters work together (AND logic):
  - Example: Discipline=MEP AND Date_From=2026-01-01 AND Who=Carlos
- [ ] Zustand store (`filterStore.ts`) manages filter state:
  - [ ] `disciplines: string[]` — selected disciplines
  - [ ] `decisionMakers: string[]` — selected decision makers (NEW)
  - [ ] `dateFrom: string | null` — start date
  - [ ] `dateTo: string | null` — end date
  - [ ] `searchQuery: string` — search text
  - [ ] `toggleDiscipline(discipline)` — toggle discipline selection
  - [ ] `toggleDecisionMaker(name)` — toggle decision maker selection (NEW)
  - [ ] `setDateRange(from, to)` — set date range
  - [ ] `setSearchQuery(query)` — set search text
  - [ ] `reset()` — clear all filters
- [ ] **Removed from store:** `meetingTypes`, `toggleMeetingType` (deferred, not MVP)
- [ ] Timeline (Story 3.5) subscribes to filter store
- [ ] React Query refetches decisions when filters change (queryKey includes filters)

### URL Persistence (Shareable Filters)
- [ ] Filters synced to URL query parameters:
  - `?discipline=mep,architecture&date_from=2026-01-01&who=Carlos&search=foundation`
- [ ] On page load, filters read from URL and applied
- [ ] When filters change, URL updates (replace: true, no history spam)
- [ ] Shareable links preserve filter state (user can share filtered view)

### Performance (UX Success Metric)
- [ ] Filter update: <200ms from checkbox click to timeline refresh
- [ ] Search input debounced: 300ms delay before filtering
- [ ] No blocking UI during filter updates (optimistic updates)
- [ ] React Query caching: Filtered results cached separately
- [ ] Popover open: <100ms (Shadcn Popover / Radix)

### Responsive Design (UX Insight 4: Mobile-First)
- [ ] **Desktop (1024px+):**
  - Full horizontal filter bar visible
  - All dropdowns inline
  - Full-width content below
- [ ] **Tablet (768px-1023px):**
  - Same layout, tighter padding
  - Filter bar wraps naturally (search on top, buttons below)
- [ ] **Mobile (< 768px):**
  - Search input always visible (full width)
  - Filter buttons collapse to single "Filters ({count})" button
  - Button opens Shadcn `Drawer` (bottom sheet) with all filter options
  - Active chips horizontally scrollable
- [ ] Touch-friendly filter controls (tap area ≥44px)

### Accessibility (WCAG 2.1 AA)
- [ ] Semantic HTML:
  - `<nav>` for filter bar container
  - Labels associated with inputs (`htmlFor` attribute)
- [ ] ARIA labels:
  - Filter buttons: `aria-label="Filter by {type}"`
  - Popover: ARIA expanded state (Shadcn/ui Popover handles automatically)
  - Checkboxes: Associated labels (Shadcn/ui `Label` component)
  - Chips: `aria-label="Remove {filter-name} filter"`
- [ ] Keyboard navigation:
  - Tab through filter buttons and search input
  - Enter/Space to open popovers
  - Tab through checkboxes within popover
  - Escape to close popover
- [ ] Focus visible styles (Shadcn/ui default focus ring)
- [ ] Screen reader friendly:
  - Active filter count announced
  - "Clear all" button announces action
  - Chip removal announced

### Testing
- [ ] Unit tests >80% coverage:
  - FilterBar renders with search + 3 filter buttons
  - Discipline popover opens and checkboxes toggle correctly
  - Date range popover opens and date inputs work
  - Who popover opens with dynamic decision maker list
  - Active filter chips render and remove correctly
  - "Clear all" resets all filters
  - Active count calculated correctly
  - Search input debounced (300ms)
  - URL persistence (query params sync)
- [ ] Integration test: Filter changes → Timeline refetches → Decisions filtered
- [ ] Performance test: Filter update <200ms
- [ ] Responsive test: Bottom sheet drawer on mobile, inline bar on desktop
- [ ] Accessibility test: Keyboard navigation, screen reader

---

## Tasks

### Task 1: Update Filter Store (0.5 days)

1. **Modify `src/store/filterStore.ts`**
   - Add `decisionMakers: string[]` field
   - Add `toggleDecisionMaker(name: string)` action
   - Add `setDecisionMakers(names: string[])` action
   - Remove `meetingTypes: string[]` field (deferred)
   - Remove `toggleMeetingType` action (deferred)
   - Update `reset()` to include new fields
   - Update localStorage persistence key (or clear stale data)

### Task 2: Create FilterBar Component (1.5 days)

1. **Create `src/components/organisms/FilterBar.tsx`**
   - Horizontal bar: search input + 3 filter trigger buttons + clear button
   - Search with debounce (uses `useDebouncedValue` hook)
   - Each filter button opens a `FilterPopover`
   - Active filter chips rendered below bar when filters active
   - Clear button with count badge

2. **Create `src/components/molecules/FilterPopover.tsx`**
   - Reusable popover component for filter dropdowns
   - Props: `label`, `activeCount`, `children` (popover content)
   - Shadcn/ui `Popover` + `PopoverTrigger` + `PopoverContent`
   - Trigger shows label + count when active: "Discipline (2)"

3. **Install Shadcn components**
   ```bash
   npx shadcn-ui@latest add popover
   npx shadcn-ui@latest add drawer
   ```

### Task 3: Implement Individual Filter Popovers (0.75 days)

1. **Discipline popover content**
   - Checkbox list for 6 disciplines
   - Toggle via `filterStore.toggleDiscipline()`

2. **Date Range popover content**
   - From/To date inputs
   - Quick presets (Last 7 days, Last 30 days, This month, All time)
   - Updates via `filterStore.setDateRange(from, to)`

3. **Who (Decision Maker) popover content**
   - Mini search input for filtering names
   - Dynamic checkbox list from `useMemo(() => [...new Set(decisions.map(d => d.who))])`
   - Toggle via `filterStore.toggleDecisionMaker()`

### Task 4: Implement Active Filter Chips (0.25 days)

1. **Create chips component within FilterBar**
   - Map active disciplines → discipline-colored chips
   - Map active decision makers → gray chips
   - Map date range → formatted date chip
   - Map search query → gray chip
   - Each chip has X button calling the specific remove function

### Task 5: Connect FilterBar to Timeline (0.5 days)

1. **Update `src/pages/ProjectDetail.tsx`**
   - Replace `<FiltersSidebar />` import with `<FilterBar />`
   - Remove `<aside>` wrapper and sidebar layout
   - Render FilterBar in vertical flow (below header, above GroupingToggle/Timeline)
   - Pass `decisions` to FilterBar for Who filter dynamic list

2. **Update `src/hooks/useDecisions.ts`**
   - Subscribe to `decisionMakers` from filter store (new field)
   - Remove `meetingTypes` from query params
   - Add `who` query parameter support

### Task 6: Add URL Persistence (0.5 days)

1. **Update `src/hooks/useFilterSync.ts`**
   - Add `who` param: `?who=Carlos,Gabriela`
   - Remove `meeting_type` param
   - Sync `decisionMakers` array to/from URL

### Task 7: Add Mobile Responsive Drawer (0.5 days)

1. **Create mobile filter experience**
   - Detect viewport < 768px
   - Replace filter buttons with single "Filters ({count})" button
   - Button opens Shadcn `Drawer` component (bottom sheet)
   - Drawer contains all filter sections (Discipline, Date, Who) stacked vertically
   - Search remains visible above the drawer trigger

### Task 8: Write Tests (0.5 days)

1. **Create `tests/components/FilterBar.test.tsx`**
   - FilterBar renders search + filter buttons
   - Discipline popover opens and toggles
   - Date range popover opens and sets range
   - Who popover shows dynamic list
   - Active chips render and remove
   - Clear button resets all
   - Active count correct

2. **Update `tests/store/filterStore.test.ts`**
   - `toggleDecisionMaker` works correctly
   - `meetingTypes` removed
   - `reset()` clears new fields

3. **Create `tests/components/FilterPopover.test.tsx`**
   - Popover opens on click
   - Shows active count on trigger
   - Renders children content

---

## Dev Notes

### Filter Architecture (Atomic Design) — v2

```
FilterBar (Organism)
├── SearchInput
│   ├── Search icon (lucide-react)
│   ├── Input (borderless, debounced 300ms)
│   └── Clear X icon (when text present)
│
├── FilterPopover × 3 (Molecule — reusable)
│   ├── DisciplinePopover
│   │   └── Checkbox Group (6 disciplines)
│   ├── DateRangePopover
│   │   ├── From/To date inputs
│   │   └── Quick presets (7d, 30d, month, all)
│   └── WhoPopover
│       ├── Mini search input
│       └── Dynamic checkbox list (from decisions data)
│
├── ClearAllButton
│   └── "Clear ({count})" — resets filterStore
│
├── ActiveFilterChips (Molecule)
│   ├── Discipline chips (discipline-colored)
│   ├── Who chips (gray)
│   ├── Date range chip (gray)
│   └── Search chip (gray)
│
└── FilterStore (Zustand State)
    ├── disciplines: string[]
    ├── decisionMakers: string[]  ← NEW
    ├── dateFrom: string | null
    ├── dateTo: string | null
    ├── searchQuery: string
    ├── toggleDiscipline()
    ├── toggleDecisionMaker()  ← NEW
    ├── setDateRange()
    ├── setSearchQuery()
    └── reset()

Timeline (Story 3.5) — Consumer
└── useQuery(['decisions', projectId, filters])
    ├── Subscribes to filters from Zustand
    ├── Refetches when filters change
    └── Displays filtered decisions

useFilterSync Hook
├── Reads filters from URL on mount
└── Updates URL when filters change
```

**Component File Locations:**
- `src/components/organisms/FilterBar.tsx` — Main filter bar organism (NEW, replaces FiltersSidebar)
- `src/components/molecules/FilterPopover.tsx` — Reusable popover molecule (NEW)
- `src/components/organisms/FiltersSidebar.tsx` — DEPRECATED (replaced by FilterBar)
- `src/store/filterStore.ts` — Zustand filter state (modify — add decisionMakers, remove meetingTypes)
- `src/hooks/useDebouncedValue.ts` — Debounce hook for search (existing)
- `src/hooks/useFilterSync.ts` — URL query param sync (modify)

### Shadcn/ui Components Required

| Component | Usage | Install |
|-----------|-------|---------|
| `Popover` | Filter dropdowns | `npx shadcn-ui@latest add popover` |
| `Checkbox` | Filter options | Already installed |
| `Drawer` | Mobile filter panel (bottom sheet) | `npx shadcn-ui@latest add drawer` |
| `Badge` | Discipline chips, active count | Already installed |
| `Button` | Filter triggers, clear | Already installed |
| `Input` | Search, date pickers | Already installed |

**No longer needed:** `Accordion` (was used in sidebar, not needed for popover approach)

### Performance Optimization

- **Debounced search**: 300ms delay prevents API spam
- **React Query cache**: Filter changes cached separately
- **Target**: <200ms filter update
- **Popover**: Radix-based, <100ms open time
- **URL sync**: Filters preserved in query params (shareable)

### What Changed from v1

| v1 (Sidebar) | v2 (FilterBar) | Reason |
|-------------|----------------|--------|
| 256px fixed sidebar | Full-width horizontal bar (~48-80px) | Gabriela: "sidebar is too big" |
| Always-visible checkboxes | Popover dropdowns (on demand) | Clean, elegant, space-efficient |
| Accordion sections | Popover per filter type | Modern pattern (Linear/Notion) |
| Discipline + Meeting Type + Anomalies | Discipline + Date + Who | Client requirements |
| Filter summary at sidebar bottom | Active filter chips below bar | More visible, actionable |
| Mobile: drawer from left | Mobile: bottom sheet (Drawer) | Better mobile UX |

---

## File List

**New Files:**
- `src/components/organisms/FilterBar.tsx` — Horizontal filter bar organism
- `src/components/molecules/FilterPopover.tsx` — Reusable popover molecule
- `tests/components/FilterBar.test.tsx` — FilterBar unit tests
- `tests/components/FilterPopover.test.tsx` — FilterPopover unit tests

**Modified Files:**
- `src/store/filterStore.ts` — Add `decisionMakers`, remove `meetingTypes`
- `src/pages/ProjectDetail.tsx` — Replace FiltersSidebar with FilterBar, remove sidebar layout
- `src/hooks/useFilterSync.ts` — Add `who` URL param, remove `meeting_type`
- `src/hooks/useDecisions.ts` — Subscribe to `decisionMakers`, add `who` query param
- `tests/store/filterStore.test.ts` — Update for new fields

**Deprecated Files:**
- `src/components/organisms/FiltersSidebar.tsx` — Replaced by FilterBar

**Package Dependencies:**
- Shadcn/ui: `npx shadcn-ui@latest add popover` (for filter dropdowns)
- Shadcn/ui: `npx shadcn-ui@latest add drawer` (for mobile filter panel)

---

## Testing Strategy

### Unit Tests

```
Test coverage areas:
- ✅ FilterBar rendering (search + 3 buttons)
- ✅ Discipline popover toggle
- ✅ Date range popover inputs
- ✅ Who popover dynamic list
- ✅ Active filter chips rendering
- ✅ Chip removal
- ✅ Clear all button
- ✅ Active filter count
- ✅ Search input debounce (300ms)
- ✅ URL persistence
- ✅ Mobile drawer
```

### Performance Testing

```bash
# Measure filter update time
# Target: <200ms from filter change to UI update
```

### Coverage Target

- Minimum: 80%
- Target: 90%+
- Run: `npm run test -- --coverage`

---

## UX Design System References

**Primary Documentation:**
- `docs/ux/FRONTEND-SPEC-timeline-redesign-v2.md` — **Authoritative design spec for v2 redesign** (Section 4.3)
- `docs/ux/RESEARCH-AND-DESIGN-SYSTEM-ANALYSIS.md` — Part 2: Insight 3 "Discipline-First Mental Model"
- `docs/ux/RESEARCH-AND-DESIGN-SYSTEM-ANALYSIS.md` — Part 2: Insight 2 "Digest vs. Deep Dive Split"
- `docs/ux/REQUIREMENTS-TRANSLATION-GUIDE.md` — Story 3.6 example
- `docs/ux/AIOS-WORKFLOW-INTEGRATION.md` — Component architecture patterns

**Shadcn/ui Components Used:**
- Popover: https://ui.shadcn.com/docs/components/popover
- Checkbox: https://ui.shadcn.com/docs/components/checkbox
- Input: https://ui.shadcn.com/docs/components/input
- Label: https://ui.shadcn.com/docs/components/label
- Badge: https://ui.shadcn.com/docs/components/badge
- Button: https://ui.shadcn.com/docs/components/button
- Drawer: https://ui.shadcn.com/docs/components/drawer (for mobile)

**Design Rationale (v2):**
- **Why inline filter bar?** Gabriela said sidebar is too big; horizontal bar gives full width to timeline
- **Why popovers?** Clean, on-demand filters — space-efficient, modern pattern (Linear/Notion)
- **Why Who filter?** Gabriela explicitly requested filtering by decision maker
- **Why no Meeting Type?** Not requested for MVP; deferred to keep interface minimal
- **Why active chips?** Visual confirmation of applied filters, quick removal
- **Why bottom sheet on mobile?** Better mobile UX than side drawer, standard pattern

---

## Change Log

| Date | Change |
|------|--------|
| 2026-02-08 | Created story (v1 — Filters & Search Sidebar) |
| 2026-02-08 | Updated with UX design system guidelines (Shadcn/ui, Atomic Design, Discipline-First, mobile drawer, WCAG AA) |
| 2026-02-08 | **v2 REDESIGN:** Client feedback from Gabriela — replaced sidebar with horizontal FilterBar, added Who (decision maker) filter, removed Meeting Type and Anomalies filters, switched to popover-based dropdowns, added active filter chips, updated all acceptance criteria per `FRONTEND-SPEC-timeline-redesign-v2.md` |

---

**Related Stories:** 3.1 (Frontend Setup), 3.5 (Timeline — co-dependent), 3.9 (API Endpoints), 3.10 (Responsive Design)
**Blocked By:** 3.1 (Frontend Setup)
**Co-dependent:** 3.5 (FilterBar and Timeline share ProjectDetail.tsx layout changes)
**Blocks:** None (enhances Timeline usability)
