# Story 4.1: User Management Database Schema

**Story ID:** 4.1
**Assigned to:** @dev
**Sprint:** Sprint 6 (Week 8)
**Status:** Draft
**Estimation:** 3 story points (1-2 days)

---

## Summary

Design and implement user management database schema with users table (email, password_hash, name, role), user_projects table for project access control, and audit fields for security tracking.

---

## Acceptance Criteria

- [ ] `users` table created with:
  - [ ] id (UUID primary key)
  - [ ] email (unique, not null)
  - [ ] password_hash (bcrypt, not null)
  - [ ] name (not null)
  - [ ] role CHECK constraint (director, architect, client)
  - [ ] created_at, last_login_at (timestamps)
  - [ ] deleted_at (soft delete)
- [ ] `user_projects` table created with:
  - [ ] user_id, project_id (composite primary key)
  - [ ] role_in_project (owner, member, viewer)
  - [ ] created_at
- [ ] Indexes created:
  - [ ] idx_users_email
  - [ ] idx_users_role
  - [ ] idx_user_projects_user
- [ ] Alembic migration tested (upgrade/downgrade)
- [ ] Seed data script for test users
- [ ] Tests passing: `pytest tests/unit/test_user_schema.py`

---

## Tasks

### Task 1: Create Users Table Migration (0.5 days)

```sql
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email VARCHAR(255) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  name VARCHAR(255) NOT NULL,
  role VARCHAR(50) NOT NULL CHECK (role IN ('director', 'architect', 'client')),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  last_login_at TIMESTAMP WITH TIME ZONE,
  deleted_at TIMESTAMP WITH TIME ZONE
);

CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_role ON users(role);
CREATE INDEX idx_users_deleted ON users(deleted_at) WHERE deleted_at IS NULL;
```

### Task 2: Create User Projects Table (0.25 days)

```sql
CREATE TABLE user_projects (
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  project_id UUID NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
  role_in_project VARCHAR(50) NOT NULL CHECK (role_in_project IN ('owner', 'member', 'viewer')),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  PRIMARY KEY (user_id, project_id)
);

CREATE INDEX idx_user_projects_user ON user_projects(user_id);
CREATE INDEX idx_user_projects_project ON user_projects(project_id);
```

### Task 3: Create SQLAlchemy Models (0.5 days)

```python
# app/models/user.py
from sqlalchemy import Column, String, DateTime, Enum, CheckConstraint
from app.database import Base
import uuid

class User(Base):
    __tablename__ = "users"

    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    email = Column(String(255), unique=True, nullable=False)
    password_hash = Column(String(255), nullable=False)
    name = Column(String(255), nullable=False)
    role = Column(String(50), nullable=False)
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    last_login_at = Column(DateTime(timezone=True))
    deleted_at = Column(DateTime(timezone=True))

    __table_args__ = (
        CheckConstraint(role.in_(['director', 'architect', 'client']), name='role_check'),
    )

class UserProject(Base):
    __tablename__ = "user_projects"

    user_id = Column(UUID(as_uuid=True), ForeignKey('users.id'), primary_key=True)
    project_id = Column(UUID(as_uuid=True), ForeignKey('projects.id'), primary_key=True)
    role_in_project = Column(String(50), nullable=False)
    created_at = Column(DateTime(timezone=True), server_default=func.now())

    __table_args__ = (
        CheckConstraint(role_in_project.in_(['owner', 'member', 'viewer']), name='role_in_project_check'),
    )
```

### Task 4: Create Seed Data Script (0.25 days)

```python
# scripts/seed_users.py
from app.database import SessionLocal
from app.models.user import User, UserProject
from app.utils.password import hash_password

def seed_users():
    db = SessionLocal()
    
    # Create test users
    gabriela = User(
        email="gabriela@soubim.com",
        password_hash=hash_password("password"),
        name="Gabriela",
        role="director"
    )
    
    architect = User(
        email="architect@soubim.com",
        password_hash=hash_password("password"),
        name="Test Architect",
        role="architect"
    )
    
    db.add_all([gabriela, architect])
    db.commit()
```

### Task 5: Write Tests (0.5 days)

```python
# tests/unit/test_user_schema.py
def test_user_table_exists(db):
    result = db.execute("SELECT tablename FROM pg_tables WHERE tablename='users'")
    assert result.scalar() == 'users'

def test_create_user(db):
    user = User(
        email="test@example.com",
        password_hash="hashed",
        name="Test User",
        role="architect"
    )
    db.add(user)
    db.commit()
    assert user.id is not None

def test_email_unique_constraint(db):
    user1 = User(email="test@example.com", password_hash="hash", name="User 1", role="architect")
    user2 = User(email="test@example.com", password_hash="hash", name="User 2", role="architect")
    db.add(user1)
    db.commit()
    db.add(user2)
    with pytest.raises(IntegrityError):
        db.commit()
```

---

## File List

**Modified/Created:**
- `alembic/versions/00X_add_user_tables.py` (new)
- `app/models/user.py` (new)
- `scripts/seed_users.py` (new)
- `tests/unit/test_user_schema.py` (new)

---

**Related Stories:** 4.2 (JWT Authentication)
**Blocked By:** None
**Blocks:** 4.2, 4.3, 4.4, 4.5
