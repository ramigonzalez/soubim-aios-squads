# Story 3.7: Decision Drill-Down Modal

**Story ID:** 3.7
**Assigned to:** @dev
**Sprint:** Sprint 5 (Week 7)
**Status:** Draft
**Estimation:** 8 story points (3-4 days)

---

## Summary

Create a detailed decision drill-down modal that opens when clicking a decision card, showing full context including transcript excerpt, similar past decisions, consistency notes, anomaly flags, and navigation controls.

---

## UX Research Context

This story implements **deep transparency into decision reasoning** and directly supports:

**Research Insight 1: Trust Through Transparency ⭐ (Primary)**
- **Critical Finding:** Architects need **full visibility into decision reasoning** to build decision-making autonomy
- Current pain point: *"I don't understand why past decisions were made"*
- Solution: Drill-down modal with **complete decision context:**
  - Full "Why" reasoning (2-3 sentences explaining rationale)
  - Transcript excerpt (5-10 min context around decision moment)
  - Similar past decisions (learn from precedent, consistency)
  - Consensus breakdown (who agreed/disagreed, by discipline)
  - Impacts (timeline, scope, budget changes)
  - Confidence score + explanation (how certain is this decision?)
  - Anomaly flags (warnings if decision seems unusual)
- **Goal:** Architects can make similar future decisions **independently** by learning from past reasoning

**Research Insight 2: Digest vs. Deep Dive Split**
- This is the **"Deep Dive"** feature for Architects
- Gabriela (Director) may rarely open drill-down (relies on Executive Digest, Story 3.8)
- Architects open drill-down **frequently** to understand nuances and learn

**Research Insight 4: Mobile-First for Gabriela During Maternity**
- Modal must work on **iPad and mobile**
- **Desktop:** Centered modal (max-width 900px, 90% viewport height)
- **Tablet:** 95% width, scrollable content
- **Mobile:** Full-screen modal (100% width/height), touch-friendly close button
- Close button ≥44px tap area on mobile

**Design System: Shadcn/ui Dialog + Tabs Components**
- **Dialog:** Modal container with overlay, focus trap, Escape key handling (Shadcn/ui)
- **Tabs:** Three sections: Overview | Transcript | Similar Decisions
- **Alert:** For anomaly flags (variant=destructive)
- **Badge:** For discipline, consensus, confidence, impacts
- **Separator:** Visual breaks between sections

**Component Architecture: Atomic Design**
- **Organism:** DrillDownModal (complex modal with multiple sections, data fetching)
- **Molecules:** TranscriptExcerpt (transcript display with highlighting), SimilarDecisionCard (similar decision preview)
- **Atoms:** Dialog, Tabs, Badge, Alert, Button, Separator (from Shadcn/ui)

**User Flow:**
1. User scans Timeline (Story 3.5), sees decision card
2. Clicks decision card → DrillDownModal opens
3. **Overview Tab:** Reads decision statement, why reasoning, impacts, consensus
4. Sees anomaly flags (if any): *"High dissent from MEP team"*
5. **Transcript Tab:** Reads 5-10 min transcript excerpt, sees exact decision moment highlighted
6. Hears speaker voices in their mind (speaker names in discipline colors)
7. **Similar Decisions Tab:** Sees 3-5 similar past decisions with similarity scores
8. Clicks similar decision → Modal updates to show that decision (navigation)
9. Closes modal (Escape key or X button) → Returns to Timeline
10. **Result:** Architect **understands full context**, builds confidence to make similar decisions independently

**Performance Requirements:**
- Modal opens: <1 second (from click to full content visible)
- Smooth scroll: 60 fps within modal content
- No layout shift: CLS <0.1 (content loads without jumpy layout)

**Reference:** `docs/ux/RESEARCH-AND-DESIGN-SYSTEM-ANALYSIS.md` (Part 2: Insight 1 "Trust Through Transparency")
**Detailed Example:** `docs/ux/AIOS-WORKFLOW-INTEGRATION.md` → Step 2 (Complete story file example for this story)

---

## Acceptance Criteria

### Modal Component & Structure
- [ ] Use Shadcn/ui `Dialog` component (DialogContent, DialogHeader, DialogTitle, DialogDescription)
- [ ] Use Shadcn/ui `Tabs` component (TabsList, TabsTrigger, TabsContent) with 3 tabs:
  - [ ] **Overview** tab (default active) - Decision details, impacts, consensus
  - [ ] **Transcript** tab - Transcript excerpt with highlighting
  - [ ] **Similar** tab - Similar past decisions
- [ ] Modal opens on decision card click (triggered from Timeline, Story 3.5)
- [ ] Modal closes via:
  - [ ] X button (top-right, Shadcn/ui DialogClose)
  - [ ] Escape key (Shadcn/ui Dialog built-in)
  - [ ] Clicking backdrop overlay (Shadcn/ui Dialog built-in)
- [ ] Focus trapped within modal when open (Shadcn/ui Dialog built-in)

### Overview Tab - Decision Details Section (UX Insight 1: Full Transparency)
- [ ] **Modal Title:** Decision statement (DialogTitle, text-2xl font-bold)
- [ ] **Subtitle:** "By {who} at {timestamp}" (text-sm text-gray-600)
- [ ] **Discipline badge:** Prominent badge with discipline color (Shadcn/ui Badge, Tailwind `discipline-*` colors)
- [ ] **Full "Why" reasoning:**
  - [ ] Heading: "Why this decision was made"
  - [ ] Full reasoning text (2-3 sentences, text-base)
  - [ ] Displayed prominently (not truncated)
- [ ] **Causation:**
  - [ ] Label: "What triggered this decision"
  - [ ] Causation text (e.g., "Client requirement", "Code violation")
- [ ] **Impacts section:**
  - [ ] Heading: "What changed"
  - [ ] List of impacts (timeline, scope, budget)
  - [ ] Each impact shows type + change description
  - [ ] Impact badges with colors (Tailwind `impact-high/medium/low`)
- [ ] **Consensus breakdown:**
  - [ ] Heading: "Team consensus"
  - [ ] Per-discipline breakdown: "Architecture: AGREE", "MEP: MIXED", "Structural: AGREE"
  - [ ] Consensus badges with colors (Tailwind `consensus-agree/mixed/dissent`)
  - [ ] Visual indicator (colored badges or pills)
- [ ] **Confidence score:**
  - [ ] Label: "Confidence score"
  - [ ] Percentage display (e.g., "92% confidence")
  - [ ] Explanation/breakdown: Consensus + Consistency + Historical (if available)
  - [ ] Badge with percentage (Shadcn/ui Badge, variant=outline)
- [ ] **Consistency notes:**
  - [ ] Heading: "Consistency with past decisions"
  - [ ] Consistency score (e.g., "87% consistent")
  - [ ] Notes: "Aligns with Decision #3..." or "Contradicts Decision #12..."
  - [ ] Helps Architects understand precedent

### Overview Tab - Anomaly Flags (Conditional)
- [ ] **Anomaly flags section** (only if `anomaly_flags.length > 0`):
  - [ ] Shadcn/ui `Alert` component (variant=destructive for warnings)
  - [ ] Heading: "⚠ Anomaly flags"
  - [ ] List of flags with type, severity, description
  - [ ] Example: "High dissent - MEP team strongly disagreed (severity: medium)"
  - [ ] Color-coded by severity: high=red, medium=amber, low=gray

### Transcript Tab - Transcript Excerpt Viewer (UX Insight 1: Transparency)
- [ ] **Transcript excerpt section:**
  - [ ] Heading: "Meeting transcript excerpt"
  - [ ] Description: "5-10 minute context around this decision"
  - [ ] Transcript text displayed with formatting:
    - [ ] Speaker prefixes: "{Speaker name}: {dialogue}"
    - [ ] Speaker names in **discipline colors** (Tailwind `discipline-*` classes)
    - [ ] Example: <span className="text-discipline-architecture">Carlos (Architecture)</span>: "I think we should..."
  - [ ] **Decision moment highlighted:**
    - [ ] Exact line where decision was made
    - [ ] Amber background (`bg-amber-50`) with left border (`border-l-4 border-amber-400`)
    - [ ] Example: <div className="bg-amber-50 border-l-4 border-amber-400 p-3">{highlighted line}</div>
  - [ ] Timestamps for each speaker line (HH:MM:SS format)
- [ ] **Link to full transcript:**
  - [ ] Button: "View full transcript" (Shadcn/ui Button, variant=outline)
  - [ ] Opens full transcript in new tab
  - [ ] Target: `/transcripts/{meeting_id}` (opens full meeting transcript, Story 3.9 or Phase 2)

### Similar Decisions Tab - Similar Past Decisions (UX Insight 1: Learn from Precedent)
- [ ] **Similar decisions section:**
  - [ ] Heading: "Similar past decisions"
  - [ ] Description: "Decisions from this project with similar context"
  - [ ] Display 3-5 similar decisions from SAME PROJECT:
    - [ ] Similarity score for each (e.g., "94% similar")
    - [ ] Decision statement (truncated to 2 lines)
    - [ ] Who made decision + timestamp
    - [ ] Discipline badge
  - [ ] Each similar decision is clickable:
    - [ ] Click similar decision → Modal updates to show that decision
    - [ ] Navigation within modal (smooth transition)
    - [ ] Back button to return to original decision (optional Phase 2)
- [ ] **Empty state** if no similar decisions:
  - [ ] Message: "No similar decisions found in project history"
  - [ ] Icon + text (Calendar or FileText from lucide-react)

### Responsive Design (UX Insight 4: Mobile-First)
- [ ] **Desktop (1024px+):**
  - [ ] Modal: Max-width 900px, centered on screen
  - [ ] Max-height: 90vh (90% viewport height)
  - [ ] Content scrollable if overflow (DialogContent has `overflow-y-auto`)
  - [ ] Padding: p-6 (24px)
- [ ] **Tablet (768px-1023px):**
  - [ ] Modal: 95% width
  - [ ] Max-height: 90vh
  - [ ] Content scrollable
  - [ ] Padding: p-6
- [ ] **Mobile (375px-767px):**
  - [ ] Modal: Full screen (100% width, 100% height)
  - [ ] Content scrollable (full height with scroll)
  - [ ] Close button: Top-right, ≥44px tap area
  - [ ] Padding: p-4 (16px)
  - [ ] Tabs: Full width, stacked or scrollable tab list

### Performance (UX Success Metric)
- [ ] Modal opens in <1 second (from click to full content visible)
- [ ] Smooth scroll within modal: 60 fps
- [ ] No layout shift: CLS <0.1 (content doesn't jump)
- [ ] React Query caching: Decision details cached, refetch if stale

### Accessibility (WCAG 2.1 AA)
- [ ] Semantic HTML:
  - [ ] `<dialog>` (via Shadcn/ui Dialog component)
  - [ ] Proper heading hierarchy (`<h2>`, `<h3>` for sections)
  - [ ] `<section>` for logical content groups
- [ ] ARIA attributes:
  - [ ] `aria-modal="true"` (Shadcn/ui Dialog default)
  - [ ] `aria-labelledby` pointing to DialogTitle (Shadcn/ui default)
  - [ ] `aria-describedby` pointing to DialogDescription (Shadcn/ui default)
  - [ ] Tab panels: `role="tabpanel"` (Shadcn/ui Tabs default)
- [ ] Keyboard navigation:
  - [ ] Escape key closes modal (Shadcn/ui Dialog built-in)
  - [ ] Tab through interactive elements (tabs, buttons, links)
  - [ ] Arrow keys to switch tabs (Shadcn/ui Tabs built-in)
  - [ ] Focus trapped within modal (Shadcn/ui Dialog built-in)
  - [ ] Focus returns to trigger element on close (Shadcn/ui Dialog built-in)
- [ ] Focus visible styles (Shadcn/ui default focus ring)
- [ ] Color contrast ≥4.5:1 for all text
- [ ] Screen reader friendly:
  - [ ] Decision details read in logical order
  - [ ] Tab labels announced
  - [ ] Anomaly flags announced with severity

### Testing
- [ ] Unit tests >80% coverage:
  - [ ] Modal opens on decision card click
  - [ ] Modal closes via X button, Escape key, backdrop click
  - [ ] Decision details display correctly (all fields present)
  - [ ] Transcript excerpt displays with speaker colors
  - [ ] Similar decisions display with similarity scores
  - [ ] Anomaly flags display conditionally
  - [ ] Tab switching works (Overview, Transcript, Similar)
- [ ] Integration test: Fetch decision → Display in modal
- [ ] Accessibility test: Keyboard navigation, screen reader
- [ ] Responsive test: Desktop (900px), Tablet (95%), Mobile (full screen)

---

## Tasks

### Task 1: Create Modal Component (1.5 days)

Create `src/components/DrillDownModal.tsx` with full decision detail display, transcript excerpt highlighting, similar decisions list, and keyboard navigation support.

### Task 2: Fetch Decision Detail (0.5 days)

Integrate with `GET /decisions/{id}` endpoint using React Query, handle loading states, and implement error recovery.

### Task 3: Add Transcript Excerpt Viewer (0.75 days)

Display transcript excerpt with timestamp highlighting, speaker identification, and context window (5-10 minutes around decision).

### Task 4: Similar Decisions Display (0.5 days)

Show similar decisions with similarity scores, clickable navigation to related decisions, and visual similarity indicator.

### Task 5: Write Tests (0.75 days)

Test modal rendering, keyboard navigation, decision detail loading, similar decisions display, and accessibility (focus trap, escape key).

---

## Dev Notes

### Modal Architecture (Atomic Design + Shadcn/ui)

```
DrillDownModal (Organism)
├── Dialog (Shadcn/ui)
│   ├── DialogOverlay (dark backdrop, click to close)
│   ├── DialogContent (max-w-[900px] centered on desktop, full screen on mobile)
│   │   ├── DialogHeader
│   │   │   ├── DialogTitle: Decision Statement (text-2xl font-bold)
│   │   │   ├── DialogDescription: "By {who} at {timestamp}"
│   │   │   └── DialogClose (X button, top-right)
│   │   │
│   │   ├── Tabs (Shadcn/ui)
│   │   │   ├── TabsList (Overview | Transcript | Similar)
│   │   │   │
│   │   │   ├── TabsContent: "Overview" (default active)
│   │   │   │   ├── Discipline Badge (Shadcn/ui Badge, discipline color)
│   │   │   │   ├── "Why" Section
│   │   │   │   │   ├── Heading: "Why this decision was made"
│   │   │   │   │   └── Reasoning text (2-3 sentences)
│   │   │   │   ├── "Causation" Section
│   │   │   │   │   ├── Label: "What triggered this"
│   │   │   │   │   └── Causation text
│   │   │   │   ├── "Impacts" Section
│   │   │   │   │   ├── Heading: "What changed"
│   │   │   │   │   └── Impact list (timeline/scope/budget)
│   │   │   │   │       └── Impact badges (Tailwind impact-* colors)
│   │   │   │   ├── "Consensus" Section
│   │   │   │   │   ├── Heading: "Team consensus"
│   │   │   │   │   └── Per-discipline breakdown
│   │   │   │   │       └── Consensus badges (Tailwind consensus-* colors)
│   │   │   │   ├── "Confidence" Section
│   │   │   │   │   ├── Label: "Confidence score"
│   │   │   │   │   ├── Percentage display (e.g., "92%")
│   │   │   │   │   └── Explanation (consensus + consistency + historical)
│   │   │   │   ├── "Consistency" Section
│   │   │   │   │   ├── Heading: "Consistency with past"
│   │   │   │   │   ├── Consistency score (e.g., "87%")
│   │   │   │   │   └── Notes: "Aligns with..." or "Contradicts..."
│   │   │   │   └── Anomaly Flags (conditional)
│   │   │   │       └── Alert (Shadcn/ui, variant=destructive)
│   │   │   │           └── List of anomaly flags (type, severity, description)
│   │   │   │
│   │   │   ├── TabsContent: "Transcript"
│   │   │   │   ├── Heading: "Meeting transcript excerpt"
│   │   │   │   ├── Description: "5-10 minute context"
│   │   │   │   ├── TranscriptExcerpt (Molecule)
│   │   │   │   │   ├── Speaker lines (speaker name in discipline color)
│   │   │   │   │   ├── Decision moment (highlighted with amber background)
│   │   │   │   │   └── Timestamps (HH:MM:SS)
│   │   │   │   └── Button: "View full transcript" (opens new tab)
│   │   │   │
│   │   │   └── TabsContent: "Similar"
│   │   │       ├── Heading: "Similar past decisions"
│   │   │       ├── Description: "From this project"
│   │   │       ├── SimilarDecisionCard (Molecule) [repeating, 3-5 cards]
│   │   │       │   ├── Similarity score (e.g., "94% similar")
│   │   │       │   ├── Decision statement (truncated)
│   │   │       │   ├── Who + timestamp
│   │   │       │   ├── Discipline badge
│   │   │       │   └── Clickable (navigate to that decision)
│   │   │       └── Empty state (if no similar decisions)
│   │   │
│   │   └── Focus Trap (Shadcn/ui Dialog built-in)
│   │       └── Tab, Escape key handling
│
└── Data Fetching (React Query)
    └── useQuery(['decision', decisionId])
```

**Component File Locations:**
- `src/components/organisms/DrillDownModal.tsx` - Main modal organism
- `src/components/molecules/TranscriptExcerpt.tsx` - Transcript display with highlighting
- `src/components/molecules/SimilarDecisionCard.tsx` - Similar decision preview card
- `src/hooks/useDecisionDetail.ts` - React Query hook for fetching decision details
- `src/components/atoms/` - Shadcn/ui (Dialog, Tabs, Badge, Alert, Button, Separator)

### API Integration

```typescript
// src/hooks/useDecisionDetail.ts
import { useQuery } from '@tanstack/react-query'
import { api } from '../services/api'

export function useDecisionDetail(decisionId: string | null) {
  return useQuery({
    queryKey: ['decision', decisionId],
    queryFn: () => api.getDecision(decisionId!),
    enabled: !!decisionId,
    staleTime: 5 * 60 * 1000, // 5 minutes
  })
}

// Usage in DrillDownModal
const { data: decision, isLoading, isError } = useDecisionDetail(decisionId)
```

**API Response Structure (from Backend):**
```json
{
  "id": "uuid",
  "decision_statement": "Changed material from concrete to steel",
  "who": "Carlos",
  "timestamp": "00:23:15",
  "discipline": "Architecture",
  "meeting_type": "client",
  "meeting_date": "2026-02-01T14:00:00Z",
  "why": "Client requested more sustainable material with lower carbon footprint",
  "causation": "client requirement",
  "impacts": [
    { "type": "timeline", "change": "+2 weeks for steel fabrication" },
    { "type": "budget", "change": "+$15,000 for steel vs concrete" }
  ],
  "consensus": {
    "Architecture": "AGREE",
    "MEP": "AGREE",
    "Structural": "MIXED"
  },
  "confidence": 0.92,
  "confidence_breakdown": {
    "consensus": 0.95,
    "consistency": 0.87,
    "historical": 0.94
  },
  "consistency_score": 0.87,
  "consistency_notes": "Aligns with Decision #3 (sustainable materials policy)",
  "anomaly_flags": [
    {
      "type": "high_dissent",
      "severity": "medium",
      "description": "Structural team expressed concerns about steel availability"
    }
  ],
  "transcript_excerpt": "Carlos: I think we should switch to steel...\nMaria (MEP): That makes sense for sustainability...\n[DECISION: Changed material to steel]\nJohn (Structural): I have concerns about lead time...",
  "similar_decisions": [
    {
      "id": "uuid-2",
      "statement": "Switched to eco-friendly paint",
      "similarity_score": 0.94,
      "who": "Sarah",
      "timestamp": "00:12:34",
      "discipline": "Architecture"
    }
  ]
}
```

---

## File List

**Modified/Created (Atomic Design Structure):**
- `src/components/organisms/DrillDownModal.tsx` (new) - Main modal organism with Tabs
- `src/components/molecules/TranscriptExcerpt.tsx` (new) - Transcript display with highlighting
- `src/components/molecules/SimilarDecisionCard.tsx` (new) - Similar decision preview card
- `src/hooks/useDecisionDetail.ts` (new) - React Query hook for decision details API
- `src/components/organisms/Timeline.tsx` (modify) - Trigger modal on card click, pass decisionId
- `tests/components/DrillDownModal.test.tsx` (new) - Modal component tests
- `tests/components/TranscriptExcerpt.test.tsx` (new) - Transcript component tests
- `tests/components/SimilarDecisionCard.test.tsx` (new) - Similar card tests
- `package.json` (verify) - Ensure Shadcn/ui dialog, tabs installed

---

## Testing Strategy

- ✅ Modal open/close
- ✅ Decision detail display
- ✅ Transcript excerpt rendering
- ✅ Similar decisions navigation
- ✅ Keyboard shortcuts (Escape, Arrow keys)
- ✅ Accessibility (ARIA labels, focus management)

---

## UX Design System References

**Primary Documentation:**
- `docs/ux/RESEARCH-AND-DESIGN-SYSTEM-ANALYSIS.md` - **Part 2: Insight 1 "Trust Through Transparency"** (PRIMARY)
- `docs/ux/AIOS-WORKFLOW-INTEGRATION.md` - **Step 2: Complete example story file for 3.7** (Detailed template!)
- `docs/ux/REQUIREMENTS-TRANSLATION-GUIDE.md` - Story 3.7 example (Drill-Down Modal)
- Story 3.1 - Tailwind config with discipline/consensus/impact colors

**Key Sections:**
- User Persona 2 (Architects): `RESEARCH-AND-DESIGN-SYSTEM-ANALYSIS.md` → Part 1
- Trust Through Transparency: `RESEARCH-AND-DESIGN-SYSTEM-ANALYSIS.md` → Insight 1
- Complete Story Template: `AIOS-WORKFLOW-INTEGRATION.md` → Step 2 (3.7 example)
- Responsive Modal Patterns: Story 3.10 (Responsive Design)

**Shadcn/ui Components Used:**
- Dialog: https://ui.shadcn.com/docs/components/dialog (Modal container, overlay, close button)
- Tabs: https://ui.shadcn.com/docs/components/tabs (Overview | Transcript | Similar sections)
- Badge: https://ui.shadcn.com/docs/components/badge (Discipline, consensus, confidence badges)
- Alert: https://ui.shadcn.com/docs/components/alert (Anomaly flags warnings)
- Button: https://ui.shadcn.com/docs/components/button ("View full transcript" link)
- Separator: https://ui.shadcn.com/docs/components/separator (Visual breaks between sections)

**Design Rationale:**
- **Why drill-down modal?** Architects need full decision context to build autonomy (UX Insight 1)
- **Why transcript excerpt?** Shows exact decision moment, captures nuance of discussion
- **Why similar decisions?** Learn from precedent, understand consistency, build confidence
- **Why consensus breakdown?** Transparency into who agreed/disagreed, by discipline
- **Why anomaly flags?** Highlight unusual decisions requiring extra scrutiny
- **Why tabs?** Organize dense information, progressive disclosure (Overview first, deeper details in other tabs)
- **Why full-screen on mobile?** More screen space for dense content on small screens (UX Insight 4)
- **Why speaker colors?** Quick visual scanning by discipline (same as Timeline discipline badges)

---

## Change Log

| Date | Change |
|------|--------|
| 2026-02-08 | Created story |
| 2026-02-08 | Updated with UX design system guidelines (Shadcn/ui Dialog/Tabs, Atomic Design, Insight 1 Trust Through Transparency, mobile-first, WCAG AA) |

---

**Related Stories:** 3.1 (Frontend Setup), 3.5 (Timeline - triggers modal), 3.9 (API Endpoints), 3.10 (Responsive Design)
**Blocked By:** 3.1 (Frontend Setup), 3.5 (Timeline component triggers modal)
**Blocks:** None (enhances Timeline with deep transparency)
