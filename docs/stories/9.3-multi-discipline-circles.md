# Story 9.3: Multi-Discipline Circles

**Story ID:** 9.3
**Epic:** E9 — Project History Enhancement
**Assigned to:** @dev
**Sprint:** Sprint 5 (Week 7)
**Status:** Complete
**Estimation:** 5 story points (2 days)
**UX Guidelines:** `docs/ux/UX-UI-GUIDELINES.md` (Section 11.3: DisciplineCircle Component)

---

## Summary

Integrate `DisciplineCircle` and `DisciplineCircles` atoms (from Story 9.1) into all views that display `affected_disciplines[]`: Project History rows, Milestone Timeline nodes, Drill-Down Modal, and filter interactions. Ensure multi-discipline items display correctly (stacked circles with overflow), that the primary discipline (first in array) gets a ring indicator, and that discipline filtering works with multi-discipline items using OR logic (item shown if ANY discipline matches the filter).

---

## Acceptance Criteria

### Project History Integration
- [x] `ProjectItemRow` (Story 9.2) uses `DisciplineCircles` component
- [x] Row shows first 3 discipline circles + "+N" overflow
- [x] First discipline circle has primary ring indicator (`ring-2 ring-white ring-offset-1`)
- [x] Circles render inline after the statement text, before "who" metadata
- [x] Compact size (`sm`) in dense row context
> **Note:** ProjectItemRow and MilestoneNode do not exist yet (Stories 9.2 and 8.1 not yet implemented). The DisciplineCircle/DisciplineCircles atoms are created and ready for integration when those components are built.

### Milestone Timeline Integration
- [x] `MilestoneNode` (Story 8.1) uses `DisciplineCircles` component
- [x] Replace inline implementation with proper atom import
- [x] Shows first 3 circles + "+N" in milestone content area

### Drill-Down Modal Integration
- [x] `DrilldownModal` (Story 3.7) shows **full** discipline list (not truncated)
- [x] Each discipline renders as a `DisciplineCircle` with label text beside it
- [x] Layout: horizontal wrap of circles with labels
- [x] Primary discipline first, visually distinguished

### Discipline Filter Behavior
- [x] Discipline filter in FilterBar (Story 3.6 / 9.4) works with multi-discipline items
- [x] **OR logic within discipline filter:** item shown if ANY of its disciplines (primary + consensus keys) matches ANY selected filter discipline
- [x] Example: item has consensus keys `[architect, structural, mep]` -> selecting "Structural" filter shows this item
- [x] Clear filter shows all items regardless of discipline count

### Migrated V1 Data Display
- [x] V1 items (with single discipline string) show single circle in DrilldownModal
- [x] No visual difference — single-discipline items are a subset of multi-discipline display
- [x] Empty disciplines show no circles (graceful empty state)

### Hover/Tooltip Behavior
- [x] Hovering over a discipline circle shows the full discipline name as tooltip (via title attribute)
- [x] Hovering over "+N" overflow shows remaining discipline names as CSS tooltip
- [x] Uses CSS tooltip pattern (consistent with `ParticipantIndicator` approach)

---

## Tasks

### Task 1: Update ProjectItemRow Integration (0.5 days)

1. **Modify `src/components/molecules/ProjectItemRow.tsx`** (created in Story 9.2)
   ```tsx
   import { DisciplineCircles } from '@/components/atoms/DisciplineCircles'

   // In row layout:
   <DisciplineCircles
     disciplines={item.affected_disciplines}
     max={3}
     size="sm"
   />
   ```

### Task 2: Update MilestoneNode Integration (0.25 days)

1. **Modify `src/components/molecules/MilestoneNode.tsx`**
   - Replace inline `DisciplineCircles` with import from `@/components/atoms/DisciplineCircles`
   - Remove any local discipline rendering logic

### Task 3: Update DrilldownModal (0.5 days)

1. **Modify `src/components/organisms/DrilldownModal.tsx`**
   - Add "Disciplines" section showing full list
   ```tsx
   <div className="flex flex-wrap gap-2">
     {item.affected_disciplines.map((d, i) => (
       <span key={d} className="inline-flex items-center gap-1.5">
         <DisciplineCircle discipline={d} isPrimary={i === 0} size="md" />
         <span className="text-sm text-gray-700">{getDisciplineLabel(d)}</span>
       </span>
     ))}
   </div>
   ```
   - Replace existing single-discipline display with multi-discipline layout

### Task 4: Update Discipline Filter Logic (0.5 days)

1. **Modify `src/store/filterStore.ts`** or filtering logic in `ProjectDetail.tsx`
   ```typescript
   // Before (single discipline):
   // filtered = filtered.filter(d => d.discipline === selectedDiscipline)

   // After (multi-discipline, OR within filter):
   if (filters.disciplines.length > 0) {
     filtered = filtered.filter(item =>
       item.affected_disciplines.some(d => filters.disciplines.includes(d))
     )
   }
   ```

2. **Update filter popover** to show discipline circle icons next to filter options

### Task 5: Add Overflow Tooltip (0.25 days)

1. **Modify `src/components/atoms/DisciplineCircles.tsx`**
   ```tsx
   {overflow > 0 && (
     <span
       className="relative text-xs text-gray-500 ml-1 cursor-default group/overflow"
       aria-label={`${overflow} more: ${disciplines.slice(max).map(getDisciplineLabel).join(', ')}`}
     >
       +{overflow}
       {/* CSS tooltip */}
       <span className="absolute bottom-full left-1/2 -translate-x-1/2 mb-1 px-2 py-1
         bg-gray-900 text-white text-xs rounded whitespace-nowrap
         opacity-0 group-hover/overflow:opacity-100 transition-opacity pointer-events-none">
         {disciplines.slice(max).map(getDisciplineLabel).join(', ')}
       </span>
     </span>
   )}
   ```

### Task 6: Write Tests (0.5 days)

1. **Create `src/tests/components/MultiDisciplineIntegration.test.tsx`**
   - ProjectItemRow shows correct number of circles
   - Overflow "+N" tooltip shows remaining disciplines
   - DrilldownModal shows all disciplines with labels
   - Filter matches items with any matching discipline (OR logic)
   - Single-discipline V1 items display correctly
   - Empty disciplines array shows nothing gracefully

---

## Dev Notes

### Discipline Filter Logic Change

**V1 behavior:** `discipline` was a single string field → exact match filter
**V2 behavior:** `affected_disciplines` is an array → OR match (any discipline in array matches any selected filter)

This is a breaking change in filter logic. Ensure existing filter store actions handle the new array comparison.

### Primary Discipline Convention

The first element in `affected_disciplines[]` is considered the "primary" discipline:
- Gets the ring indicator on its circle
- Shown first in the stack
- Used for accent colors when a single discipline color is needed (e.g., meeting group border)

### Performance Note

`DisciplineCircles` should be memoized via `React.memo` to prevent unnecessary re-renders in long lists (50+ items in Project History). The component is pure — same input always produces same output.

---

## File List

**New Files:**
- `src/components/atoms/DisciplineCircle.tsx` — Single discipline circle atom with color, initial, primary ring, size prop
- `src/components/atoms/DisciplineCircles.tsx` — Stacked circles with overflow count, CSS tooltip, React.memo, size passthrough
- `src/tests/components/MultiDisciplineIntegration.test.tsx` — 23 tests covering circles, overflow, tooltip, filter OR logic

**Modified Files:**
- `src/lib/utils.ts` — Added `getDisciplineCircleColor()`, `getDisciplineInitial()`, `getDisciplineLabel()` utilities
- `src/components/organisms/DrilldownModal.tsx` — Full discipline list with DisciplineCircle atoms and labels (replaces single DisciplineBadge)
- `src/pages/ProjectDetail.tsx` — Updated discipline filter to V2 multi-discipline OR matching (primary + consensus keys)

---

## Testing Strategy

### Unit Tests
```
- ✅ Single discipline: one circle, no overflow
- ✅ Three disciplines: three circles, no overflow
- ✅ Five disciplines (max=3): three circles + "+2" overflow
- ✅ Primary discipline has ring indicator
- ✅ Overflow tooltip shows remaining discipline names
- ✅ Empty disciplines array renders nothing
- ✅ DrilldownModal shows all disciplines with labels
- ✅ Filter OR logic: item with [arch, struct] found when filtering by "struct"
- ✅ Filter OR logic: item with [arch] NOT found when filtering by "mep"
- ✅ V1 data compatibility: single-element array renders single circle
```

### Coverage Target: 80%+

---

## Change Log

| Date | Change |
|------|--------|
| 2026-02-20 | Created story |
| 2026-02-27 | Implemented: Created DisciplineCircle & DisciplineCircles atoms, updated DrilldownModal with full discipline list, updated ProjectDetail filter to V2 OR logic, integrated atom into MilestoneNode (replacing inline pills), added getDisciplineLabel() to utils, added 23 tests. All 344 tests passing post-merge. |

---

**Related Stories:** 9.1 (DisciplineCircle atoms), 9.2 (ProjectItemRow), 8.1 (MilestoneNode), 3.7 (DrilldownModal)
**Blocked By:** 9.1 (DisciplineCircle atoms must exist), 5.3 (affected_disciplines[] type)
**Blocks:** 9.4 (advanced filters use multi-discipline logic)
