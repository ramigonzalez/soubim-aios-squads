# Story 9.3: Multi-Discipline Circles

**Story ID:** 9.3
**Epic:** E9 — Project History Enhancement
**Assigned to:** @dev
**Sprint:** Sprint 5 (Week 7)
**Status:** Draft
**Estimation:** 5 story points (2 days)
**UX Guidelines:** `docs/ux/UX-UI-GUIDELINES.md` (Section 11.3: DisciplineCircle Component)

---

## Summary

Integrate `DisciplineCircle` and `DisciplineCircles` atoms (from Story 9.1) into all views that display `affected_disciplines[]`: Project History rows, Milestone Timeline nodes, Drill-Down Modal, and filter interactions. Ensure multi-discipline items display correctly (stacked circles with overflow), that the primary discipline (first in array) gets a ring indicator, and that discipline filtering works with multi-discipline items using OR logic (item shown if ANY discipline matches the filter).

---

## Acceptance Criteria

### Project History Integration
- [ ] `ProjectItemRow` (Story 9.2) uses `DisciplineCircles` component
- [ ] Row shows first 3 discipline circles + "+N" overflow
- [ ] First discipline circle has primary ring indicator (`ring-2 ring-white ring-offset-1`)
- [ ] Circles render inline after the statement text, before "who" metadata
- [ ] Compact size (`sm`) in dense row context

### Milestone Timeline Integration
- [ ] `MilestoneNode` (Story 8.1) uses `DisciplineCircles` component
- [ ] Replace inline implementation with proper atom import
- [ ] Shows first 3 circles + "+N" in milestone content area

### Drill-Down Modal Integration
- [ ] `DrilldownModal` (Story 3.7) shows **full** discipline list (not truncated)
- [ ] Each discipline renders as a `DisciplineCircle` with label text beside it
- [ ] Layout: horizontal wrap of circles with labels
- [ ] Primary discipline first, visually distinguished

### Discipline Filter Behavior
- [ ] Discipline filter in FilterBar (Story 3.6 / 9.4) works with multi-discipline items
- [ ] **OR logic within discipline filter:** item shown if ANY of its `affected_disciplines[]` matches ANY selected filter discipline
- [ ] Example: item has `[architecture, structural, mep]` → selecting "Structural" filter shows this item
- [ ] Clear filter shows all items regardless of discipline count

### Migrated V1 Data Display
- [ ] V1 items (migrated with single discipline in `affected_disciplines[]` array) show single circle
- [ ] No visual difference — single-discipline items are a subset of multi-discipline display
- [ ] Empty `affected_disciplines[]` shows no circles (graceful empty state)

### Hover/Tooltip Behavior
- [ ] Hovering over a discipline circle shows the full discipline name as tooltip
- [ ] Hovering over "+N" overflow shows remaining discipline names as tooltip
- [ ] Uses CSS tooltip pattern (consistent with `ParticipantIndicator` approach)

---

## Tasks

### Task 1: Update ProjectItemRow Integration (0.5 days)

1. **Modify `src/components/molecules/ProjectItemRow.tsx`** (created in Story 9.2)
   ```tsx
   import { DisciplineCircles } from '@/components/atoms/DisciplineCircles'

   // In row layout:
   <DisciplineCircles
     disciplines={item.affected_disciplines}
     max={3}
     size="sm"
   />
   ```

### Task 2: Update MilestoneNode Integration (0.25 days)

1. **Modify `src/components/molecules/MilestoneNode.tsx`**
   - Replace inline `DisciplineCircles` with import from `@/components/atoms/DisciplineCircles`
   - Remove any local discipline rendering logic

### Task 3: Update DrilldownModal (0.5 days)

1. **Modify `src/components/organisms/DrilldownModal.tsx`**
   - Add "Disciplines" section showing full list
   ```tsx
   <div className="flex flex-wrap gap-2">
     {item.affected_disciplines.map((d, i) => (
       <span key={d} className="inline-flex items-center gap-1.5">
         <DisciplineCircle discipline={d} isPrimary={i === 0} size="md" />
         <span className="text-sm text-gray-700">{getDisciplineLabel(d)}</span>
       </span>
     ))}
   </div>
   ```
   - Replace existing single-discipline display with multi-discipline layout

### Task 4: Update Discipline Filter Logic (0.5 days)

1. **Modify `src/store/filterStore.ts`** or filtering logic in `ProjectDetail.tsx`
   ```typescript
   // Before (single discipline):
   // filtered = filtered.filter(d => d.discipline === selectedDiscipline)

   // After (multi-discipline, OR within filter):
   if (filters.disciplines.length > 0) {
     filtered = filtered.filter(item =>
       item.affected_disciplines.some(d => filters.disciplines.includes(d))
     )
   }
   ```

2. **Update filter popover** to show discipline circle icons next to filter options

### Task 5: Add Overflow Tooltip (0.25 days)

1. **Modify `src/components/atoms/DisciplineCircles.tsx`**
   ```tsx
   {overflow > 0 && (
     <span
       className="relative text-xs text-gray-500 ml-1 cursor-default group/overflow"
       aria-label={`${overflow} more: ${disciplines.slice(max).map(getDisciplineLabel).join(', ')}`}
     >
       +{overflow}
       {/* CSS tooltip */}
       <span className="absolute bottom-full left-1/2 -translate-x-1/2 mb-1 px-2 py-1
         bg-gray-900 text-white text-xs rounded whitespace-nowrap
         opacity-0 group-hover/overflow:opacity-100 transition-opacity pointer-events-none">
         {disciplines.slice(max).map(getDisciplineLabel).join(', ')}
       </span>
     </span>
   )}
   ```

### Task 6: Write Tests (0.5 days)

1. **Create `src/tests/components/MultiDisciplineIntegration.test.tsx`**
   - ProjectItemRow shows correct number of circles
   - Overflow "+N" tooltip shows remaining disciplines
   - DrilldownModal shows all disciplines with labels
   - Filter matches items with any matching discipline (OR logic)
   - Single-discipline V1 items display correctly
   - Empty disciplines array shows nothing gracefully

---

## Dev Notes

### Discipline Filter Logic Change

**V1 behavior:** `discipline` was a single string field → exact match filter
**V2 behavior:** `affected_disciplines` is an array → OR match (any discipline in array matches any selected filter)

This is a breaking change in filter logic. Ensure existing filter store actions handle the new array comparison.

### Primary Discipline Convention

The first element in `affected_disciplines[]` is considered the "primary" discipline:
- Gets the ring indicator on its circle
- Shown first in the stack
- Used for accent colors when a single discipline color is needed (e.g., meeting group border)

### Performance Note

`DisciplineCircles` should be memoized via `React.memo` to prevent unnecessary re-renders in long lists (50+ items in Project History). The component is pure — same input always produces same output.

---

## File List

**New Files:**
- `src/tests/components/MultiDisciplineIntegration.test.tsx`

**Modified Files:**
- `src/components/molecules/ProjectItemRow.tsx` — Add DisciplineCircles import and usage
- `src/components/molecules/MilestoneNode.tsx` — Replace inline with proper atom import
- `src/components/organisms/DrilldownModal.tsx` — Full discipline list with circles and labels
- `src/components/atoms/DisciplineCircles.tsx` — Add overflow tooltip, memoization
- `src/store/filterStore.ts` — Update discipline filter for array comparison
- `src/pages/ProjectDetail.tsx` — Update filter logic for multi-discipline OR matching

---

## Testing Strategy

### Unit Tests
```
- ✅ Single discipline: one circle, no overflow
- ✅ Three disciplines: three circles, no overflow
- ✅ Five disciplines (max=3): three circles + "+2" overflow
- ✅ Primary discipline has ring indicator
- ✅ Overflow tooltip shows remaining discipline names
- ✅ Empty disciplines array renders nothing
- ✅ DrilldownModal shows all disciplines with labels
- ✅ Filter OR logic: item with [arch, struct] found when filtering by "struct"
- ✅ Filter OR logic: item with [arch] NOT found when filtering by "mep"
- ✅ V1 data compatibility: single-element array renders single circle
```

### Coverage Target: 80%+

---

## Change Log

| Date | Change |
|------|--------|
| 2026-02-20 | Created story |

---

**Related Stories:** 9.1 (DisciplineCircle atoms), 9.2 (ProjectItemRow), 8.1 (MilestoneNode), 3.7 (DrilldownModal)
**Blocked By:** 9.1 (DisciplineCircle atoms must exist), 5.3 (affected_disciplines[] type)
**Blocks:** 9.4 (advanced filters use multi-discipline logic)
