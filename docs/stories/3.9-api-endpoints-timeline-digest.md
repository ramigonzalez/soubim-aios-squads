# Story 3.9: API Endpoints - Timeline & Digest

**Story ID:** 3.9
**Assigned to:** @dev
**Sprint:** Sprint 5 (Week 7)
**Status:** Draft
**Estimation:** 8 story points (3-4 days)

---

## Summary

Implement backend API endpoints for timeline and digest views: decision listing with filters, decision detail with context, and project digest with categorized summaries. Includes pagination, performance optimization, and comprehensive error handling.

---

## Acceptance Criteria

- [ ] Endpoint: `GET /api/projects/{id}/decisions` (list with filters)
  - [ ] Filters: date, discipline, meeting_type, impact, consensus, search
  - [ ] Pagination: limit, offset
  - [ ] Response includes facets (discipline counts, meeting type counts)
  - [ ] Performance: <200ms per request
- [ ] Endpoint: `GET /api/decisions/{id}` (full detail)
  - [ ] Returns decision with transcript excerpt
  - [ ] Similar decisions (vector search, top 5)
  - [ ] Consistency notes
  - [ ] Meeting metadata
  - [ ] Performance: <300ms per request
- [ ] Endpoint: `GET /api/projects/{id}/digest` (executive summary)
  - [ ] Date range filtering (from_date, to_date required)
  - [ ] Categorized highlights (structural, cost, timeline, risks)
  - [ ] Stats summary
  - [ ] Performance: <500ms per request
- [ ] Error handling: 400, 403, 404, 500
- [ ] Tests passing: `pytest tests/` (80%+ coverage)

---

## Tasks

### Task 1: Decision List Endpoint (1.5 days)

```python
# app/api/endpoints/decisions.py

@app.get("/api/projects/{project_id}/decisions")
async def list_decisions(
    project_id: str,
    discipline: Optional[str] = None,
    meeting_type: Optional[str] = None,
    date_from: Optional[date] = None,
    date_to: Optional[date] = None,
    search: Optional[str] = None,
    limit: int = 50,
    offset: int = 0,
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_user)
):
    # Check project access
    if not has_project_access(current_user, project_id, db):
        raise HTTPException(status_code=403, detail="Access denied")
    
    # Build query with filters
    query = db.query(Decision).filter(Decision.project_id == project_id)
    
    if discipline:
        query = query.filter(Decision.discipline.in_(discipline.split(',')))
    if meeting_type:
        query = query.filter(Decision.meeting_type.in_(meeting_type.split(',')))
    if date_from:
        query = query.filter(Decision.created_at >= date_from)
    if date_to:
        query = query.filter(Decision.created_at <= date_to)
    if search:
        query = query.filter(
            or_(
                Decision.decision_statement.ilike(f"%{search}%"),
                Decision.why.ilike(f"%{search}%")
            )
        )
    
    total = query.count()
    decisions = query.order_by(Decision.created_at.desc()).limit(limit).offset(offset).all()
    
    # Get facets
    facets = get_decision_facets(project_id, db)
    
    return {
        "decisions": [DecisionResponse.from_orm(d) for d in decisions],
        "total": total,
        "limit": limit,
        "offset": offset,
        "facets": facets
    }
```

### Task 2: Decision Detail Endpoint (1.5 days)

```python
@app.get("/api/decisions/{decision_id}")
async def get_decision_detail(
    decision_id: str,
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_user)
):
    decision = db.query(Decision).filter(Decision.id == decision_id).first()
    if not decision:
        raise HTTPException(status_code=404, detail="Decision not found")
    
    # Check project access
    if not has_project_access(current_user, decision.project_id, db):
        raise HTTPException(status_code=403, detail="Access denied")
    
    # Get transcript excerpt
    transcript_excerpt = get_transcript_excerpt(decision, db)
    
    # Get similar decisions (vector search)
    similar_decisions = find_similar_decisions(decision, db, limit=5)
    
    # Get meeting info
    meeting = db.query(Transcript).filter(
        Transcript.id == decision.transcript_id
    ).first()
    
    return {
        **DecisionResponse.from_orm(decision).dict(),
        "transcript_excerpt": transcript_excerpt,
        "similar_decisions": similar_decisions,
        "meeting": MeetingInfo.from_orm(meeting) if meeting else None,
    }
```

### Task 3: Digest Endpoint (1.5 days)

```python
@app.get("/api/projects/{project_id}/digest")
async def get_project_digest(
    project_id: str,
    date_from: date,
    date_to: date,
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_user)
):
    if not has_project_access(current_user, project_id, db):
        raise HTTPException(status_code=403, detail="Access denied")
    
    # Get decisions in date range
    decisions = db.query(Decision).filter(
        Decision.project_id == project_id,
        Decision.created_at >= date_from,
        Decision.created_at <= date_to
    ).all()
    
    # Calculate summary stats
    summary = {
        "total_decisions": len(decisions),
        "by_discipline": calculate_discipline_counts(decisions),
        "high_impact_decisions": len([d for d in decisions if has_high_impact(d)]),
        "decisions_with_dissent": len([d for d in decisions if has_dissent(d)]),
    }
    
    # Categorize highlights
    highlights = categorize_decisions(decisions)
    
    # Get anomalies
    anomalies = [
        {
            "decision_id": d.id,
            "flag": flag["type"],
            "severity": flag["severity"],
            "description": flag["description"]
        }
        for d in decisions
        for flag in (d.anomaly_flags or [])
    ]
    
    project = db.query(Project).filter(Project.id == project_id).first()
    
    return {
        "project": {"id": project.id, "name": project.name},
        "period": {"from": date_from, "to": date_to},
        "summary": summary,
        "highlights": highlights,
        "anomalies": anomalies
    }
```

### Task 4: Helper Functions (1 day)

Implement transcript excerpt extraction, vector similarity search, decision categorization, and facet calculation.

### Task 5: Write Tests (0.5 days)

```python
# tests/api/test_decisions.py

def test_list_decisions(client, test_user, test_project):
    response = client.get(
        f"/api/projects/{test_project.id}/decisions",
        headers={"Authorization": f"Bearer {test_user.token}"}
    )
    assert response.status_code == 200
    assert "decisions" in response.json()

def test_filter_by_discipline(client, test_user, test_project):
    response = client.get(
        f"/api/projects/{test_project.id}/decisions?discipline=architecture",
        headers={"Authorization": f"Bearer {test_user.token}"}
    )
    assert response.status_code == 200
    decisions = response.json()["decisions"]
    assert all(d["discipline"] == "architecture" for d in decisions)

def test_decision_detail(client, test_user, test_decision):
    response = client.get(
        f"/api/decisions/{test_decision.id}",
        headers={"Authorization": f"Bearer {test_user.token}"}
    )
    assert response.status_code == 200
    data = response.json()
    assert "transcript_excerpt" in data
    assert "similar_decisions" in data

def test_digest(client, test_user, test_project):
    response = client.get(
        f"/api/projects/{test_project.id}/digest?date_from=2026-01-01&date_to=2026-02-01",
        headers={"Authorization": f"Bearer {test_user.token}"}
    )
    assert response.status_code == 200
    data = response.json()
    assert "summary" in data
    assert "highlights" in data
```

---

## Dev Notes

### Performance Optimization

- Use database indexes for filter queries
- Limit vector search to project scope
- Cache facet calculations (Redis optional)
- Paginate large result sets

### Vector Search

```python
def find_similar_decisions(decision, db, limit=5):
    # Use pgvector cosine similarity
    results = db.query(Decision).filter(
        Decision.project_id == decision.project_id,
        Decision.id != decision.id
    ).order_by(
        Decision.embedding.cosine_distance(decision.embedding)
    ).limit(limit).all()
    
    return [
        {
            "decision_id": d.id,
            "similarity_score": 1 - decision.embedding.cosine_distance(d.embedding),
            "decision_statement": d.decision_statement
        }
        for d in results
    ]
```

---

## File List

**Modified/Created:**
- `app/api/endpoints/decisions.py` (new)
- `app/api/endpoints/digest.py` (new)
- `app/services/decision_service.py` (new)
- `app/services/digest_service.py` (new)
- `tests/api/test_decisions.py` (new)
- `tests/api/test_digest.py` (new)

---

## Testing Strategy

- ✅ List decisions with filters
- ✅ Pagination
- ✅ Search functionality
- ✅ Decision detail with transcript
- ✅ Similar decisions vector search
- ✅ Digest generation
- ✅ Date range filtering
- ✅ Access control (403)
- ✅ Performance (<200ms, <500ms)

---

## Change Log

| Date | Change |
|------|--------|
| 2026-02-08 | Created story |

---

**Related Stories:** 3.5 (Timeline), 3.6 (Filters), 3.7 (Drill-down), 3.8 (Digest)
**Blocked By:** None
**Blocks:** 3.5, 3.6, 3.7, 3.8
