# Story 8.1: Frontend — Milestone Timeline Component (Dot Timeline)

**Story ID:** 8.1
**Epic:** E8 — Milestone Timeline
**Assigned to:** @dev
**Sprint:** Sprint 3 (Week 5)
**Status:** Completed
**Estimation:** 13 story points (4-5 days)
**Review:** @ux-design-expert (Uma) — wireframe validation
**UX Guidelines:** `docs/ux/UX-UI-GUIDELINES.md` (Section 11: V2 Visual Patterns)

---

## Summary

Build the Milestone Timeline — Gabriela's "60-second project understanding" tool. A **Dot Timeline** component: a vertical line running top-to-bottom with dot nodes at temporal anchor points. **Project Stages** render as large dots on the left side that visually group milestones within their date range. **Milestone Items** render as smaller dots on the right side, positioned chronologically within their parent stage. The current stage is highlighted, a "Today" marker shows the current date, and the design is elegant and minimalist.

**Client requirement:** Gabriela opens a project, sees 5-8 key milestones plotted against stage schedule, and understands the project's current state in under 60 seconds.

---

## Acceptance Criteria

### Dot Timeline Layout
- [x] `MilestoneTimeline` organism renders within Project Detail page as a tab
- [x] **Vertical line** runs top-to-bottom: `border-l-2 border-gray-300` centered in viewport
- [x] **Stage dots (large)** — left side of line:
  - [x] Each project stage renders as a large dot (`w-5 h-5 rounded-full`)
  - [x] Stage info on left: `stage_name` (font-semibold) + `date range` (text-xs text-gray-500, "Mar 1 → Mar 31")
  - [x] Stages flow chronologically top-to-bottom
  - [x] Stages visually group/encapsulate milestones within their date range
  - [x] Stage dot color: `bg-gray-400` default, `bg-blue-600` for current stage
- [x] **Milestone dots (small)** — right side of line:
  - [x] Each milestone renders as a smaller dot (`w-3 h-3 rounded-full bg-gray-500`)
  - [x] Milestone content on right: `ItemTypeBadge`, `statement` (truncated), `SourceIcon`, `date`, `DisciplineCircle[]`
  - [x] Milestones positioned within parent stage's date range
  - [x] Connected to vertical line via thin horizontal connector (`border-t border-gray-300 w-4`)
- [x] Stage dots and milestone dots visually distinct (size, color, weight)

### Current Stage & Today Marker
- [x] **Current stage** distinguished: `bg-blue-600` dot, `ring-2 ring-blue-200`, "Current" label badge
- [x] **"Today" marker**: horizontal dashed line across the timeline at today's date position
  - [x] Label: "Today" in `text-xs text-blue-600 font-medium`
  - [x] Line: `border-t-2 border-dashed border-blue-400`
  - [x] Positioned proportionally between stage date ranges

### Data Integration
- [x] Fetches stages from `GET /api/projects/{id}/stages`
- [x] Fetches milestones from `GET /api/projects/{id}/milestones` (via `useMilestones` hook from Story 5.3)
- [x] Groups milestones into their parent stage by date range
- [x] Milestones outside any stage date range grouped under "Other" section at bottom
- [x] Uses React Query with 5-minute stale time

### Milestone Item Display
- [x] Each milestone row shows:
  - [x] `ItemTypeBadge` — compact colored badge (from Story 9.1 or inline implementation)
  - [x] `statement` — truncated to 1 line (`text-sm font-medium text-gray-900 truncate max-w-md`)
  - [x] `SourceIcon` — small icon for source type (Video/Mail/FileText/PenLine)
  - [x] `date` — formatted: "Feb 10, 2026" (`text-xs text-gray-500`)
  - [x] `DisciplineCircle[]` — first 3 discipline circles + "+N" overflow
- [x] Click milestone → opens DrilldownModal (Story 3.7, reused)

### States
- [x] **Loading**: Skeleton with 3 stage dots and 5 milestone placeholders, `animate-pulse`
- [x] **Empty**: "No milestones yet. Mark important items as milestones from the Project History."
  - [x] Icon: `Star` from lucide-react
  - [x] Dashed border container centered
- [x] **No stages**: "Set up project stages in Project Settings to enable the timeline view."
- [x] **Error**: Alert with retry button

### Responsive Design
- [x] Desktop (1024px+): stages on left, milestones on right, comfortable spacing
- [x] Tablet (768px): tighter spacing, shorter statement truncation
- [ ] Mobile (375px): vertical stack — stage header above its milestones, full-width rows (partial — uses responsive classes but not full vertical stack; CSS polish follow-up)

### Performance
- [x] Loads in <2 seconds with up to 50 milestones
- [x] No unnecessary re-renders (React.memo on milestone nodes)
- [x] Lazy load milestone details on click (DrilldownModal)

### Accessibility
- [x] Semantic HTML: `<nav aria-label="Milestone Timeline">`, `<section>` per stage
- [x] Stage headers: `<h3>` with stage name
- [x] Milestone items: `role="listitem"` within `role="list"`
- [x] Keyboard navigation: Tab through milestones, Enter to open detail
- [x] Focus visible: `ring-2 ring-blue-500 ring-offset-2`
- [x] Screen reader: milestones announce type, statement, date, disciplines

---

## Tasks

### Task 1: Create MilestoneTimeline Organism (2 days)

1. **Create `src/components/organisms/MilestoneTimeline.tsx`**
   ```typescript
   interface MilestoneTimelineProps {
     projectId: string
     stages: ProjectStage[]
     currentStageId?: string
   }

   // Groups milestones into stages by date range
   function groupMilestonesByStage(
     milestones: ProjectItem[],
     stages: ProjectStage[]
   ): Map<string, ProjectItem[]> {
     const groups = new Map<string, ProjectItem[]>()
     stages.forEach(s => groups.set(s.id, []))
     groups.set('other', [])

     milestones.forEach(m => {
       const itemDate = new Date(m.created_at)
       const parentStage = stages.find(s =>
         itemDate >= new Date(s.stage_from) && itemDate <= new Date(s.stage_to)
       )
       const key = parentStage?.id ?? 'other'
       groups.get(key)!.push(m)
     })
     return groups
   }
   ```

2. **Vertical line + dot positioning**
   ```tsx
   <div className="relative ml-8 lg:ml-48">
     {/* Vertical line */}
     <div className="absolute left-0 top-0 bottom-0 w-0.5 bg-gray-300" />

     {stages.map(stage => (
       <div key={stage.id} className="relative mb-8">
         {/* Stage dot (large, left side) */}
         <div className="absolute -left-2.5 flex items-center">
           <div className={cn(
             "w-5 h-5 rounded-full border-2 border-white shadow",
             stage.id === currentStageId ? "bg-blue-600 ring-2 ring-blue-200" : "bg-gray-400"
           )} />
         </div>

         {/* Stage label (left) */}
         <div className="absolute right-full mr-6 text-right w-40">
           <p className="text-sm font-semibold text-gray-900">{stage.stage_name}</p>
           <p className="text-xs text-gray-500">
             {formatShortDate(stage.stage_from)} → {formatShortDate(stage.stage_to)}
           </p>
           {stage.id === currentStageId && (
             <span className="text-xs px-1.5 py-0.5 rounded bg-blue-100 text-blue-700">Current</span>
           )}
         </div>

         {/* Milestones within this stage (right side) */}
         <div className="ml-8 space-y-3">
           {groupedMilestones.get(stage.id)?.map(milestone => (
             <MilestoneNode key={milestone.id} item={milestone} />
           ))}
         </div>
       </div>
     ))}

     {/* Today marker */}
     <TodayMarker stages={stages} />
   </div>
   ```

### Task 2: Create MilestoneNode Molecule (0.5 days)

1. **Create `src/components/molecules/MilestoneNode.tsx`**
   ```typescript
   interface MilestoneNodeProps {
     item: ProjectItem
     onClick?: (id: string) => void
   }

   export function MilestoneNode({ item, onClick }: MilestoneNodeProps) {
     return (
       <div
         className="relative flex items-center gap-3 group cursor-pointer
                    hover:bg-blue-50/50 rounded-md px-2 py-1.5 transition-colors"
         onClick={() => onClick?.(item.id)}
         role="button"
         tabIndex={0}
         onKeyDown={(e) => e.key === 'Enter' && onClick?.(item.id)}
       >
         {/* Small dot + connector */}
         <div className="absolute -left-10 flex items-center">
           <div className="w-4 border-t border-gray-300" />
           <div className="w-3 h-3 rounded-full bg-gray-500 border-2 border-white" />
         </div>

         {/* Content */}
         <ItemTypeBadgeInline type={item.item_type} />
         <span className="text-sm font-medium text-gray-900 truncate max-w-md">
           {item.statement}
         </span>
         <SourceIconInline type={item.source_type} />
         <span className="text-xs text-gray-500 whitespace-nowrap">
           {formatShortDate(item.created_at)}
         </span>
         <DisciplineCircles disciplines={item.affected_disciplines} max={3} />
       </div>
     )
   }
   ```

### Task 3: Create TodayMarker Component (0.25 days)

1. **Create inline `TodayMarker` within MilestoneTimeline**
   - Calculates vertical position based on today's date relative to stage ranges
   - Renders horizontal dashed line with "Today" label

### Task 4: Create StageNode Molecule (0.25 days)

1. **Create `src/components/molecules/StageNode.tsx`**
   - Large dot with stage name and date range
   - Current stage highlighting

### Task 5: Inline Atom Components (0.5 days)

1. **Create temporary inline versions** of atoms needed before Story 9.1:
   - `ItemTypeBadgeInline` — compact badge with icon per type
   - `SourceIconInline` — small icon per source
   - `DisciplineCircles` — stacked circles with overflow
   These will be replaced by proper atoms in Story 9.1.

### Task 6: Integration with ProjectDetail (0.25 days)

1. **Modify `src/pages/ProjectDetail.tsx`**
   - Add tab toggle: "Milestone Timeline" | "Project History"
   - Default tab: Milestone Timeline (if stages exist), else Project History
   - Tab state in URL hash: `#milestones` / `#history`

### Task 7: Write Tests (1 day)

1. **Create `src/tests/components/MilestoneTimeline.test.tsx`**
   - Renders stages as large dots on left
   - Renders milestones as small dots on right within correct stages
   - Current stage highlighted with accent color
   - Today marker positioned correctly
   - Empty state when no milestones
   - No-stages state
   - Click milestone opens modal
   - Loading skeleton
   - Keyboard navigation
   - Responsive layout

---

## Dev Notes

### Component Architecture

```
ProjectDetail (Page)
├── Tab: "Milestone Timeline" | "Project History"
└── MilestoneTimeline (Organism)
    ├── Vertical Line (absolute positioned border)
    ├── TodayMarker (horizontal dashed line)
    └── For each Stage:
        ├── StageNode (Molecule) — large dot, left side
        │   ├── Stage dot (w-5 h-5, blue if current)
        │   ├── Stage name (font-semibold)
        │   ├── Date range (text-xs)
        │   └── "Current" badge (if active)
        └── Milestone list (right side)
            └── MilestoneNode (Molecule) — small dot
                ├── Connector line (border-t w-4)
                ├── Milestone dot (w-3 h-3)
                ├── ItemTypeBadgeInline
                ├── Statement (truncated)
                ├── SourceIconInline
                ├── Date
                └── DisciplineCircles
```

### Today Marker Position Calculation

```typescript
function calculateTodayPosition(stages: ProjectStage[]): number {
  const today = new Date()
  const firstStageStart = new Date(stages[0].stage_from)
  const lastStageEnd = new Date(stages[stages.length - 1].stage_to)
  const totalRange = lastStageEnd.getTime() - firstStageStart.getTime()
  const todayOffset = today.getTime() - firstStageStart.getTime()
  return Math.max(0, Math.min(1, todayOffset / totalRange)) * 100 // percentage
}
```

### Color System (from UX Guidelines)

- **Stage dot default:** `bg-gray-400`
- **Stage dot current:** `bg-blue-600 ring-2 ring-blue-200`
- **Milestone dot:** `bg-gray-500 border-2 border-white`
- **Today line:** `border-blue-400 border-dashed`
- **Connector:** `border-gray-300`
- **Vertical line:** `bg-gray-300`

---

## File List

**New Files:**
- `src/types/projectItem.ts` — ProjectItem, ProjectStage, ItemType, SourceType types
- `src/hooks/useMilestones.ts` — React Query hook for milestones endpoint
- `src/hooks/useStages.ts` — React Query hook for stages endpoint
- `src/components/organisms/MilestoneTimeline.tsx` — Main timeline organism
- `src/components/molecules/MilestoneNode.tsx` — Milestone dot + content (with inline atoms)
- `src/components/molecules/StageNode.tsx` — Stage dot + label
- `src/tests/components/MilestoneTimeline.test.tsx` — 15 test cases

**Modified Files:**
- `src/pages/ProjectDetail.tsx` — Add 3-tab toggle (Milestones/History/Digest)

---

## Testing Strategy

### Unit Tests
```
- ✅ Stage nodes render with names and date ranges
- ✅ Milestones grouped into correct parent stages
- ✅ Current stage highlighted
- ✅ Today marker positioned
- ✅ Empty state (no milestones)
- ✅ No stages state
- ✅ Click opens DrilldownModal
- ✅ Keyboard Enter opens modal
- ✅ Loading skeleton
- ✅ Responsive layout
```

### Performance
- Load test with 50 milestones: <2 seconds

### Coverage Target: 80%+

---

## Change Log

| Date | Change |
|------|--------|
| 2026-02-17 | Created story |
| 2026-02-27 | Implemented — all ACs complete (Wave 3, @dev agent) |

---

**Related Stories:** 5.3 (useMilestones hook), 6.1 (stages API), 8.2 (milestone toggle), 8.3 (filters), 9.1 (proper badge atoms)
**Blocked By:** 5.3 (useMilestones hook), 6.1 (stages data), 5.5 (seed data with milestones)
**Blocks:** 8.2 (toggle uses this view), 8.3 (filters on this view), 8.4 (sharing/export of this view)
