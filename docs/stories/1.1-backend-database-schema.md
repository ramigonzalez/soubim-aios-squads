# Story 1.1: Backend Database Schema Setup

**Story ID:** 1.1
**Assigned to:** @dev
**Sprint:** Sprint 1 (Week 1)
**Status:** Draft
**Estimation:** 8 story points (2 days)

---

## Summary

Create and verify the complete PostgreSQL database schema with all tables, indexes, and pgvector extension. This is the foundation for all backend data operations.

---

## Acceptance Criteria

- [ ] Alembic migration created (`alembic/versions/001_initial.py`)
- [ ] All 7 tables created successfully:
  - [ ] users (with role enum, soft delete)
  - [ ] projects (with soft archive)
  - [ ] project_members
  - [ ] transcripts (JSONB participants)
  - [ ] decisions (with pgvector embedding)
  - [ ] decision_relationships
- [ ] pgvector extension enabled and verified
- [ ] All indexes created and optimized
- [ ] Foreign key constraints working
- [ ] Soft delete queries tested
- [ ] Schema verified in Supabase (or local PostgreSQL)
- [ ] Alembic downgrade tested
- [ ] Initial seed data created (test user, test project)
- [ ] Tests passing: `pytest tests/unit/test_database.py`

---

## Tasks

### Task 1: Create Alembic Migration (1 day)
- [ ] Read database schema specification from `docs/architecture/03-DATABASE-SCHEMA.md`
- [ ] Create `alembic/versions/001_initial.py` with all table definitions
- [ ] Match schema exactly (column types, constraints, indexes)
- [ ] Test locally: `alembic upgrade head`
- [ ] Verify all 7 tables created

### Task 2: Enable pgvector Extension
- [ ] Add `CREATE EXTENSION IF NOT EXISTS vector` to migration
- [ ] Verify extension loads
- [ ] Create 384-dimensional VECTOR column in decisions table
- [ ] Test vector operations (dot product, cosine similarity)

### Task 3: Verify Schema & Indexes
- [ ] Run all migrations
- [ ] Query information_schema to verify all indexes
- [ ] Test composite indexes (especially decisions table)
- [ ] Test soft delete WHERE clause performance
- [ ] Document any performance tuning needed

### Task 4: Seed Initial Data
- [ ] Create `app/database/seed.py`
- [ ] Add test user (email: test@example.com, password: password, role: director)
- [ ] Add test project (name: "Test Project Alpha")
- [ ] Add test project members
- [ ] Script: `python app/database/seed.py`

### Task 5: Write Tests
- [ ] Create `tests/unit/test_database.py`
- [ ] Test table creation
- [ ] Test foreign key constraints
- [ ] Test indexes exist and work
- [ ] Test soft delete logic
- [ ] Test pgvector column type
- [ ] Min 80% coverage

---

## Dev Notes

**Critical Path Items:**
- pgvector must be enabled (affects decision embeddings)
- All indexes must exist (affects query performance)
- Soft delete queries must work (data governance requirement)

**Known Issues:**
- Supabase free tier may have extension limits
- pgvector indexes (HNSW) not needed for MVP (add in Phase 2)

**Testing Strategy:**
- Test against local PostgreSQL with docker-compose
- Verify migration can be reversed (downgrade)
- Test with sample data

---

## File List

**Modified/Created:**
- `alembic/versions/001_initial.py` (new) - Initial schema migration
- `app/database/seed.py` (new) - Seed data script
- `tests/unit/test_database.py` (new) - Database tests
- `alembic.ini` (existing - already configured)

---

## Completion Notes

_Fill in after completing the story_

- **Date Completed:**
- **Actual Points:**
- **Issues Encountered:**
- **Lessons Learned:**

---

## Change Log

| Date | Change |
|------|--------|
| 2026-02-07 | Created story |

---

**Related Stories:** 1.2 (Authentication), 1.3 (Project Queries)
**Blocked By:** None
**Blocks:** 1.2, 1.3, 1.4 (Frontend)
