# Story 3.5: Decision Timeline Component (v2 — Redesigned)

**Story ID:** 3.5
**Assigned to:** @dev
**Sprint:** Sprint 5 (Week 7)
**Status:** Draft (v2 — Client Redesign)
**Estimation:** 8 story points (3-4 days)
**Design Spec:** `docs/ux/FRONTEND-SPEC-timeline-redesign-v2.md`
**Supersedes:** Original v1 visual design criteria (functional requirements remain)
**Client Feedback:** Gabriela requested minimalistic timeline with compact rows, two grouping modes (date/discipline), progressive disclosure via click-to-drill-down

---

## Summary

Build a compact, minimalistic decision timeline that displays project decisions as scannable full-width rows grouped chronologically or by discipline. Users click any row to drill down into full details (Story 3.7). The timeline uses a vertical line with circle nodes connecting date/discipline groups — matching Gabriela's hand-drawn wireframe. Includes virtual scrolling for performance with 200+ decisions.

**Key change from v1:** Replaced large card grid (3 columns, ~3 decisions visible) with compact single-column rows (~10-15 decisions visible per screen). Progressive disclosure — only `decision_statement`, `who`, `timestamp`, and discipline pill shown in the row; all other detail lives in DrilldownModal.

---

## UX Research Context

This story implements the **"Deep Dive" view** for Architects and directly supports multiple research insights:

**Research Insight 2: Digest vs. Deep Dive Split ⭐⭐ (Primary)**
- **For Architects:** Full chronological timeline with compact, scannable decision entries
- Architects need to **discover and scan** decisions across the entire project quickly
- Contrast to Executive Digest (Story 3.8) which is a high-level summary for Gabriela
- Timeline is the primary workspace for day-to-day architect work

**Research Insight 3: Discipline-First Mental Model**
- Architects think in discipline silos: "Show me all MEP decisions affecting architecture"
- Two grouping modes: **By Date** (default) and **By Discipline** (toggle)
- Discipline pills use color-coded tokens for quick visual scanning
- Works with FilterBar (Story 3.6) to narrow by discipline

**Research Insight 1: Trust Through Transparency**
- Full visibility into every decision made in meetings
- Click decision row → Open drill-down modal (Story 3.7) for full reasoning + transcript
- No hidden decisions, complete audit trail

**Research Insight 4: Mobile-First for Gabriela During Maternity**
- Timeline must work on iPad (768px) and mobile (375px)
- Compact rows are naturally mobile-friendly (full-width, no grid)
- Touch-friendly targets (min row height 56px, tap area ≥44px)

**Gabriela's Direct Feedback (2026-02-08):**
> "I want something smoother and easy to use. Decisions ordered by datetime with really compacted information. If I want to drill down, I'll click the entry. A very minimalistic interface."

**Design System: Shadcn/ui Badge + RadioGroup Components**
- Discipline pills use Shadcn/ui `Badge` with abbreviated labels and discipline color tokens
- Grouping toggle uses Shadcn/ui `RadioGroup` or custom segmented control
- Color system from Tailwind config (Story 3.1):
  - Discipline: `discipline-architecture`, `discipline-mep`, etc.

**Component Architecture: Atomic Design**
- **Organism:** Timeline (vertical list with grouping logic, timeline line, states)
- **Molecule:** DecisionRow (compact 2-line row with discipline pill)
- **Molecule:** GroupingToggle (radio: By Date / By Discipline)
- **Atoms:** Badge, RadioGroupItem (from Shadcn/ui)

**User Flow:**
1. User selects project → Lands on Project Detail page with Timeline
2. Sees compact list of decisions grouped by date (default)
3. Scans vertically — 10-15 decisions visible per screen
4. Optionally toggles to "By Discipline" grouping
5. Clicks a decision row → Opens drill-down modal (Story 3.7)
6. Uses FilterBar (Story 3.6) to narrow decisions by discipline/date/who

**Performance Requirements (from UX Success Metrics):**
- Timeline load: <2 seconds (200+ decisions)
- Virtual scrolling if >200 decisions
- Smooth scroll: 60 fps

**Reference:** `docs/ux/FRONTEND-SPEC-timeline-redesign-v2.md` (Sections 4.1, 4.2)

---

## Acceptance Criteria

### Data Fetching & Display
- [ ] Fetch decisions from `/api/projects/{id}/decisions` using React Query
- [ ] Display decisions chronologically (default: newest → oldest)
- [ ] React Query caching (5 min stale time) to avoid refetching
- [ ] Timeline header shows total decision count

### Grouping Modes (v2 — Two Modes)
- [ ] Two grouping modes via toggle: **"By Date"** (default) and **"By Discipline"**
- [ ] **By Date mode:**
  - [ ] Group decisions by `meeting_date` (fallback to `created_at`), sorted newest first
  - [ ] Group header: Full date format "Friday, 7 February 2026" + decision count
  - [ ] Blue circle node (`w-3 h-3 bg-blue-600 rounded-full`) at each group header
  - [ ] Vertical timeline line connecting groups (`border-l-2 border-gray-200`)
  - [ ] Decisions within group sorted by `timestamp` (meeting recording time)
- [ ] **By Discipline mode:**
  - [ ] Group decisions by `discipline` field
  - [ ] Group header: Discipline name (e.g., "Architecture") + decision count
  - [ ] Discipline-colored circle node at each group header (using discipline color tokens)
  - [ ] Each row shows `meeting_date` inline (since discipline is the group header)
  - [ ] Decisions within group sorted by date (newest first)
- [ ] Grouping toggle state managed locally in component (`groupBy: 'date' | 'discipline'`)

### Decision Rows (v2 — Replaces Decision Cards)
- [ ] `DecisionRow` component: compact 2-line row (~56-64px height)
- [ ] **Row 1:** `decision_statement` (truncated, 1 line, `text-sm font-medium text-gray-900 truncate`) + discipline pill (abbreviated, right-aligned)
  - [ ] Discipline pill: `text-xs px-2 py-0.5 rounded-full` using Tailwind `discipline-*` color tokens
  - [ ] Abbreviations: Architecture→"Arch", MEP→"MEP", Structural→"Struct", Electrical→"Elec", Plumbing→"Plumb", Landscape→"Land"
- [ ] **Row 2:** `who` (left, `text-xs text-gray-500`) + `timestamp` in `HH:MM:SS` format (right, `text-xs text-gray-500 font-mono`)
  - [ ] User icon (`lucide-react User`, `w-3.5 h-3.5 text-gray-400`)
  - [ ] Clock icon (`lucide-react Clock`, `w-3.5 h-3.5 text-gray-400`)
- [ ] **NOT shown in row** (moved to DrilldownModal): description/why, consensus, impact, confidence, anomaly badges
- [ ] Row styling:
  - [ ] Background: `bg-white`
  - [ ] Border: `border-b border-gray-100` (bottom border only)
  - [ ] Border radius: `rounded-md`
  - [ ] Spacing between rows: `space-y-2` (8px gap, per Gabriela's ~10px wireframe)
  - [ ] Hover: `hover:bg-blue-50/50` + `cursor-pointer`
  - [ ] Transition: `transition-colors duration-150`

### Interaction & Navigation (UX Insight 1: Transparency)
- [ ] Click decision row → Open drill-down modal (Story 3.7, passed decision ID)
- [ ] Hover state: subtle `bg-blue-50/50` highlight
- [ ] Cursor pointer on decision rows
- [ ] Focus visible for keyboard navigation (`ring-2 ring-blue-500 ring-offset-1`)
- [ ] `role="button"` + `tabIndex={0}` + `onKeyDown` for Enter key support
- [ ] No page reload when clicking row (modal opens inline)

### Responsive Design (UX Insight 4: Mobile-First)
- [ ] Timeline container responsive padding:
  - Mobile (375px-767px): `px-4` (16px)
  - Tablet (768px-1023px): `px-6` (24px)
  - Desktop (1024px+): `px-8` (32px)
- [ ] Decision rows are full-width (no grid, naturally responsive)
- [ ] Touch-friendly targets on mobile (row min height 56px, tap area ≥44px)
- [ ] Mobile date format abbreviated: "Fri, 7 Feb 2026"
- [ ] Mobile timestamp shortened: "05:13" (omit hours if 00)
- [ ] Horizontal scroll disabled (all content wraps properly)

### Performance (UX Success Metric: <2s load)
- [ ] Initial timeline load <2 seconds for 200 decisions
- [ ] Virtual scrolling implemented IF >200 decisions (use react-window):
  - Defer to performance testing
  - If load time >2s with 200+ decisions, implement virtual scrolling
- [ ] Skeleton loading state displays immediately (no white flash)
- [ ] Smooth scroll performance (60 fps, no janky scrolling)

### Loading, Empty, and Error States
- [ ] Loading state: skeleton rows (3 groups × 3 thin pulsing bars each):
  - Skeleton mimics group header (thin gray bar `h-4`, pulsing)
  - Skeleton decision rows (thin gray rectangles `h-12`, pulsing)
  - Tailwind `animate-pulse` for shimmer effect
- [ ] Empty state when no decisions:
  - Icon (Calendar from lucide-react)
  - Heading: "No decisions yet"
  - Description: "Decisions will appear here once meetings are processed"
  - Bordered/dashed container for visual distinction
- [ ] Error state with retry button:
  - Shadcn/ui `Alert` component (variant=destructive)
  - Error message displayed
  - Retry button (Shadcn/ui `Button`, variant=outline)
  - Triggers React Query refetch on click

### Accessibility (WCAG 2.1 AA)
- [ ] Semantic HTML:
  - `<main>` for timeline container
  - `<article>` for each decision row
  - `<h2>`, `<h3>` for group headers
- [ ] ARIA labels:
  - Group headers: `aria-label="{date/discipline}, {N} decisions"`
  - Decision rows: `aria-label="Decision: {statement}"`
  - Icons: `aria-hidden="true"` with text labels nearby
- [ ] Keyboard navigation:
  - Tab through decision rows in order
  - Enter to open drill-down modal
  - Escape to close modal (in Story 3.7)
- [ ] Focus visible styles (`ring-2 ring-blue-500 ring-offset-1`)
- [ ] Color contrast ≥4.5:1 for all text
- [ ] Screen reader friendly:
  - Decision row content reads in logical order
  - Discipline pills announce meaningful labels (not just colors)

### Testing
- [ ] Unit tests >80% coverage:
  - Timeline component renders with grouped decisions
  - Decisions grouped by date correctly (newest first)
  - Decisions grouped by discipline correctly
  - Grouping toggle switches modes
  - Decision rows display correct fields (statement, who, timestamp, discipline pill)
  - Decision rows do NOT display removed fields (description, consensus, impact)
  - Vertical timeline line renders
  - Group header shows full date format
  - Empty state renders
  - Error state with retry
- [ ] Integration test: Fetch decisions → Display timeline → Click row → Modal opens
- [ ] Performance test: Load 200 decisions in <2 seconds
- [ ] Accessibility test: Keyboard navigation, screen reader
- [ ] Responsive test: Mobile (375px), Tablet (768px), Desktop (1024px+)

---

## Tasks

### Task 1: Create DecisionRow Component (0.5 days)

1. **Create `src/components/molecules/DecisionRow.tsx`**
   - Compact 2-line row: statement + discipline pill (line 1), who + timestamp (line 2)
   - Props: `decision: Decision`, `onClick: (id: string) => void`, `showDate?: boolean`, `showDiscipline?: boolean`
   - `showDate` = true when grouped by discipline (show meeting_date inline)
   - `showDiscipline` = true when grouped by date (show discipline pill, default)
   - Hover/focus/keyboard interaction as specified
   - Uses `abbreviateDiscipline()` util for short labels

2. **Deprecate `src/components/molecules/DecisionCard.tsx`**
   - Mark as deprecated (kept for reference, not imported)

### Task 2: Redesign Timeline Component (1 day)

1. **Modify `src/components/organisms/Timeline.tsx`**
   - Replace card grid with single-column vertical list
   - Add vertical timeline line (`border-l-2 border-gray-200`) with circle nodes
   - Implement `groupByDate()` and `groupByDiscipline()` grouping functions
   - Accept `groupBy: 'date' | 'discipline'` prop
   - Group headers: full date "Friday, 7 February 2026" or discipline name
   - Render `DecisionRow` (not DecisionCard) for each decision
   - Pass `showDate` / `showDiscipline` props based on grouping mode

### Task 3: Create GroupingToggle Component (0.25 days)

1. **Create `src/components/molecules/GroupingToggle.tsx`**
   - Radio toggle: "By Date" (default) | "By Discipline"
   - Uses Shadcn/ui `RadioGroup` or custom segmented control
   - Props: `value: 'date' | 'discipline'`, `onChange: (value) => void`
   - Styled: `text-sm text-gray-600`, `flex items-center gap-4`

### Task 4: Add Utility Functions (0.25 days)

1. **Modify `src/lib/utils.ts`**
   - Add `formatFullDate(dateStr)` → "Friday, 7 February 2026"
   - Add `formatTimestamp(timestamp)` → "HH:MM:SS" format
   - Add `abbreviateDiscipline(discipline)` → "Arch", "MEP", "Struct", etc.

### Task 5: Update ProjectDetail Page Integration (0.5 days)

1. **Modify `src/pages/ProjectDetail.tsx`**
   - Remove `<aside>` sidebar wrapper (sidebar replaced by FilterBar in Story 3.6)
   - Add `groupBy` state: `const [groupBy, setGroupBy] = useState<'date' | 'discipline'>('date')`
   - Render `<GroupingToggle>` between FilterBar and Timeline
   - Pass `groupBy` prop to `<Timeline>`
   - Full-width content layout (no sidebar split)
   - Update `max-w-7xl` to `max-w-5xl` for better content width without sidebar

### Task 6: Add Virtual Scrolling (Optional — Performance) (0.5 days)

1. **Install react-window for virtual scrolling**
   ```bash
   npm install react-window
   npm install -D @types/react-window
   ```

2. **Update Timeline to use virtual scrolling (if needed)**
   - Only implement if >200 decisions in testing
   - For MVP, standard rendering is fine for <200 decisions

### Task 7: Write Tests (0.75 days)

1. **Create `tests/components/DecisionRow.test.tsx`**
   - Row renders statement, who, timestamp, discipline pill
   - Click triggers onClick callback
   - Hover state applies
   - Keyboard Enter triggers onClick
   - `showDate` prop renders meeting_date
   - `showDiscipline` prop renders discipline pill

2. **Update `tests/components/Timeline.test.tsx`**
   - Decisions grouped by date correctly
   - Decisions grouped by discipline correctly
   - Group headers render full date format
   - Vertical timeline line present
   - Empty state renders
   - Error state with retry

3. **Create `tests/components/GroupingToggle.test.tsx`**
   - Toggle renders both options
   - Clicking toggles value
   - Default value is "date"

---

## Dev Notes

### Timeline Architecture (Atomic Design) — v2

```
Timeline (Organism)
├── Props: decisions[], onSelectDecision(), groupBy
├── Grouping Logic: groupByDate() or groupByDiscipline()
├── Loading State → TimelineSkeleton (3 groups × 3 thin rows)
├── Empty State → EmptyTimeline (icon + message)
├── Error State → Alert (Shadcn/ui) + Retry Button
└── For each group:
    ├── Group Header
    │   ├── Circle Node (blue for date, discipline-colored for discipline)
    │   ├── Group Label (full date or discipline name)
    │   └── Decision Count
    ├── Vertical Timeline Line (border-l-2 border-gray-200)
    └── DecisionRow (Molecule) [repeating]
        ├── Row 1: decision_statement (truncated) + discipline pill (abbreviated)
        ├── Row 2: who (left) + timestamp HH:MM:SS (right)
        └── Click → onSelectDecision(id) → DrillDownModal (Story 3.7)

GroupingToggle (Molecule)
├── Radio: "By Date" (default) | "By Discipline"
└── Emits onChange('date' | 'discipline')
```

**Component File Locations:**
- `src/components/organisms/Timeline.tsx` — Main timeline organism (redesigned)
- `src/components/molecules/DecisionRow.tsx` — Compact decision row (NEW, replaces DecisionCard)
- `src/components/molecules/GroupingToggle.tsx` — Grouping mode toggle (NEW)
- `src/components/molecules/DecisionCard.tsx` — DEPRECATED (kept for reference)
- `src/lib/utils.ts` — Add `formatFullDate`, `formatTimestamp`, `abbreviateDiscipline`
- `src/components/atoms/` — Shadcn/ui (Badge, RadioGroupItem, Alert, Button)

### Performance Considerations

- **Target**: <2 second load for 200 decisions
- **Optimization**: Virtual scrolling if >200 decisions
- **Caching**: React Query stale time 5 minutes
- **Row efficiency**: Compact rows (~56-64px) render faster than complex cards (~180px)

### Color Coding System (from UX Research + Story 3.1)

**Discipline Colors (Tailwind `discipline-*` classes):**
| Discipline | Color | Hex | Tailwind Class | Abbreviation |
|------------|-------|-----|----------------|--------------|
| Architecture | Blue | #3B82F6 | `bg-discipline-architecture` | Arch |
| MEP | Orange | #F97316 | `bg-discipline-mep` | MEP |
| Landscape | Green | #10B981 | `bg-discipline-landscape` | Land |
| Structural | Purple | #8B5CF6 | `bg-discipline-structural` | Struct |
| Electrical | Amber | #F59E0B | `bg-discipline-electrical` | Elec |
| Plumbing | Cyan | #06B6D4 | `bg-discipline-plumbing` | Plumb |

**Usage Notes:**
- All colors defined in `tailwind.config.ts` (Story 3.1)
- Use with opacity for backgrounds: `bg-discipline-architecture/10` (10% opacity)
- WCAG AA compliant contrast ratios (4.5:1 minimum)
- Abbreviations used in DecisionRow pills for space efficiency

### What Moved to DrilldownModal (Story 3.7)

The following fields are **no longer shown in the timeline row** but remain accessible via click → DrilldownModal:
- `why` / rationale / description
- `consensus` indicators (agree/mixed/dissent badges)
- `impacts` badges (high/medium/low)
- `confidence` score badge
- `anomaly_flags` badge
- `causation`
- `similar_decisions`
- `transcript_excerpt`

---

## File List

**New Files:**
- `src/components/molecules/DecisionRow.tsx` — Compact decision row molecule
- `src/components/molecules/GroupingToggle.tsx` — Grouping mode toggle molecule
- `tests/components/DecisionRow.test.tsx` — DecisionRow unit tests
- `tests/components/GroupingToggle.test.tsx` — GroupingToggle unit tests

**Modified Files:**
- `src/components/organisms/Timeline.tsx` — Major redesign (vertical list, grouping, timeline line)
- `src/pages/ProjectDetail.tsx` — Remove sidebar layout, add groupBy state, full-width
- `src/lib/utils.ts` — Add `formatFullDate`, `formatTimestamp`, `abbreviateDiscipline`
- `tests/components/Timeline.test.tsx` — Update for new grouping and row structure

**Deprecated Files:**
- `src/components/molecules/DecisionCard.tsx` — Replaced by DecisionRow
- `src/components/molecules/MeetingGroup.tsx` — Grouping logic moved into Timeline

**Package Dependencies:**
- `package.json` (verify) — lucide-react (icons), react-window if needed (performance)
- Shadcn/ui: `npx shadcn-ui@latest add radio-group` (for GroupingToggle)

---

## Testing Strategy

### Unit Tests

```
Test coverage areas:
- ✅ DecisionRow rendering (statement, who, timestamp, discipline pill)
- ✅ DecisionRow does NOT render removed fields (description, consensus, impact)
- ✅ DecisionRow click and keyboard interaction
- ✅ Timeline grouping by date (newest first)
- ✅ Timeline grouping by discipline
- ✅ GroupingToggle switches modes
- ✅ Group headers with full date format
- ✅ Vertical timeline line renders
- ✅ Empty state
- ✅ Loading skeleton state
- ✅ Error handling
```

### Performance Testing

```bash
# Test with 200+ decisions
npm run test:performance

# Measure load time
# Target: <2 seconds
```

### Coverage Target

- Minimum: 80%
- Target: 90%+
- Run: `npm run test -- --coverage`

---

## UX Design System References

**Primary Documentation:**
- `docs/ux/FRONTEND-SPEC-timeline-redesign-v2.md` — **Authoritative design spec for v2 redesign**
- `docs/ux/RESEARCH-AND-DESIGN-SYSTEM-ANALYSIS.md` — Part 2: Insight 2 "Digest vs. Deep Dive Split"
- `docs/ux/RESEARCH-AND-DESIGN-SYSTEM-ANALYSIS.md` — Part 2: Insight 3 "Discipline-First Mental Model"
- `docs/ux/REQUIREMENTS-TRANSLATION-GUIDE.md` — Story 3.5 example
- `docs/ux/AIOS-WORKFLOW-INTEGRATION.md` — Component architecture patterns

**Shadcn/ui Components Used:**
- Badge: https://ui.shadcn.com/docs/components/badge
- RadioGroup: https://ui.shadcn.com/docs/components/radio-group
- Alert: https://ui.shadcn.com/docs/components/alert
- Button: https://ui.shadcn.com/docs/components/button

**Design Rationale (v2):**
- **Why compact rows?** Gabriela wants to scan 10-15 decisions at a glance, not 3 large cards
- **Why two grouping modes?** Date-first for chronological review, discipline-first for domain review
- **Why progressive disclosure?** Minimalist row + click for full detail reduces cognitive load
- **Why vertical timeline line?** Matches Gabriela's wireframe, provides visual continuity between groups
- **Why abbreviated discipline pills?** Space-efficient in compact rows while maintaining color scanning

---

## Change Log

| Date | Change |
|------|--------|
| 2026-02-08 | Created story (v1) |
| 2026-02-08 | Updated with UX design system guidelines (Shadcn/ui, Atomic Design, Tailwind colors, mobile-first, WCAG AA) |
| 2026-02-08 | **v2 REDESIGN:** Client feedback from Gabriela — replaced card grid with compact rows, added two grouping modes (By Date / By Discipline), replaced DecisionCard with DecisionRow, added GroupingToggle, updated all acceptance criteria per `FRONTEND-SPEC-timeline-redesign-v2.md` |

---

**Related Stories:** 3.1 (Frontend Setup), 3.4 (Projects List), 3.6 (FilterBar — co-dependent), 3.7 (Drill-down), 3.10 (Responsive Design)
**Blocked By:** 3.1 (Frontend Setup), 3.4 (Projects List selection)
**Co-dependent:** 3.6 (FilterBar and Timeline share ProjectDetail.tsx layout changes)
**Blocks:** 3.7 (Drill-down triggered from timeline rows)
