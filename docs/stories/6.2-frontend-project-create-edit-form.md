# Story 6.2: Frontend — Project Create/Edit Form

**Story ID:** 6.2
**Epic:** E6 — Project Management Foundation
**Assigned to:** @dev
**Sprint:** Sprint 2 (Week 3)
**Status:** Ready for Review
**Estimation:** 8 story points (3 days)
**Review:** @ux-design-expert (Uma) — form UX review
**UX Guidelines:** `docs/ux/UX-UI-GUIDELINES.md`

---

## Summary

Build the Project Create/Edit form — a full-page form with three sections: project details (title, description, project_type), stage schedule builder (add/remove rows with date ranges, "Load Template" button), and participant roster (add/remove rows with name, email, discipline select). The form handles both creation (`/projects/new`) and editing (`/projects/:id/edit`) using the same `ProjectForm` component. Native date inputs styled with Tailwind, no new date picker dependencies.

---

## Acceptance Criteria

### Routing & Navigation
- [x] `/projects/new` route renders `ProjectForm` in create mode
- [x] `/projects/:id/edit` route renders `ProjectForm` in edit mode (pre-populated)
- [x] "Create Project" button on Projects page navigates to `/projects/new`
- [x] Successful form submission redirects to project detail page
- [x] "Cancel" button returns to previous page

### Project Details Section
- [x] `title` — required text input, max 255 chars
- [x] `description` — optional textarea, auto-resizing
- [x] `project_type` — select dropdown with options: "Architecture Full", "Architecture Legal", "Custom"
- [x] Form validation: title required, shows inline error if empty on submit

### Stage Schedule Builder
- [x] Dynamic rows: each row has `stage_name` (text), `stage_from` (date), `stage_to` (date), remove button (X)
- [x] "Add Stage" button appends empty row
- [x] "Load Template" button:
  - [x] Fetches templates from `GET /api/stage-templates`
  - [x] Shows dropdown with template names
  - [x] Selecting template populates stage rows with template stages
  - [x] Template dates auto-calculated from today's date + `default_duration_days`
  - [x] Replaces any existing stages (with confirmation if stages already defined)
- [ ] Date validation:
  - [ ] `stage_from` must be before `stage_to` (inline error)
  - [ ] No overlapping date ranges (inline error)
  - [ ] Stages should be sequential (warning, not blocking)
- [ ] Drag-to-reorder stages (nice-to-have — use sort_order from array position as MVP)
- [ ] Current stage selector: dropdown from defined stages (optional — can be set after creation)
- [x] Empty state: "No stages defined. Add stages or load a template."

### Participant Roster Section
- [x] Dynamic rows: each row has `name` (text, required), `email` (email, optional), `discipline` (select from 15 disciplines, required), `role` (text, optional), remove button (X)
- [x] "Add Participant" button appends empty row
- [x] Discipline select shows all 15 discipline values with labels
- [ ] Email validation: valid email format when provided
- [ ] Duplicate email warning (within current roster)
- [x] Empty state: "No participants added. Add team members to improve AI discipline inference."

### Form Submission
- [x] Create mode: `POST /api/projects` with `{title, description, project_type, stages[], participants[]}`
- [x] Edit mode: `PATCH /api/projects/{id}` with changed fields
  - [x] Stage changes: replaces entire schedule via `POST /api/projects/{id}/stages`
  - [ ] Participant changes: diff and call add/update/remove endpoints
- [x] Loading state on submit button
- [x] Error handling: toast notification for API errors
- [x] Success: redirect to project detail with success toast

### Responsive Design
- [x] Mobile (375px): single-column layout, full-width inputs
- [x] Tablet (768px): two-column layout for date pairs
- [x] Desktop (1024px+): comfortable form width (max-w-3xl)

### Accessibility
- [x] All inputs have associated labels
- [x] Required fields marked with visual indicator
- [ ] Error messages linked to inputs via `aria-describedby`
- [x] Keyboard navigation: Tab through all fields, Enter to submit
- [x] Focus trap within form (standard browser behavior)

---

## Tasks

### Task 1: Create ProjectForm Component (1.5 days)

1. **Create `src/components/organisms/ProjectForm.tsx`**
   - Props: `mode: 'create' | 'edit'`, `project?: Project` (for edit pre-fill)
   - Three sections with visual separation (card-like containers)
   - Uses React state for form management (no form library — keep simple)

   ```typescript
   interface ProjectFormProps {
     mode: 'create' | 'edit'
     project?: ProjectDetail
   }

   interface FormState {
     title: string
     description: string
     projectType: string
     stages: StageFormRow[]
     participants: ParticipantFormRow[]
     actualStageIndex: number | null
   }

   interface StageFormRow {
     id: string           // temp client-side ID
     stageName: string
     stageFrom: string    // ISO date string
     stageTo: string
   }

   interface ParticipantFormRow {
     id: string
     name: string
     email: string
     discipline: string
     role: string
   }
   ```

### Task 2: Create StageScheduleBuilder Molecule (0.5 days)

1. **Create `src/components/organisms/StageScheduleBuilder.tsx`**
   - Dynamic row management (add/remove)
   - "Load Template" dropdown
   - Date validation with inline errors
   - Native `<input type="date">` styled with Tailwind

   ```typescript
   interface StageScheduleBuilderProps {
     stages: StageFormRow[]
     onChange: (stages: StageFormRow[]) => void
     templates: StageTemplate[]
   }
   ```

### Task 3: Create ParticipantRoster Molecule (0.5 days)

1. **Create `src/components/organisms/ParticipantRoster.tsx`**
   - Dynamic row management (add/remove)
   - Discipline select with 15 options
   - Email validation

   ```typescript
   interface ParticipantRosterProps {
     participants: ParticipantFormRow[]
     onChange: (participants: ParticipantFormRow[]) => void
   }
   ```

### Task 4: Add Routes & API Hooks (0.25 days)

1. **Update route config** — Add `/projects/new` and `/projects/:id/edit` routes
2. **Create `src/hooks/useStageTemplates.ts`** — Fetches templates from API
3. **Create `src/hooks/useProjectMutation.ts`** — Create/update project mutations

### Task 5: Create Form Pages (0.25 days)

1. **Create `src/pages/ProjectCreate.tsx`** — Wraps `ProjectForm` in create mode
2. **Create `src/pages/ProjectEdit.tsx`** — Fetches project data, wraps `ProjectForm` in edit mode

### Task 6: Write Tests (0.5 days)

1. **Create `src/tests/components/ProjectForm.test.tsx`**
   - Form renders all three sections
   - Title validation (required)
   - Stage add/remove works
   - Template loading populates stages
   - Date validation shows errors
   - Participant add/remove works
   - Discipline select has all 15 options
   - Submit calls correct API endpoint
   - Edit mode pre-populates form

---

## Dev Notes

### Component Architecture

```
ProjectCreate (Page)
└── ProjectForm (Organism)
    ├── Project Details Section
    │   ├── title input
    │   ├── description textarea
    │   └── project_type select
    ├── StageScheduleBuilder (Organism)
    │   ├── "Load Template" dropdown
    │   ├── Stage rows (dynamic)
    │   │   ├── stage_name input
    │   │   ├── stage_from date input
    │   │   ├── stage_to date input
    │   │   └── remove button
    │   └── "Add Stage" button
    ├── ParticipantRoster (Organism)
    │   ├── Participant rows (dynamic)
    │   │   ├── name input
    │   │   ├── email input
    │   │   ├── discipline select
    │   │   ├── role input
    │   │   └── remove button
    │   └── "Add Participant" button
    └── Submit / Cancel buttons
```

### Template Date Calculation

When loading a template, auto-calculate dates from today:
```typescript
function applyTemplate(template: StageTemplate): StageFormRow[] {
  let currentDate = new Date()
  return template.stages.map((s, i) => {
    const from = new Date(currentDate)
    const to = new Date(from)
    to.setDate(to.getDate() + s.default_duration_days)
    currentDate = new Date(to)
    currentDate.setDate(currentDate.getDate() + 1) // next day
    return {
      id: crypto.randomUUID(),
      stageName: s.stage_name,
      stageFrom: from.toISOString().split('T')[0],
      stageTo: to.toISOString().split('T')[0],
    }
  })
}
```

### Tailwind Form Styling

```
Input: border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500
Label: text-sm font-medium text-gray-700 mb-1
Error: text-sm text-red-600 mt-1
Section: bg-white rounded-lg border border-gray-200 p-6 mb-6
Button Primary: bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700
Button Secondary: bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-50
```

---

## File List

**New Files:**
- `src/components/organisms/ProjectForm.tsx` — Main form component (create + edit modes)
- `src/components/organisms/StageScheduleBuilder.tsx` — Stage builder with template loading
- `src/components/organisms/ParticipantRoster.tsx` — Participant roster with 15-discipline select
- `src/pages/ProjectCreate.tsx` — Create page wrapper
- `src/pages/ProjectEdit.tsx` — Edit page with data fetching and pre-population
- `src/hooks/useStageTemplates.ts` — Template fetcher
- `src/hooks/useProjectMutation.ts` — Project create/update/archive/stages/participants mutations
- `src/hooks/useProject.ts` — Single project detail fetch hook (for edit mode)
- `src/tests/components/ProjectForm.test.tsx` — 14 tests covering form sections, validation, modes

**Modified Files:**
- `src/App.tsx` — Add `/projects/new` and `/projects/:id/edit` routes
- `src/pages/Projects.tsx` — Add "Create Project" button

---

## Testing Strategy

### Unit Tests
```
- ✅ Form renders all sections
- ✅ Title required validation
- ✅ Stage add/remove
- ✅ Template loading
- ✅ Date validation (overlap, sequential)
- ✅ Participant add/remove
- ✅ Discipline select options
- ✅ Edit mode pre-population
- ✅ Submit calls correct endpoint
```

### Coverage Target
- 80%+
- Run: `cd decision-log-frontend && npm run test`

---

## Change Log

| Date | Change |
|------|--------|
| 2026-02-16 | Created story |

---

**Related Stories:** 6.1 (Backend API), 6.3 (Project List), 8.1 (Milestone Timeline uses stages)
**Blocked By:** 6.1 (Backend endpoints must exist)
**Blocks:** None (but enhances 8.1 setup workflow)
