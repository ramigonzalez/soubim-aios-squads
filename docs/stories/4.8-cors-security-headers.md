# Story 4.8: CORS & Security Headers

**Story ID:** 4.8
**Assigned to:** @dev
**Sprint:** Sprint 6 (Week 8)
**Status:** Draft
**Estimation:** 3 story points (1-2 days)

---

## Summary

Configure CORS to allow only frontend origin, add security headers (X-Content-Type-Options, X-Frame-Options, HSTS), implement CSRF protection via SameSite cookies, and sanitize error messages.

---

## Acceptance Criteria

- [ ] CORS configured:
  - [ ] allow_origins: [FRONTEND_URL only]
  - [ ] allow_credentials: true
  - [ ] allow_methods: GET, POST, PATCH
- [ ] Security headers set:
  - [ ] X-Content-Type-Options: nosniff
  - [ ] X-Frame-Options: DENY
  - [ ] Strict-Transport-Security: max-age=31536000
  - [ ] X-XSS-Protection: 1; mode=block
- [ ] CSRF protection (SameSite=Strict cookies)
- [ ] No sensitive data in error messages
- [ ] Tests passing: `pytest tests/security/test_cors.py`

---

## Tasks

### Task 1: Configure CORS (0.5 days)

```python
from fastapi.middleware.cors import CORSMiddleware

app.add_middleware(
    CORSMiddleware,
    allow_origins=[os.getenv("FRONTEND_URL", "http://localhost:5173")],
    allow_credentials=True,
    allow_methods=["GET", "POST", "PATCH"],
    allow_headers=["*"]
)
```

### Task 2: Add Security Headers (0.5 days)

```python
@app.middleware("http")
async def add_security_headers(request: Request, call_next):
    response = await call_next(request)
    response.headers["X-Content-Type-Options"] = "nosniff"
    response.headers["X-Frame-Options"] = "DENY"
    response.headers["X-XSS-Protection"] = "1; mode=block"
    response.headers["Strict-Transport-Security"] = "max-age=31536000; includeSubDomains"
    return response
```

### Task 3: Write Tests (0.5 days)

```python
def test_cors_allows_frontend(client):
    response = client.options(
        "/api/projects",
        headers={"Origin": "http://localhost:5173"}
    )
    assert response.headers["Access-Control-Allow-Origin"] == "http://localhost:5173"

def test_cors_blocks_other_origins(client):
    response = client.options(
        "/api/projects",
        headers={"Origin": "http://evil.com"}
    )
    assert "Access-Control-Allow-Origin" not in response.headers

def test_security_headers_present(client):
    response = client.get("/health")
    assert response.headers["X-Content-Type-Options"] == "nosniff"
    assert response.headers["X-Frame-Options"] == "DENY"
```

---

**Related Stories:** All backend security stories
**Blocked By:** None
**Blocks:** None
