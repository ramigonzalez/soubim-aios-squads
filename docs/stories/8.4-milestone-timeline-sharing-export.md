# Story 8.4: Milestone Timeline Sharing & Export

**Story ID:** 8.4
**Epic:** E8 — Milestone Timeline
**Assigned to:** @dev
**Sprint:** Sprint 4 (Week 6)
**Status:** Ready for Review
**Estimation:** 5 story points (2 days)
**Review:** @architect (Aria) — shared link security, export architecture
**UX Guidelines:** `docs/ux/UX-UI-GUIDELINES.md` (Section 13: Print & Export Styles)

---

## Summary

Enable Gabriela to share the Milestone Timeline with clients and providers via read-only shareable links (no authentication required) and export the current view as PDF or JPEG. Shared links include a unique token, expire after a configurable period (default: 30 days), and can be revoked. Exports respect the current filter state so Gabriela can share exactly the view she's looking at.

---

## Acceptance Criteria

### Share Link Generation (Backend)
- [x] `POST /api/projects/{id}/milestones/share` — generates a unique share token
  - [x] Request body: `{ "expires_in_days": 30 }` (optional, default 30)
  - [x] Response: `{ "share_token": "abc123...", "share_url": "https://app.decisionlog.io/shared/milestones/abc123", "expires_at": "2026-03-22T00:00:00Z" }`
  - [x] Admin-only access (director role)
- [x] `DELETE /api/projects/{id}/milestones/share/{token}` — revokes a shared link
  - [x] Admin-only access
- [x] `GET /api/projects/{id}/milestones/share` — lists active shared links for a project
  - [x] Response includes: token, created_at, expires_at, view_count

### Shared Link Viewing (Backend + Frontend)
- [x] `GET /api/shared/milestones/{token}` — public endpoint, no auth required
  - [x] Returns: project name, stages[], milestones[] (same shape as authenticated view)
  - [x] Returns `404` if token expired or revoked
  - [x] Increments `view_count` on each access
- [x] `/shared/milestones/{token}` frontend route renders read-only `MilestoneTimeline`
  - [x] No navigation bar, no edit controls, no milestone toggle
  - [x] Shows project name header + "Shared view" indicator
  - [x] Renders same Dot Timeline layout (stages left, milestones right)
  - [x] Responsive: works on mobile for client viewing

### Share Token Storage
- [x] `shared_links` database table:
  ```sql
  CREATE TABLE shared_links (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    project_id UUID NOT NULL REFERENCES projects(id),
    share_token VARCHAR(64) UNIQUE NOT NULL,
    resource_type VARCHAR(50) NOT NULL DEFAULT 'milestone_timeline',
    created_by UUID REFERENCES users(id),
    created_at TIMESTAMP DEFAULT NOW(),
    expires_at TIMESTAMP NOT NULL,
    revoked_at TIMESTAMP,
    view_count INTEGER DEFAULT 0
  );
  ```
- [x] Token generated via `secrets.token_urlsafe(32)` (cryptographically secure)
- [x] Index on `share_token` for fast lookup

### Export Functionality (Frontend)
- [x] "Export" button on Milestone Timeline toolbar (next to "Share" button)
- [x] Dropdown menu with two options: "Export as PDF" and "Export as JPEG"
- [x] Export captures the currently visible timeline (respects active filters from Story 8.3)

### PDF Export
- [x] Uses `html2canvas` + `jsPDF` (or equivalent client-side library)
- [x] Page size: A4 portrait
- [x] Header: project name + export date ("Exported on Feb 20, 2026")
- [x] Footer: page number + "Generated by DecisionLog"
- [x] All discipline colors print legibly on white background
- [x] Dot Timeline renders linearly (stages + milestones listed top-to-bottom)
- [x] File name: `{project-name}-milestones-{date}.pdf`

### JPEG Export
- [x] Uses `html2canvas` to capture the timeline element
- [x] Resolution: 2x device pixel ratio (retina quality)
- [x] Background: white (`#FFFFFF`)
- [x] Quality: 90% JPEG compression
- [x] File name: `{project-name}-milestones-{date}.jpg`

### Share UI
- [x] "Share" button: `Share2` icon from lucide-react
- [x] Clicking opens a dialog with:
  - [x] "Generate Link" button (if no active link)
  - [x] Active link display with copy-to-clipboard button
  - [x] Expiration info: "Expires on Mar 22, 2026"
  - [x] "Revoke Link" button with confirmation
  - [x] View count: "Viewed 12 times"
- [x] Only visible to admin users

### Export UI
- [x] "Export" button: `Download` icon from lucide-react
- [x] Dropdown: `rounded-lg shadow-md border border-gray-200`
- [x] Options: PDF icon + "Export as PDF", Image icon + "Export as JPEG"
- [x] Loading state during export generation (spinner on button)
- [x] Only visible to admin users

---

## Tasks

### Task 1: Backend — Shared Links CRUD (0.75 days)

1. **Create `shared_links` table migration**
   - Add `shared_links` table with columns as specified in AC
   - Add index on `share_token`

2. **Create `decision-log-backend/app/api/routes/shared_links.py`**
   ```python
   import secrets
   from datetime import datetime, timedelta
   from fastapi import APIRouter, Depends, HTTPException
   from sqlalchemy.orm import Session

   router = APIRouter()

   @router.post("/projects/{project_id}/milestones/share")
   async def create_share_link(
       project_id: str,
       body: CreateShareLinkRequest,
       db: Session = Depends(get_db),
       current_user = Depends(require_admin),
   ):
       token = secrets.token_urlsafe(32)
       expires_at = datetime.utcnow() + timedelta(days=body.expires_in_days or 30)
       link = SharedLink(
           project_id=project_id,
           share_token=token,
           resource_type="milestone_timeline",
           created_by=current_user.id,
           expires_at=expires_at,
       )
       db.add(link)
       db.commit()
       return {
           "share_token": token,
           "share_url": f"{settings.FRONTEND_URL}/shared/milestones/{token}",
           "expires_at": expires_at.isoformat(),
       }

   @router.get("/shared/milestones/{token}")
   async def view_shared_timeline(token: str, db: Session = Depends(get_db)):
       link = db.query(SharedLink).filter(
           SharedLink.share_token == token,
           SharedLink.revoked_at.is_(None),
           SharedLink.expires_at > datetime.utcnow(),
       ).first()
       if not link:
           raise HTTPException(status_code=404, detail="Shared link not found or expired")
       link.view_count += 1
       db.commit()
       # Return project + stages + milestones
       project = db.query(Project).get(link.project_id)
       stages = get_project_stages(db, link.project_id)
       milestones = get_project_milestones(db, link.project_id)
       return {"project": project, "stages": stages, "milestones": milestones}
   ```

3. **Create Pydantic models**
   - `CreateShareLinkRequest`: `expires_in_days: int = 30`
   - `ShareLinkResponse`: token, url, expires_at
   - `SharedTimelineResponse`: project, stages[], milestones[]

### Task 2: Frontend — Share Dialog (0.5 days)

1. **Create `src/components/molecules/ShareDialog.tsx`**
   - Radix Dialog with share link management
   - Generate, copy, revoke actions
   - View count display

2. **Add share API hooks to `src/hooks/useSharedLinks.ts`**
   ```typescript
   export function useCreateShareLink(projectId: string) {
     return useMutation({
       mutationFn: (expiresInDays?: number) =>
         api.post(`/projects/${projectId}/milestones/share`, { expires_in_days: expiresInDays }),
     })
   }

   export function useShareLinks(projectId: string) {
     return useQuery({
       queryKey: ['shareLinks', projectId],
       queryFn: () => api.get(`/projects/${projectId}/milestones/share`),
     })
   }
   ```

### Task 3: Frontend — Shared Timeline Route (0.5 days)

1. **Create `src/pages/SharedMilestoneTimeline.tsx`**
   - Route: `/shared/milestones/:token`
   - Fetches data from public endpoint
   - Renders `MilestoneTimeline` in read-only mode (no toggle, no filters editing)
   - Shows project name header + "Shared view" badge
   - Error state: "This link has expired or been revoked"

2. **Update router** to add the shared route (no auth wrapper)

### Task 4: Frontend — Export Functionality (0.5 days)

1. **Install export dependencies**
   ```bash
   npm install html2canvas jspdf
   npm install -D @types/html2canvas
   ```

2. **Create `src/lib/exportTimeline.ts`**
   ```typescript
   import html2canvas from 'html2canvas'
   import { jsPDF } from 'jspdf'

   export async function exportAsPDF(element: HTMLElement, projectName: string) {
     const canvas = await html2canvas(element, { scale: 2, backgroundColor: '#FFFFFF' })
     const pdf = new jsPDF('p', 'mm', 'a4')
     const pageWidth = pdf.internal.pageSize.getWidth()
     const imgWidth = pageWidth - 40 // 20mm margins
     const imgHeight = (canvas.height * imgWidth) / canvas.width

     // Header
     pdf.setFontSize(12)
     pdf.text(projectName, 20, 15)
     pdf.setFontSize(8)
     pdf.text(`Exported on ${new Date().toLocaleDateString('en-GB')}`, 20, 20)

     pdf.addImage(canvas.toDataURL('image/jpeg', 0.95), 'JPEG', 20, 25, imgWidth, imgHeight)

     // Footer
     pdf.setFontSize(8)
     pdf.text(`Page 1 — Generated by DecisionLog`, 20, pdf.internal.pageSize.getHeight() - 10)

     pdf.save(`${projectName}-milestones-${formatFileDate()}.pdf`)
   }

   export async function exportAsJPEG(element: HTMLElement, projectName: string) {
     const canvas = await html2canvas(element, { scale: 2, backgroundColor: '#FFFFFF' })
     const link = document.createElement('a')
     link.download = `${projectName}-milestones-${formatFileDate()}.jpg`
     link.href = canvas.toDataURL('image/jpeg', 0.9)
     link.click()
   }
   ```

### Task 5: Write Tests (0.5 days)

1. **Create `src/tests/components/ShareDialog.test.tsx`**
   - Generate link button calls API
   - Copy button copies URL to clipboard
   - Revoke button shows confirmation
   - View count displays correctly

2. **Create `src/tests/components/SharedMilestoneTimeline.test.tsx`**
   - Renders timeline from public data
   - Shows "Shared view" badge
   - No edit controls visible
   - Expired token shows error state

3. **Create `decision-log-backend/tests/test_shared_links.py`**
   - Token generation is unique
   - Expired tokens return 404
   - Revoked tokens return 404
   - View count increments
   - Non-admin cannot generate links

---

## Dev Notes

### Component Architecture

```
ProjectDetail (Page)
├── Milestone Timeline toolbar
│   ├── MilestoneFilterBar (Story 8.3)
│   ├── ShareButton → ShareDialog (Molecule)
│   │   ├── Generate Link
│   │   ├── Copy Link
│   │   ├── View Count
│   │   └── Revoke Link
│   └── ExportButton → Dropdown
│       ├── Export as PDF
│       └── Export as JPEG
└── MilestoneTimeline (Organism, ref for export capture)

SharedMilestoneTimeline (Page — /shared/milestones/:token)
├── Project Name Header + "Shared view" badge
└── MilestoneTimeline (Organism, read-only mode)
```

### Security Considerations

- Share tokens are cryptographically random (`secrets.token_urlsafe(32)`)
- Tokens expire after configurable period (default 30 days)
- Revoking immediately invalidates the link
- Public endpoint returns only milestone data — no user info, no edit capabilities
- Rate limiting on public endpoint to prevent abuse

### Export Library Choice

- `html2canvas` + `jsPDF` — client-side, no server resources needed
- Captures the DOM element directly — WYSIWYG output
- 2x scale for retina-quality output
- Alternative considered: server-side Puppeteer — rejected due to infrastructure complexity

---

## File List

**New Files:**
- `decision-log-backend/app/api/routes/shared_links.py` — Share link CRUD + public view endpoints (4 routes)
- `decision-log-backend/tests/unit/test_shared_links.py` — Backend tests (19 tests across 6 test classes)
- `decision-log-frontend/src/components/molecules/ShareDialog.tsx` — Radix Dialog for share link management
- `decision-log-frontend/src/components/organisms/MilestoneTimeline.tsx` — Dot Timeline component with readOnly + forwardRef
- `decision-log-frontend/src/hooks/useSharedLinks.ts` — React Query hooks for share API (4 hooks)
- `decision-log-frontend/src/pages/SharedMilestoneTimeline.tsx` — Public shared timeline page (no auth)
- `decision-log-frontend/src/lib/exportTimeline.ts` — PDF/JPEG export utilities (html2canvas + jsPDF)
- `decision-log-frontend/src/tests/components/ShareDialog.test.tsx` — 13 tests
- `decision-log-frontend/src/tests/components/SharedMilestoneTimeline.test.tsx` — 11 tests

**Modified Files:**
- `decision-log-backend/app/database/models.py` — Added SharedLink model with indexes
- `decision-log-backend/app/main.py` — Registered shared_links_router
- `decision-log-backend/app/api/middleware/auth.py` — Added `/api/shared/` to public paths
- `decision-log-frontend/src/App.tsx` — Added `/shared/milestones/:token` public route
- `decision-log-frontend/src/pages/ProjectDetail.tsx` — Added Milestones tab, Share/Export buttons (admin-only)
- `decision-log-frontend/package.json` — Added html2canvas, jspdf dependencies

**Package Dependencies:**
- `html2canvas` — DOM-to-canvas rendering
- `jspdf` — PDF generation

---

## Testing Strategy

### Unit Tests
```
- ✅ Share link generation returns valid token and URL
- ✅ Expired tokens return 404
- ✅ Revoked tokens return 404
- ✅ View count increments on access
- ✅ Non-admin users cannot generate/revoke links
- ✅ Share dialog renders generate/copy/revoke states
- ✅ Shared timeline page renders in read-only mode
- ✅ Export PDF triggers download
- ✅ Export JPEG triggers download
- ✅ Export respects current filter state
```

### Integration Tests
- Shared link end-to-end: generate → open in incognito → verify render → revoke → verify 404
- PDF export: verify file is generated with correct dimensions

### Coverage Target: 80%+

---

## Change Log

| Date | Change |
|------|--------|
| 2026-02-20 | Created story |
| 2026-02-28 | Implemented all 5 tasks: backend CRUD, share dialog, shared route, export, tests (24 FE + 19 BE tests passing) |

---

**Related Stories:** 8.1 (MilestoneTimeline component), 8.2 (milestone toggle), 8.3 (filters)
**Blocked By:** 8.1 (timeline must exist), 8.3 (filter state for export)
**Blocks:** None (closes E8)
