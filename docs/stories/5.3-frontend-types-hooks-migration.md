# Story 5.3: Frontend Types & Hooks Migration

**Story ID:** 5.3
**Epic:** E5 — Data Model Evolution & Project Item Taxonomy
**Assigned to:** @dev
**Sprint:** Sprint 1 (Week 2)
**Status:** Draft
**Estimation:** 5 story points (2 days)
**Co-dependent:** Story 5.2 (Backend API) — must deploy together (Architect Blocker B5)

---

## Summary

Migrate the frontend TypeScript types from `Decision` to `ProjectItem`, update React Query hooks from `useDecisions` to `useProjectItems`, extend the filter store with `itemTypes` and `sourceTypes` dimensions, and update all component imports. This story ensures the frontend codebase reflects the V2 Project Item model while maintaining backward compatibility during the transition via the `/decisions` endpoint.

**Strategy:** The new `useProjectItems` hook calls the new `/items` endpoint. The old `useDecisions` hook is preserved (calls `/decisions` backward-compat endpoint) and marked deprecated. Components are migrated incrementally — this story migrates types, hooks, and stores; visual changes come in E9.

---

## Acceptance Criteria

### TypeScript Types
- [ ] `src/types/projectItem.ts` created with:
  - [ ] `ProjectItem` interface (all V2 fields)
  - [ ] `ItemType` enum: `'idea' | 'topic' | 'decision' | 'action_item' | 'information'`
  - [ ] `SourceType` enum: `'meeting' | 'email' | 'document' | 'manual_input'`
  - [ ] `Discipline` enum (15 values matching PRD)
  - [ ] `ImpactsSchema` interface (structured)
  - [ ] `ConsensusEntry` interface (`{status, notes}`)
  - [ ] `ConsensusMap` type: `Record<Discipline, ConsensusEntry>`
  - [ ] `ProjectItemsResponse` interface (paginated with facets)
  - [ ] `ProjectItemFilters` interface (all V2 filter params)
  - [ ] `SourceInfo` interface (embedded source in item response)
- [ ] `src/types/decision.ts` preserved but marked with `@deprecated` JSDoc comment
- [ ] All types exported from `src/types/index.ts` barrel file

### React Query Hooks
- [ ] `src/hooks/useProjectItems.ts` created:
  - [ ] Calls `GET /api/projects/{id}/items` endpoint
  - [ ] Accepts filter params: `itemTypes[]`, `sourceTypes[]`, `disciplines[]`, `isMilestone`, `dateFrom`, `dateTo`, `search`
  - [ ] Uses filter store values as defaults
  - [ ] Returns `ProjectItemsResponse`
  - [ ] Cache key: `['projectItems', projectId, filters]`
  - [ ] Stale time: 5 minutes
- [ ] `src/hooks/useMilestones.ts` created:
  - [ ] Calls `GET /api/projects/{id}/milestones`
  - [ ] Returns milestone-only items
  - [ ] Cache key: `['milestones', projectId, filters]`
- [ ] `src/hooks/useProjectItemMutation.ts` created:
  - [ ] `useToggleMilestone` — PATCH is_milestone, optimistic update
  - [ ] `useToggleDone` — PATCH is_done, optimistic update
  - [ ] `useCreateManualItem` — POST manual item creation
  - [ ] Invalidates relevant cache keys on success
- [ ] `src/hooks/useDecisions.ts` preserved with `@deprecated` JSDoc, still functional

### Filter Store Update
- [ ] `src/store/filterStore.ts` extended with:
  - [ ] `itemTypes: string[]` — filter by item type
  - [ ] `sourceTypes: string[]` — filter by source type
  - [ ] `setItemTypes`, `toggleItemType`, `clearItemTypes` actions
  - [ ] `setSourceTypes`, `toggleSourceType`, `clearSourceTypes` actions
  - [ ] Existing `disciplines`, `decisionMakers`, `dateFrom`, `dateTo`, `searchQuery` preserved
  - [ ] `reset()` clears all filters including new ones
  - [ ] Persist key updated to `'filter-storage-v2'` (fresh start, avoid conflicts with V1 stored state)

### Component Import Updates
- [ ] All components importing `Decision` type updated to import `ProjectItem` from `types/projectItem`
- [ ] All components importing `useDecisions` updated to use `useProjectItems`
- [ ] All references to `decision.decision_statement` updated to `item.statement`
- [ ] All references to `decision.discipline` (string) updated to `item.affected_disciplines` (array)
- [ ] TypeScript compilation passes with zero errors: `npm run frontend:lint`

### Integration Verification
- [ ] Existing views render correctly after type migration (using backward-compat data shapes)
- [ ] TypeScript compilation passes with zero errors
- [ ] All existing tests pass with updated imports
- [ ] No runtime errors in dev server

---

## Tasks

### Task 1: Create ProjectItem Types (0.25 days)

1. **Create `src/types/projectItem.ts`**
   ```typescript
   // Item Type Enum
   export type ItemType = 'idea' | 'topic' | 'decision' | 'action_item' | 'information'

   // Source Type Enum
   export type SourceType = 'meeting' | 'email' | 'document' | 'manual_input'

   // Discipline Enum (15 values)
   export type Discipline =
     | 'architecture' | 'structural' | 'mep' | 'electrical' | 'plumbing'
     | 'landscape' | 'fire_protection' | 'acoustical' | 'sustainability'
     | 'civil' | 'client' | 'contractor' | 'tenant' | 'engineer' | 'general'

   export const ITEM_TYPES: ItemType[] = ['idea', 'topic', 'decision', 'action_item', 'information']
   export const SOURCE_TYPES: SourceType[] = ['meeting', 'email', 'document', 'manual_input']

   export interface ConsensusEntry {
     status: 'AGREE' | 'DISAGREE' | 'ABSTAIN'
     notes?: string | null
   }

   export type ConsensusMap = Partial<Record<Discipline, ConsensusEntry>>

   export interface ImpactsSchema {
     cost_impact?: string | null
     timeline_impact?: string | null
     scope_impact?: string | null
     risk_level?: 'low' | 'medium' | 'high' | null
     affected_areas?: string[] | null
   }

   export interface SourceInfo {
     id: string
     title: string
     type: SourceType
     occurred_at: string
   }

   export interface ProjectItem {
     id: string
     project_id: string
     statement: string
     who: string
     timestamp?: string
     item_type: ItemType
     source_type: SourceType
     affected_disciplines: Discipline[]
     is_milestone: boolean
     is_done: boolean
     owner?: string | null
     why?: string | null
     causation?: string | null
     impacts?: ImpactsSchema | null
     consensus?: ConsensusMap | null
     confidence?: number | null
     similar_items?: Array<{
       item_id: string
       similarity_score: number
       statement: string
     }> | null
     consistency_notes?: string | null
     anomaly_flags?: unknown[] | null
     source_excerpt?: string | null
     source?: SourceInfo | null
     created_at: string
     updated_at?: string | null
   }

   export interface ProjectItemsResponse {
     items: ProjectItem[]
     total: number
     limit: number
     offset: number
     facets?: {
       item_types: Record<string, number>
       source_types: Record<string, number>
       disciplines: Record<string, number>
     }
   }

   export interface ProjectItemFilters {
     itemTypes?: ItemType[]
     sourceTypes?: SourceType[]
     disciplines?: Discipline[]
     isMilestone?: boolean
     dateFrom?: string
     dateTo?: string
     search?: string
     sortBy?: string
     sortOrder?: 'asc' | 'desc'
     limit?: number
     offset?: number
   }
   ```

2. **Update `src/types/decision.ts`** — add deprecation comment
   ```typescript
   /**
    * @deprecated Use ProjectItem from types/projectItem.ts instead.
    * This type is preserved for backward compatibility only.
    */
   export interface Decision { ... }
   ```

### Task 2: Create New Hooks (0.5 days)

1. **Create `src/hooks/useProjectItems.ts`**
   - Calls `/api/projects/${projectId}/items`
   - Reads from filterStore for default filters
   - Constructs query params from `ProjectItemFilters`
   - Returns `UseQueryResult<ProjectItemsResponse>`

2. **Create `src/hooks/useMilestones.ts`**
   - Calls `/api/projects/${projectId}/milestones`
   - Returns `UseQueryResult<ProjectItemsResponse>`

3. **Create `src/hooks/useProjectItemMutation.ts`**
   - `useToggleMilestone(projectId, itemId)` — optimistic update
   - `useToggleDone(projectId, itemId)` — optimistic update
   - `useCreateManualItem(projectId)` — mutation with cache invalidation

### Task 3: Extend Filter Store (0.25 days)

1. **Modify `src/store/filterStore.ts`**
   - Add `itemTypes: string[]` and `sourceTypes: string[]` to state
   - Add toggle/set/clear actions for each
   - Update persist key to `'filter-storage-v2'`
   - Update `reset()` to clear new filters

### Task 4: Update Component Imports (0.5 days)

1. **Find and replace all Decision type imports**
   ```bash
   # Files that import from types/decision.ts:
   grep -r "from.*types/decision" src/ --include="*.ts" --include="*.tsx"
   ```
   - Update each file to import `ProjectItem` from `types/projectItem`
   - Update field access patterns:
     - `decision.decision_statement` → `item.statement`
     - `decision.discipline` → `item.affected_disciplines[0]` (transitional)
     - `decision.consensus` → handle new `ConsensusMap` shape

2. **Update existing components to work with both shapes during transition**

### Task 5: Write Tests (0.5 days)

1. **Create `src/tests/hooks/useProjectItems.test.ts`**
   - Hook returns items from API
   - Filters passed as query params
   - Cache key includes filters
   - Error handling

2. **Create `src/tests/hooks/useMilestones.test.ts`**
   - Returns milestone-only items
   - Cache invalidation on toggle

3. **Update existing component tests**
   - Update mock data from `Decision` to `ProjectItem` type
   - Update field references in assertions

---

## Dev Notes

### Migration Path for Components

Components don't need visual changes in this story — only type/import updates:

| Component | Change | Visual Change |
|-----------|--------|---------------|
| `Timeline.tsx` | Import ProjectItem, use `.statement` | None (E9 redesigns this) |
| `DecisionRow.tsx` | Import ProjectItem, use `.statement`, `.affected_disciplines[0]` | None |
| `DrilldownModal.tsx` | Import ProjectItem, handle new consensus shape | None |
| `FilterBar.tsx` | Use updated filterStore | None (E9 adds item/source filters) |
| `ProjectDetail.tsx` | Use `useProjectItems` hook | None |

### Discipline Array → Single Value (Transitional)

During the transition, components that render a single discipline badge should use:
```typescript
const primaryDiscipline = item.affected_disciplines[0] ?? 'general'
```
This preserves existing visual behavior. Multi-discipline display comes in Story 9.3.

### Filter Store Persist Key Change

Changing from `'filter-storage'` to `'filter-storage-v2'` means users' saved filter state will be reset. This is intentional — the V1 stored state shape is incompatible with V2 additions.

---

## File List

**New Files:**
- `src/types/projectItem.ts` — V2 type definitions
- `src/hooks/useProjectItems.ts` — V2 items hook
- `src/hooks/useMilestones.ts` — Milestones hook
- `src/hooks/useProjectItemMutation.ts` — Mutation hooks
- `src/tests/hooks/useProjectItems.test.ts` — Hook tests
- `src/tests/hooks/useMilestones.test.ts` — Hook tests

**Modified Files:**
- `src/types/decision.ts` — Add @deprecated JSDoc
- `src/store/filterStore.ts` — Add itemTypes, sourceTypes, new persist key
- `src/hooks/useDecisions.ts` — Add @deprecated JSDoc
- `src/components/organisms/Timeline.tsx` — Update imports
- `src/components/molecules/DecisionRow.tsx` — Update imports
- `src/components/organisms/DrilldownModal.tsx` — Update imports + consensus shape
- `src/pages/ProjectDetail.tsx` — Switch to useProjectItems
- All test files referencing Decision type

---

## Testing Strategy

### Unit Tests
```
- ✅ ProjectItem type properly typed
- ✅ useProjectItems fetches from /items endpoint
- ✅ useProjectItems passes filters as query params
- ✅ useMilestones fetches milestone-only items
- ✅ useToggleMilestone optimistic update
- ✅ filterStore new dimensions (itemTypes, sourceTypes)
- ✅ filterStore reset clears all dimensions
```

### Integration Verification
- `npm run frontend:lint` passes with zero errors
- `npm run frontend:test` all existing tests pass
- Dev server renders existing views without errors

### Coverage Target
- 80%+
- Run: `cd decision-log-frontend && npm run test`

---

## Change Log

| Date | Change |
|------|--------|
| 2026-02-16 | Created story |

---

**Related Stories:** 5.2 (Backend API — co-dependent), 9.1 (Visual badges), 9.2 (Dense rows)
**Blocked By:** 5.1 (DB Migration), 5.2 (API endpoints must exist)
**Co-dependent:** 5.2 (Must deploy frontend + backend together)
**Blocks:** 8.1 (Milestone Timeline uses useMilestones), 9.1 (Item badges use ProjectItem type)
