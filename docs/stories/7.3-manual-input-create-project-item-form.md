# Story 7.3: Manual Input — Create Project Item Form

**Story ID:** 7.3
**Epic:** E7 — Multi-Source Ingestion Pipeline
**Assigned to:** @dev
**Sprint:** Sprint 3 (Week 5)
**Status:** Draft
**Estimation:** 5 story points (2 days)
**Review:** @ux-design-expert (Uma) — form UX review
**UX Guidelines:** `docs/ux/UX-UI-GUIDELINES.md`

---

## Summary

Build the manual item creation form at `/projects/:id/items/new` that allows any team member to directly capture project items from informal conversations, whiteboard sessions, or external sources. The form supports all 5 item types with conditional field sets (action items get `owner` + `due_date`; decisions get a `consensus` structured input), multi-select from the 15 disciplines, and participant-aware `who` selection. Source type is auto-set to `manual_input`. On submit, the item is created via `POST /api/projects/{id}/items` (embedding happens server-side), bypasses the ingestion approval queue, and redirects to Project History with the new item highlighted.

---

## Acceptance Criteria

### Routing & Navigation
- [ ] `/projects/:id/items/new` route renders `ManualItemCreate` page
- [ ] `ManualItemCreate` page renders the `ManualItemForm` organism
- [ ] "Add Item" button on Project History page navigates to `/projects/:id/items/new`
- [ ] "Cancel" button returns to `/projects/:id/history` without saving

### Core Form Fields
- [ ] `statement` — required textarea, placeholder "Describe the item in one or two sentences", no character limit enforced
- [ ] `item_type` — required select dropdown with 5 options: `Idea`, `Topic`, `Decision`, `Action Item`, `Information` (values: `idea`, `topic`, `decision`, `action_item`, `information`)
- [ ] `affected_disciplines[]` — required multi-select from all 15 discipline values; uses checkbox list or chip-style input; at least 1 selection required
- [ ] `who` — required; text input with datalist populated from `GET /api/projects/{id}/participants` (allows free text if participant not in roster)
- [ ] `date` — required native date input (`<input type="date">`), defaults to today's date
- [ ] `context_notes` — optional textarea, label "Context / Notes", placeholder "Additional context, meeting reference, or source description"

### Conditional Fields — Action Item
- [ ] When `item_type === 'action_item'`: show `owner` field (text input with participant datalist, required for action items)
- [ ] When `item_type === 'action_item'`: show `due_date` field (native date input, optional)
- [ ] When `item_type !== 'action_item'`: `owner` and `due_date` fields are hidden and not submitted

### Conditional Fields — Decision
- [ ] When `item_type === 'decision'`: show `consensus` section with label "Consensus"
- [ ] Consensus section renders one row per selected discipline: discipline label + status select (`Agree`, `Disagree`, `Abstain`) + optional notes input
- [ ] Consensus rows update reactively when `affected_disciplines` selection changes
- [ ] When `item_type !== 'decision'`: consensus section is hidden and not submitted

### Source Type & Submission Behaviour
- [ ] `source_type` field is not rendered in the UI; value is hardcoded to `manual_input` in the request payload
- [ ] Submit button label: "Save Item"
- [ ] Form submits via `POST /api/projects/{id}/items` with full payload (see Dev Notes)
- [ ] Submit button shows loading state (`disabled`, spinner icon) during API call
- [ ] On success: navigate to `/projects/:id/history?highlight={newItemId}`
- [ ] On API error: display inline error banner above the submit button (do not navigate away)
- [ ] Manual items bypass ingestion approval — they are directly created and immediately visible

### Validation
- [ ] `statement` — shows inline error "Statement is required" if empty on submit
- [ ] `item_type` — shows inline error "Item type is required" if no selection on submit
- [ ] `affected_disciplines` — shows inline error "Select at least one discipline" if empty on submit
- [ ] `who` — shows inline error "Who is required" if empty on submit
- [ ] `date` — shows inline error "Date is required" if empty on submit
- [ ] All required field errors shown simultaneously on submit attempt (not one-by-one)
- [ ] Error messages linked to inputs via `aria-describedby`

### Accessibility
- [ ] All inputs have associated `<label>` elements
- [ ] Required fields marked with `*` (visible) and `aria-required="true"`
- [ ] Keyboard navigation: Tab through all visible fields, Enter triggers submit only when focus is on submit button
- [ ] Discipline multi-select checkboxes are keyboard-navigable (Space to toggle, Arrow keys to move)
- [ ] Consensus status selects labelled with discipline name for screen readers

### Responsive Design
- [ ] Mobile (375px): single-column, full-width inputs, disciplines in 2-column checkbox grid
- [ ] Tablet (768px): two-column layout for date/who row pairs
- [ ] Desktop (1024px+): form constrained to `max-w-2xl` centered

---

## Tasks

### Task 1: Create ManualItemForm Component (1 day)

1. **Create `src/components/organisms/ManualItemForm.tsx`**
   - Manages all form state locally with `useState` (no form library)
   - Fetches participant roster via `useParticipants(projectId)` hook for `who`/`owner` datalists
   - Calls `useCreateManualItem(projectId)` mutation on submit
   - Renders conditional sections based on `item_type` selection

   ```typescript
   interface ManualItemFormProps {
     projectId: string
   }

   interface ManualItemFormState {
     statement: string
     itemType: ItemType | ''
     affectedDisciplines: Discipline[]
     who: string
     date: string                   // ISO date string YYYY-MM-DD
     contextNotes: string
     // Conditional — action_item
     owner: string
     dueDate: string
     // Conditional — decision
     consensus: Partial<Record<Discipline, ConsensusFormEntry>>
   }

   interface ConsensusFormEntry {
     status: 'AGREE' | 'DISAGREE' | 'ABSTAIN' | ''
     notes: string
   }

   interface FormErrors {
     statement?: string
     itemType?: string
     affectedDisciplines?: string
     who?: string
     date?: string
   }
   ```

2. **Discipline multi-select** — render as a scrollable checkbox list grouped in a `fieldset` with `legend "Affected Disciplines *"`. Each checkbox:
   ```tsx
   <label key={d} className="flex items-center gap-2 text-sm cursor-pointer">
     <input
       type="checkbox"
       checked={affectedDisciplines.includes(d)}
       onChange={() => toggleDiscipline(d)}
       className="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
     />
     {DISCIPLINE_LABELS[d]}
   </label>
   ```

3. **Consensus section** — rendered beneath the disciplines section when `item_type === 'decision'`. Reactive: when disciplines change, consensus entries are added/removed while preserving existing values:
   ```typescript
   // Sync consensus entries when affectedDisciplines changes
   useEffect(() => {
     if (formState.itemType !== 'decision') return
     setFormState(prev => {
       const updated: Partial<Record<Discipline, ConsensusFormEntry>> = {}
       prev.affectedDisciplines.forEach(d => {
         updated[d] = prev.consensus[d] ?? { status: '', notes: '' }
       })
       return { ...prev, consensus: updated }
     })
   }, [formState.affectedDisciplines, formState.itemType])
   ```

### Task 2: Build Payload & Mutation Call (0.25 days)

1. **Payload construction** — called inside `handleSubmit`:
   ```typescript
   function buildPayload(state: ManualItemFormState): CreateManualItemPayload {
     const payload: CreateManualItemPayload = {
       statement: state.statement.trim(),
       item_type: state.itemType as ItemType,
       affected_disciplines: state.affectedDisciplines,
       who: state.who.trim(),
       date: state.date,
       source_type: 'manual_input',
       context_notes: state.contextNotes.trim() || undefined,
     }

     if (state.itemType === 'action_item') {
       payload.owner = state.owner.trim() || undefined
       payload.due_date = state.dueDate || undefined
     }

     if (state.itemType === 'decision') {
       const consensusMap: ConsensusMap = {}
       Object.entries(state.consensus).forEach(([disc, entry]) => {
         if (entry.status) {
           consensusMap[disc as Discipline] = {
             status: entry.status as ConsensusEntry['status'],
             notes: entry.notes || null,
           }
         }
       })
       payload.consensus = consensusMap
     }

     return payload
   }
   ```

2. **Submit handler**:
   ```typescript
   async function handleSubmit(e: React.FormEvent) {
     e.preventDefault()
     const errors = validate(formState)
     if (Object.keys(errors).length > 0) {
       setErrors(errors)
       return
     }
     try {
       const item = await createManualItem(buildPayload(formState))
       navigate(`/projects/${projectId}/history?highlight=${item.id}`)
     } catch (err) {
       setApiError('Failed to save item. Please try again.')
     }
   }
   ```

### Task 3: Create ManualItemCreate Page (0.25 days)

1. **Create `src/pages/ManualItemCreate.tsx`**
   ```typescript
   export function ManualItemCreate() {
     const { id: projectId } = useParams<{ id: string }>()
     if (!projectId) return null

     return (
       <div className="min-h-screen bg-gray-50">
         <div className="max-w-2xl mx-auto px-4 py-8">
           <div className="mb-6">
             <h1 className="text-2xl font-bold text-gray-900">Add Project Item</h1>
             <p className="text-sm text-gray-500 mt-1">
               Manually capture information from conversations or external sources.
             </p>
           </div>
           <ManualItemForm projectId={projectId} />
         </div>
       </div>
     )
   }
   ```

2. **Add route** to `src/App.tsx` (or route config file):
   ```tsx
   <Route path="/projects/:id/items/new" element={<ManualItemCreate />} />
   ```

### Task 4: Participants Hook & Datalist (0.25 days)

1. **Create `src/hooks/useParticipants.ts`** (if not already created by Story 6.1 frontend work):
   ```typescript
   export function useParticipants(projectId: string) {
     return useQuery({
       queryKey: ['participants', projectId],
       queryFn: () => api.get<Participant[]>(`/projects/${projectId}/participants`),
       staleTime: 10 * 60 * 1000, // 10 min — roster changes rarely
     })
   }
   ```

2. **Datalist for `who` and `owner` inputs**:
   ```tsx
   <datalist id="participants-list">
     {participants?.map(p => (
       <option key={p.id} value={p.name} />
     ))}
   </datalist>

   <input
     type="text"
     list="participants-list"
     value={formState.who}
     onChange={e => setField('who', e.target.value)}
     placeholder="Name or role"
     className="w-full border border-gray-300 rounded-md px-3 py-2 text-sm ..."
   />
   ```

### Task 5: Write Tests (0.25 days)

1. **Create `src/tests/components/ManualItemForm.test.tsx`**
   - See Testing Strategy section for full test case list

---

## Dev Notes

### Component Architecture

```
ManualItemCreate (Page)
└── ManualItemForm (Organism)
    ├── Statement textarea
    ├── Item Type select
    ├── Affected Disciplines fieldset (checkboxes, all 15)
    ├── Who input (text + datalist)
    ├── Date input
    ├── Context/Notes textarea (optional)
    ├── [Conditional: action_item] Owner input + Due Date input
    ├── [Conditional: decision] Consensus Section
    │   └── Per-discipline row: discipline label + status select + notes input
    ├── API Error banner
    └── Cancel button + Save Item button
```

### API Payload

`POST /api/projects/{id}/items` — request body:

```json
{
  "statement": "We will use CLT panels for the main roof structure",
  "item_type": "decision",
  "affected_disciplines": ["structural", "architecture"],
  "who": "Gabriela Sousa",
  "date": "2026-02-19",
  "source_type": "manual_input",
  "context_notes": "Agreed during informal walkthrough with contractor",
  "consensus": {
    "structural": { "status": "AGREE", "notes": null },
    "architecture": { "status": "AGREE", "notes": "Pending material spec confirmation" }
  }
}
```

Action item example:

```json
{
  "statement": "Send updated structural drawings to the contractor by end of week",
  "item_type": "action_item",
  "affected_disciplines": ["structural"],
  "who": "Rami",
  "date": "2026-02-19",
  "source_type": "manual_input",
  "owner": "Rami",
  "due_date": "2026-02-21"
}
```

### Discipline Constants

Use the shared constants from `src/types/projectItem.ts` (defined in Story 5.3):

```typescript
export const DISCIPLINE_LABELS: Record<Discipline, string> = {
  architecture:     'Architecture',
  structural:       'Structural',
  mep:              'MEP',
  electrical:       'Electrical',
  plumbing:         'Plumbing',
  landscape:        'Landscape',
  fire_protection:  'Fire Protection',
  acoustical:       'Acoustical',
  sustainability:   'Sustainability',
  civil:            'Civil',
  client:           'Client',
  contractor:       'Contractor',
  tenant:           'Tenant',
  engineer:         'Engineer',
  general:          'General',
}

export const ALL_DISCIPLINES: Discipline[] = Object.keys(DISCIPLINE_LABELS) as Discipline[]
```

If `DISCIPLINE_LABELS` is not yet exported from `src/types/projectItem.ts`, add it there — do not duplicate in the component.

### Item Type Select Options

```typescript
const ITEM_TYPE_OPTIONS: { value: ItemType; label: string }[] = [
  { value: 'idea',        label: 'Idea' },
  { value: 'topic',       label: 'Topic' },
  { value: 'decision',    label: 'Decision' },
  { value: 'action_item', label: 'Action Item' },
  { value: 'information', label: 'Information' },
]
```

### Tailwind Form Styling (consistent with Story 6.2)

```
Input / Textarea: border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 w-full
Label:            block text-sm font-medium text-gray-700 mb-1
Error message:    text-sm text-red-600 mt-1
Section card:     bg-white rounded-lg border border-gray-200 p-6 mb-6
Button primary:   bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 disabled:opacity-50
Button secondary: bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-50
Required marker:  text-red-500 ml-0.5 (the * character)
Error border:     border-red-500 focus:ring-red-500
```

### Highlight on Redirect

The Project History page (Story 9.4 / existing `/projects/:id/history`) should read `?highlight` from the URL search params and briefly highlight the matching item row (e.g., yellow flash animation for 2 seconds). If Story 9.4 is not yet implemented, the redirect still navigates to the correct page — highlighting is a progressive enhancement.

### Source Icon

Manual input items display the `PenLine` Lucide icon with `bg-gray-100 text-gray-700` badge (per UX-UI-GUIDELINES.md §2.8). This rendering happens in Project History (Story 9.4) — `ManualItemForm` does not need to render it.

### Embedding

Vector embedding is performed server-side after item creation (`POST /api/projects/{id}/items`). The frontend does not call any separate embedding endpoint. Backend Story 5.2 already includes embedding-on-create behaviour.

### Participants Endpoint

`GET /api/projects/{id}/participants` returns:
```json
[
  { "id": "uuid", "name": "Gabriela Sousa", "email": "g@soubim.com", "discipline": "client", "role": "Director" },
  ...
]
```
Defined in Story 6.1. If the hook `useParticipants` already exists from Story 6.2 frontend work, reuse it — do not create a duplicate.

---

## File List

**New Files:**
- `src/components/organisms/ManualItemForm.tsx` — Form component (organisms: has internal state + API calls)
- `src/pages/ManualItemCreate.tsx` — Page wrapper
- `src/tests/components/ManualItemForm.test.tsx` — Vitest + RTL tests

**New Files (if not already created):**
- `src/hooks/useParticipants.ts` — React Query hook for participant roster (check first — may exist from Story 6.2)

**Modified Files:**
- `src/App.tsx` (or route config) — Add `/projects/:id/items/new` route
- `src/types/projectItem.ts` — Add `DISCIPLINE_LABELS` and `ITEM_TYPE_OPTIONS` exports if missing
- `src/pages/ProjectHistory.tsx` (or equivalent) — Add "Add Item" button linking to `/projects/:id/items/new`

---

## Testing Strategy

### Unit Tests (`src/tests/components/ManualItemForm.test.tsx`)

```typescript
// Setup: mock useCreateManualItem, useParticipants, useNavigate
// Render: <ManualItemForm projectId="proj-123" />

describe('ManualItemForm', () => {
  // Rendering
  it('renders all base fields: statement, item_type, disciplines, who, date, context_notes')
  it('does not render conditional fields on initial render')
  it('defaults date to today')

  // Item type conditional logic
  it('shows owner and due_date fields when item_type is action_item')
  it('hides owner and due_date fields when item_type changes away from action_item')
  it('shows consensus section when item_type is decision')
  it('hides consensus section when item_type is not decision')

  // Discipline multi-select
  it('renders all 15 discipline checkboxes')
  it('toggles discipline selection on checkbox click')
  it('consensus section renders one row per selected discipline')
  it('preserves existing consensus values when disciplines change')
  it('removes consensus row when discipline is deselected')

  // Participants datalist
  it('populates datalist with participant names from API')
  it('allows free-text entry not in datalist')

  // Validation
  it('shows all required field errors simultaneously on empty submit')
  it('shows error for statement when blank')
  it('shows error for item_type when not selected')
  it('shows error for affected_disciplines when none selected')
  it('shows error for who when blank')
  it('shows error for date when blank')
  it('does not submit when validation fails')

  // Submission
  it('calls createManualItem with correct payload for decision type')
  it('calls createManualItem with correct payload for action_item type')
  it('sets source_type to manual_input in all payloads')
  it('excludes conditional fields from payload for non-matching item types')
  it('shows loading state on submit button during API call')
  it('navigates to /projects/:id/history?highlight={id} on success')
  it('shows error banner on API failure without navigating')

  // Accessibility
  it('all inputs have associated labels')
  it('required fields have aria-required="true"')
  it('error messages are linked via aria-describedby')
})
```

### Integration Verification
- [ ] IV1: Manually created item appears in Project History after form submission
- [ ] IV2: Item is searchable via semantic search (embedding generated server-side)
- [ ] IV3: Item displays `manual_input` source icon (`PenLine`) in Project History

### Coverage Target
- 80%+
- Run: `cd decision-log-frontend && npm run test`
- Run: `cd decision-log-frontend && npm run lint`

---

## Change Log

| Date | Change |
|------|--------|
| 2026-02-19 | Created story |

---

**Related Stories:** 9.4 (Project History shows `manual_input` source icon for manually created items)
**Blocked By:** 5.2 (POST /items API endpoint), 5.3 (ProjectItem types + useCreateManualItem hook), 6.1 (GET /participants endpoint)
**Blocks:** None
