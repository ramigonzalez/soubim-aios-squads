# Story 9.1: Component Evolution — Item Type Badges & Source Icons

**Story ID:** 9.1
**Epic:** E9 — Project History Enhancement
**Assigned to:** @dev
**Sprint:** Sprint 5 (Week 7)
**Status:** Ready for Review
**Estimation:** 5 story points (2 days)
**Review:** @ux-design-expert (Uma) — visual consistency with UX Guidelines
**UX Guidelines:** `docs/ux/UX-UI-GUIDELINES.md` (Sections 2.7, 2.8, 9.3, 11.3-11.5)

---

## Summary

Create three foundational atom components for V2: `ItemTypeBadge` (compact colored badge with icon per item type), `SourceIcon` (icon per source type), and `DisciplineCircle` (single-letter colored circle for disciplines). These atoms are the building blocks used across Project History (Story 9.2), Milestone Timeline (Story 8.1 inline versions replaced), and Drill-Down Modal. Add corresponding color/icon utility functions to `src/lib/utils.ts`.

---

## Acceptance Criteria

### ItemTypeBadge Atom
- [x] **Create `src/components/atoms/ItemTypeBadge.tsx`**
- [x] Renders compact inline badge with icon + optional label
- [x] Five item types with distinct colors and icons (from UX Guidelines 2.7):
  - [x] Decision: `CheckCircle2`, `bg-green-100 text-green-700`
  - [x] Topic: `MessageCircle`, `bg-amber-100 text-amber-700`
  - [x] Action Item: `Target`, `bg-blue-100 text-blue-700`
  - [x] Idea: `Lightbulb`, `bg-purple-100 text-purple-700`
  - [x] Information: `Info`, `bg-slate-100 text-slate-700`
- [x] Props: `type: ItemType`, `showLabel?: boolean` (default false for dense rows, true for expanded views)
- [x] Icon size: `w-3.5 h-3.5` (14px)
- [x] Badge styling: `inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium`
- [x] Fallback for unknown type: gray badge with `HelpCircle` icon

### SourceIcon Atom
- [x] **Create `src/components/atoms/SourceIcon.tsx`**
- [x] Renders icon per source type with optional label and tooltip
- [x] Four source types with distinct icons (from UX Guidelines 2.8):
  - [x] Meeting: `Video`, `text-indigo-600`
  - [x] Email: `Mail`, `text-sky-600`
  - [x] Document: `FileText`, `text-orange-600`
  - [x] Manual Input: `PenLine`, `text-gray-500`
- [x] Props: `type: SourceType`, `showLabel?: boolean`, `size?: 'sm' | 'md'`
- [x] Sizes: sm = `w-3.5 h-3.5`, md = `w-4 h-4`
- [x] Tooltip on hover: source type label (CSS tooltip, no Radix dependency)
- [x] Fallback for unknown source: `FileQuestion` icon in gray

### DisciplineCircle Atom
- [x] **Create `src/components/atoms/DisciplineCircle.tsx`**
- [x] Renders single-letter colored circle for a discipline
- [x] Size: `w-6 h-6 rounded-full` (24px)
- [x] Background: discipline hex color from canonical map
- [x] Text: white, first letter of abbreviation, `text-xs font-bold`
- [x] Props: `discipline: Discipline`, `isPrimary?: boolean`, `size?: 'sm' | 'md'`
- [x] Primary indicator: `ring-2 ring-white ring-offset-1` on the first/primary discipline
- [x] Sizes: sm = `w-5 h-5 text-[10px]`, md = `w-6 h-6 text-xs`
- [x] Fallback: gray circle with "?" for unknown disciplines

### DisciplineCircles Group (Molecule Helper)
- [x] **Create `src/components/atoms/DisciplineCircles.tsx`**
- [x] Renders a stacked group of DisciplineCircle components
- [x] Props: `disciplines: Discipline[]`, `max?: number` (default 3)
- [x] Shows first `max` circles with overlapping stack: `-ml-1` (like avatar groups)
- [x] First circle (primary) gets `isPrimary` ring indicator
- [x] Overflow: `+N` counter badge (`text-xs text-gray-500 ml-1`) when disciplines > max
- [x] Example: `[A][S][M] +2` for Architecture, Structural, MEP + 2 more

### Utility Functions
- [x] **Add to `src/lib/utils.ts`:**
  - [x] `getItemTypeColors(type: ItemType): { bg: string, text: string }` — returns Tailwind classes
  - [x] `getItemTypeIcon(type: ItemType): LucideIcon` — returns Lucide icon component
  - [x] `getItemTypeLabel(type: ItemType): string` — returns display label ("Action Item", not "action_item")
  - [x] `getSourceTypeColors(type: SourceType): { bg: string, text: string }` — returns Tailwind classes
  - [x] `getSourceTypeIcon(type: SourceType): LucideIcon` — returns Lucide icon component
  - [x] `getSourceTypeLabel(type: SourceType): string` — returns display label
  - [x] `getDisciplineCircleColor(discipline: Discipline): string` — returns hex color for circle bg
  - [x] `getDisciplineInitial(discipline: Discipline): string` — returns single letter (A, S, M, etc.)
- [x] All functions have fallback values for unknown/undefined inputs

### Design Consistency
- [x] All components follow the 100/700 pattern from UX Guidelines (light bg, dark text)
- [x] Color system matches PRD discipline enum (Section 2.2 of UX Guidelines)
- [x] Components designed for both dense row context (inline, compact) and expanded context (modal, card)
- [x] No new dependencies required — uses existing lucide-react and Tailwind

---

## Tasks

### Task 1: Add Utility Functions (0.25 days)

1. **Modify `src/lib/utils.ts`**
   ```typescript
   import { CheckCircle2, MessageCircle, Target, Lightbulb, Info, Video, Mail, FileText, PenLine, HelpCircle, FileQuestion } from 'lucide-react'
   import type { LucideIcon } from 'lucide-react'
   import type { ItemType, SourceType, Discipline } from '@/types/projectItem'

   // Item Type colors (UX Guidelines 2.7)
   const ITEM_TYPE_CONFIG: Record<ItemType, { bg: string; text: string; icon: LucideIcon; label: string }> = {
     decision:    { bg: 'bg-green-100',  text: 'text-green-700',  icon: CheckCircle2,  label: 'Decision' },
     topic:       { bg: 'bg-amber-100',  text: 'text-amber-700',  icon: MessageCircle, label: 'Topic' },
     action_item: { bg: 'bg-blue-100',   text: 'text-blue-700',   icon: Target,        label: 'Action Item' },
     idea:        { bg: 'bg-purple-100',  text: 'text-purple-700', icon: Lightbulb,     label: 'Idea' },
     information: { bg: 'bg-slate-100',   text: 'text-slate-700',  icon: Info,          label: 'Information' },
   }

   export function getItemTypeColors(type: ItemType) {
     return ITEM_TYPE_CONFIG[type] ?? { bg: 'bg-gray-100', text: 'text-gray-700' }
   }
   export function getItemTypeIcon(type: ItemType): LucideIcon {
     return ITEM_TYPE_CONFIG[type]?.icon ?? HelpCircle
   }
   export function getItemTypeLabel(type: ItemType): string {
     return ITEM_TYPE_CONFIG[type]?.label ?? type
   }

   // Source Type colors (UX Guidelines 2.8)
   const SOURCE_TYPE_CONFIG: Record<SourceType, { bg: string; text: string; icon: LucideIcon; label: string }> = {
     meeting:      { bg: 'bg-indigo-100', text: 'text-indigo-700', icon: Video,   label: 'Meeting' },
     email:        { bg: 'bg-sky-100',    text: 'text-sky-700',    icon: Mail,    label: 'Email' },
     document:     { bg: 'bg-orange-100', text: 'text-orange-700', icon: FileText, label: 'Document' },
     manual_input: { bg: 'bg-gray-100',   text: 'text-gray-700',   icon: PenLine, label: 'Manual Input' },
   }

   export function getSourceTypeColors(type: SourceType) {
     return SOURCE_TYPE_CONFIG[type] ?? { bg: 'bg-gray-100', text: 'text-gray-700' }
   }
   export function getSourceTypeIcon(type: SourceType): LucideIcon {
     return SOURCE_TYPE_CONFIG[type]?.icon ?? FileQuestion
   }
   export function getSourceTypeLabel(type: SourceType): string {
     return SOURCE_TYPE_CONFIG[type]?.label ?? type
   }

   // Discipline circle helpers
   const DISCIPLINE_CIRCLE_COLORS: Record<Discipline, string> = {
     architecture: '#3B82F6', structural: '#8B5CF6', mep: '#F97316',
     electrical: '#F59E0B', plumbing: '#06B6D4', landscape: '#10B981',
     fire_protection: '#EF4444', acoustical: '#7C3AED', sustainability: '#059669',
     civil: '#14B8A6', client: '#F43F5E', contractor: '#D97706',
     tenant: '#EC4899', engineer: '#6366F1', general: '#6B7280',
   }

   const DISCIPLINE_INITIALS: Record<Discipline, string> = {
     architecture: 'A', structural: 'S', mep: 'M', electrical: 'E',
     plumbing: 'P', landscape: 'L', fire_protection: 'F', acoustical: 'Ac',
     sustainability: 'Su', civil: 'C', client: 'Cl', contractor: 'Co',
     tenant: 'T', engineer: 'En', general: 'G',
   }

   export function getDisciplineCircleColor(discipline: Discipline): string {
     return DISCIPLINE_CIRCLE_COLORS[discipline] ?? '#6B7280'
   }
   export function getDisciplineInitial(discipline: Discipline): string {
     return DISCIPLINE_INITIALS[discipline] ?? '?'
   }
   ```

### Task 2: Create ItemTypeBadge Atom (0.25 days)

1. **Create `src/components/atoms/ItemTypeBadge.tsx`**
   ```tsx
   import { cn } from '@/lib/utils'
   import { getItemTypeColors, getItemTypeIcon, getItemTypeLabel } from '@/lib/utils'
   import type { ItemType } from '@/types/projectItem'

   interface ItemTypeBadgeProps {
     type: ItemType
     showLabel?: boolean
     className?: string
   }

   export function ItemTypeBadge({ type, showLabel = false, className }: ItemTypeBadgeProps) {
     const { bg, text } = getItemTypeColors(type)
     const Icon = getItemTypeIcon(type)
     const label = getItemTypeLabel(type)

     return (
       <span
         className={cn('inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium', bg, text, className)}
         title={label}
       >
         <Icon className="w-3.5 h-3.5" aria-hidden="true" />
         {showLabel && <span>{label}</span>}
       </span>
     )
   }
   ```

### Task 3: Create SourceIcon Atom (0.25 days)

1. **Create `src/components/atoms/SourceIcon.tsx`**
   ```tsx
   import { cn } from '@/lib/utils'
   import { getSourceTypeIcon, getSourceTypeLabel } from '@/lib/utils'
   import type { SourceType } from '@/types/projectItem'

   interface SourceIconProps {
     type: SourceType
     showLabel?: boolean
     size?: 'sm' | 'md'
     className?: string
   }

   const SIZE_MAP = { sm: 'w-3.5 h-3.5', md: 'w-4 h-4' }
   const COLOR_MAP: Record<SourceType, string> = {
     meeting: 'text-indigo-600', email: 'text-sky-600',
     document: 'text-orange-600', manual_input: 'text-gray-500',
   }

   export function SourceIcon({ type, showLabel = false, size = 'sm', className }: SourceIconProps) {
     const Icon = getSourceTypeIcon(type)
     const label = getSourceTypeLabel(type)
     const color = COLOR_MAP[type] ?? 'text-gray-400'

     return (
       <span className={cn('inline-flex items-center gap-1 group/source relative', className)} title={label}>
         <Icon className={cn(SIZE_MAP[size], color)} aria-hidden="true" />
         {showLabel && <span className="text-xs text-gray-600">{label}</span>}
       </span>
     )
   }
   ```

### Task 4: Create DisciplineCircle + DisciplineCircles (0.5 days)

1. **Create `src/components/atoms/DisciplineCircle.tsx`**
   ```tsx
   import { cn } from '@/lib/utils'
   import { getDisciplineCircleColor, getDisciplineInitial } from '@/lib/utils'
   import type { Discipline } from '@/types/projectItem'

   interface DisciplineCircleProps {
     discipline: Discipline
     isPrimary?: boolean
     size?: 'sm' | 'md'
     className?: string
   }

   export function DisciplineCircle({ discipline, isPrimary = false, size = 'md', className }: DisciplineCircleProps) {
     const bgColor = getDisciplineCircleColor(discipline)
     const initial = getDisciplineInitial(discipline)

     return (
       <span
         className={cn(
           'inline-flex items-center justify-center rounded-full text-white font-bold',
           size === 'sm' ? 'w-5 h-5 text-[10px]' : 'w-6 h-6 text-xs',
           isPrimary && 'ring-2 ring-white ring-offset-1',
           className,
         )}
         style={{ backgroundColor: bgColor }}
         title={discipline}
         aria-label={discipline}
       >
         {initial}
       </span>
     )
   }
   ```

2. **Create `src/components/atoms/DisciplineCircles.tsx`**
   ```tsx
   import { DisciplineCircle } from './DisciplineCircle'
   import type { Discipline } from '@/types/projectItem'

   interface DisciplineCirclesProps {
     disciplines: Discipline[]
     max?: number
   }

   export function DisciplineCircles({ disciplines, max = 3 }: DisciplineCirclesProps) {
     const visible = disciplines.slice(0, max)
     const overflow = disciplines.length - max

     return (
       <span className="inline-flex items-center">
         {visible.map((d, i) => (
           <DisciplineCircle
             key={d}
             discipline={d}
             isPrimary={i === 0}
             className={i > 0 ? '-ml-1' : ''}
           />
         ))}
         {overflow > 0 && (
           <span className="text-xs text-gray-500 ml-1">+{overflow}</span>
         )}
       </span>
     )
   }
   ```

### Task 5: Write Tests (0.75 days)

1. **Create `src/tests/components/ItemTypeBadge.test.tsx`**
   - Renders correct icon and color for each of 5 types
   - Shows label when `showLabel` is true
   - Hides label by default
   - Renders fallback for unknown type
   - Has title attribute for accessibility

2. **Create `src/tests/components/SourceIcon.test.tsx`**
   - Renders correct icon for each of 4 source types
   - Shows label when `showLabel` is true
   - Renders in sm and md sizes
   - Fallback for unknown source

3. **Create `src/tests/components/DisciplineCircle.test.tsx`**
   - Renders correct initial letter and color
   - Primary discipline has ring indicator
   - Renders in sm and md sizes
   - Fallback for unknown discipline

4. **Create `src/tests/components/DisciplineCircles.test.tsx`**
   - Shows max 3 circles by default
   - Overflow count shown correctly
   - First circle marked as primary
   - Overlapping stack via -ml-1

---

## Dev Notes

### Replace Inline Implementations from Story 8.1

Story 8.1 created temporary inline versions (`ItemTypeBadgeInline`, `SourceIconInline`, `DisciplineCircles`). After Story 9.1 ships:
- Replace `ItemTypeBadgeInline` → import `ItemTypeBadge` from `@/components/atoms/ItemTypeBadge`
- Replace `SourceIconInline` → import `SourceIcon` from `@/components/atoms/SourceIcon`
- Replace inline `DisciplineCircles` → import from `@/components/atoms/DisciplineCircles`

### Existing Utils Pattern

Follow the established pattern in `src/lib/utils.ts`:
- `getDisciplinePillColors(discipline)` — existing, returns `{ bg, text }`
- `getDisciplineNodeColor(discipline)` — existing, returns hex bg
- New functions follow same return shape

### Color Consistency

All colors must match:
- PRD Section "Discipline Enum & Color Map" — canonical discipline colors
- UX Guidelines Section 2.7 — item type colors
- UX Guidelines Section 2.8 — source type colors

---

## File List

**New Files:**
- `src/types/projectItem.ts` — V2 type definitions (ItemType, SourceType, Discipline enums, ProjectItem interface)
- `src/components/atoms/ItemTypeBadge.tsx` — Item type badge atom
- `src/components/atoms/SourceIcon.tsx` — Source type icon atom
- `src/components/atoms/DisciplineCircle.tsx` — Single discipline circle atom
- `src/components/atoms/DisciplineCircles.tsx` — Stacked discipline circles group
- `src/tests/components/ItemTypeBadge.test.tsx` — 10 tests
- `src/tests/components/SourceIcon.test.tsx` — 8 tests
- `src/tests/components/DisciplineCircle.test.tsx` — 7 tests
- `src/tests/components/DisciplineCircles.test.tsx` — 6 tests

**Modified Files:**
- `src/lib/utils.ts` — Add item type, source type, discipline circle utility functions (8 new exports)
- `src/components/organisms/MilestoneTimeline.tsx` — Replace inline atoms with proper imports (follow-up)

---

## Testing Strategy

### Unit Tests
```
- ✅ ItemTypeBadge renders all 5 types with correct colors and icons
- ✅ ItemTypeBadge label visibility toggle
- ✅ SourceIcon renders all 4 types with correct icons
- ✅ SourceIcon sizes (sm/md)
- ✅ DisciplineCircle renders correct initial and background color
- ✅ DisciplineCircle primary ring indicator
- ✅ DisciplineCircles stacking and overflow
- ✅ Utility functions return correct values
- ✅ Fallback values for unknown enums
```

### Snapshot Tests
- Snapshot each component variant for visual regression

### Coverage Target: 90%+

---

## Change Log

| Date | Change |
|------|--------|
| 2026-02-20 | Created story |
| 2026-02-27 | Implemented all tasks: utils.ts utilities, 4 atom components, 4 test files (31 tests). Created prerequisite projectItem.ts types file. All tests pass. |

---

**Related Stories:** 3.5 (existing DisciplinePill), 5.3 (TypeScript types), 8.1 (inline versions to replace), 9.2 (uses these atoms in Dense Rows)
**Blocked By:** 5.3 (ProjectItem types with ItemType, SourceType, Discipline enums)
**Blocks:** 9.2 (Dense Rows needs these atoms), 9.3 (DisciplineCircle extended usage), 9.4 (filter badges)
