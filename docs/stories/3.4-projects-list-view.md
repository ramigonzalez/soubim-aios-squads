# Story 3.4: Projects List View

**Story ID:** 3.4
**Assigned to:** @dev
**Sprint:** Sprint 4 (Week 6)
**Status:** Draft
**Estimation:** 5 story points (2-3 days)

---

## Summary

Create a projects list view that displays all accessible projects in a grid layout with project cards showing key metrics, decision counts, and last activity. Includes empty state, loading state, and navigation to project detail pages.

---

## Acceptance Criteria

- [ ] Projects fetched from `/api/projects` on page load
- [ ] Project cards display:
  - [ ] Project name
  - [ ] Description (truncated to 100 chars)
  - [ ] Team member count
  - [ ] Total decision count
  - [ ] Last decision date (relative time)
  - [ ] Project created date
- [ ] Grid layout responsive:
  - [ ] Mobile: 1 column
  - [ ] Tablet: 2 columns
  - [ ] Desktop: 3 columns
- [ ] Click project card → Navigate to project detail page
- [ ] Loading state with skeleton cards
- [ ] Empty state when no projects exist
- [ ] Error handling with retry button
- [ ] Tests passing: `npm run test` (80%+ coverage)

---

## Tasks

### Task 1: Create Projects Page Component (1 day)

1. **Create `src/pages/Projects.tsx`**
   ```typescript
   import { useQuery } from '@tanstack/react-query'
   import { api } from '../services/api'
   import { Header } from '../components/Header'
   import { ProjectCard } from '../components/ProjectCard'
   import { ProjectCardSkeleton } from '../components/ProjectCard'
   import { Alert, AlertDescription } from '../components/ui/alert'
   import { Button } from '../components/ui/button'
   import { getErrorMessage } from '../lib/errors'

   export function ProjectsPage() {
     const {
       data: projectsData,
       isLoading,
       isError,
       error,
       refetch
     } = useQuery({
       queryKey: ['projects'],
       queryFn: () => api.getProjects(),
     })

     return (
       <div className="min-h-screen bg-gray-50">
         <Header />

         <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
           <div className="mb-8">
             <h1 className="text-3xl font-bold text-gray-900">Projects</h1>
             <p className="mt-2 text-gray-600">
               View and manage your architectural projects
             </p>
           </div>

           {isError && (
             <Alert variant="destructive" className="mb-6">
               <AlertDescription className="flex items-center justify-between">
                 <span>{getErrorMessage(error)}</span>
                 <Button variant="outline" size="sm" onClick={() => refetch()}>
                   Retry
                 </Button>
               </AlertDescription>
             </Alert>
           )}

           {isLoading ? (
             <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
               {[1, 2, 3, 4, 5, 6].map((i) => (
                 <ProjectCardSkeleton key={i} />
               ))}
             </div>
           ) : projectsData?.projects.length === 0 ? (
             <EmptyState />
           ) : (
             <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
               {projectsData?.projects.map((project) => (
                 <ProjectCard key={project.id} project={project} />
               ))}
             </div>
           )}

           {projectsData && projectsData.projects.length > 0 && (
             <div className="mt-6 text-sm text-gray-500 text-center">
               Showing {projectsData.projects.length} of {projectsData.total} projects
             </div>
           )}
         </main>
       </div>
     )
   }

   function EmptyState() {
     return (
       <div className="text-center py-12">
         <div className="mx-auto h-24 w-24 text-gray-400">
           <svg
             fill="none"
             stroke="currentColor"
             viewBox="0 0 24 24"
             xmlns="http://www.w3.org/2000/svg"
           >
             <path
               strokeLinecap="round"
               strokeLinejoin="round"
               strokeWidth={2}
               d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"
             />
           </svg>
         </div>
         <h3 className="mt-4 text-lg font-medium text-gray-900">No projects</h3>
         <p className="mt-2 text-gray-500">
           You don't have access to any projects yet.
         </p>
       </div>
     )
   }
   ```

### Task 2: Create Project Card Component (0.75 days)

1. **Create `src/components/ProjectCard.tsx`**
   ```typescript
   import { useNavigate } from 'react-router-dom'
   import { Project } from '../types'
   import { formatDate } from '../lib/utils'
   import { formatDistanceToNow } from 'date-fns'
   import { Card, CardHeader, CardTitle, CardDescription, CardContent } from './ui/card'
   import { Users, FileText, Clock } from 'lucide-react'

   interface Props {
     project: Project
   }

   export function ProjectCard({ project }: Props) {
     const navigate = useNavigate()

     const handleClick = () => {
       navigate(`/projects/${project.id}`)
     }

     const latestDecisionTime = project.latest_decision
       ? formatDistanceToNow(new Date(project.latest_decision), { addSuffix: true })
       : 'No decisions yet'

     return (
       <Card
         className="cursor-pointer hover:shadow-lg transition-shadow"
         onClick={handleClick}
       >
         <CardHeader>
           <CardTitle className="text-xl">{project.name}</CardTitle>
           <CardDescription className="line-clamp-2">
             {project.description || 'No description'}
           </CardDescription>
         </CardHeader>

         <CardContent>
           <div className="space-y-3">
             <div className="flex items-center text-sm text-gray-600">
               <Users className="h-4 w-4 mr-2" />
               <span>{project.member_count} team members</span>
             </div>

             <div className="flex items-center text-sm text-gray-600">
               <FileText className="h-4 w-4 mr-2" />
               <span>{project.decision_count} decisions</span>
             </div>

             <div className="flex items-center text-sm text-gray-600">
               <Clock className="h-4 w-4 mr-2" />
               <span>Updated {latestDecisionTime}</span>
             </div>

             <div className="pt-3 border-t text-xs text-gray-500">
               Created {formatDate(project.created_at)}
             </div>
           </div>
         </CardContent>
       </Card>
     )
   }

   export function ProjectCardSkeleton() {
     return (
       <Card>
         <CardHeader>
           <div className="h-6 bg-gray-200 rounded animate-pulse mb-2" />
           <div className="h-4 bg-gray-200 rounded animate-pulse w-3/4" />
         </CardHeader>

         <CardContent>
           <div className="space-y-3">
             <div className="h-4 bg-gray-200 rounded animate-pulse" />
             <div className="h-4 bg-gray-200 rounded animate-pulse" />
             <div className="h-4 bg-gray-200 rounded animate-pulse w-2/3" />
           </div>
         </CardContent>
       </Card>
     )
   }
   ```

2. **Install Shadcn components and date-fns**
   ```bash
   npx shadcn-ui@latest add card
   npm install date-fns
   ```

### Task 3: Add Placeholder Pages (0.25 days)

1. **Create `src/pages/ProjectDetail.tsx` (placeholder)**
   ```typescript
   import { useParams } from 'react-router-dom'
   import { Header } from '../components/Header'

   export function ProjectDetailPage() {
     const { id } = useParams<{ id: string }>()

     return (
       <div className="min-h-screen bg-gray-50">
         <Header />

         <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
           <h1 className="text-3xl font-bold">Project Detail: {id}</h1>
           <p className="mt-4 text-gray-600">Coming soon in Story 3.5</p>
         </main>
       </div>
     )
   }
   ```

### Task 4: Add Loading and Error States (0.5 days)

1. **Update utility functions in `src/lib/utils.ts`**
   ```typescript
   import { type ClassValue, clsx } from "clsx"
   import { twMerge } from "tailwind-merge"

   export function cn(...inputs: ClassValue[]) {
     return twMerge(clsx(inputs))
   }

   export function formatDate(date: string): string {
     return new Date(date).toLocaleDateString('en-US', {
       year: 'numeric',
       month: 'short',
       day: 'numeric'
     })
   }

   export function formatDateTime(date: string): string {
     return new Date(date).toLocaleString('en-US', {
       year: 'numeric',
       month: 'short',
       day: 'numeric',
       hour: '2-digit',
       minute: '2-digit'
     })
   }

   export function truncate(str: string, length: number): string {
     if (str.length <= length) return str
     return str.slice(0, length) + '...'
   }
   ```

2. **Add retry logic to React Query**
   ```typescript
   // Already configured in App.tsx
   const queryClient = new QueryClient({
     defaultOptions: {
       queries: {
         refetchOnWindowFocus: false,
         retry: 1,
         staleTime: 5 * 60 * 1000,
       },
     },
   })
   ```

### Task 5: Write Tests (0.5 days)

1. **Create `tests/pages/Projects.test.tsx`**
   ```typescript
   import { describe, it, expect, vi } from 'vitest'
   import { render, screen, waitFor } from '@testing-library/react'
   import { BrowserRouter } from 'react-router-dom'
   import { QueryClient, QueryClientProvider } from '@tanstack/react-query'
   import { ProjectsPage } from '../../src/pages/Projects'
   import { api } from '../../src/services/api'

   vi.mock('../../src/services/api')

   const queryClient = new QueryClient({
     defaultOptions: { queries: { retry: false } },
   })

   const wrapper = ({ children }: { children: React.ReactNode }) => (
     <QueryClientProvider client={queryClient}>
       <BrowserRouter>
         {children}
       </BrowserRouter>
     </QueryClientProvider>
   )

   describe('ProjectsPage', () => {
     it('displays loading state initially', () => {
       vi.mocked(api.getProjects).mockImplementation(
         () => new Promise(() => {}) // Never resolves
       )

       render(<ProjectsPage />, { wrapper })

       expect(screen.getByText('Projects')).toBeInTheDocument()
       // Skeleton cards should be visible
     })

     it('displays projects when loaded', async () => {
       const mockProjects = {
         projects: [
           {
             id: '1',
             name: 'Test Project',
             description: 'Test description',
             created_at: '2026-01-01T00:00:00Z',
             member_count: 5,
             decision_count: 42,
             latest_decision: '2026-02-01T00:00:00Z',
           },
         ],
         total: 1,
         limit: 50,
         offset: 0,
       }

       vi.mocked(api.getProjects).mockResolvedValue(mockProjects)

       render(<ProjectsPage />, { wrapper })

       await waitFor(() => {
         expect(screen.getByText('Test Project')).toBeInTheDocument()
         expect(screen.getByText('Test description')).toBeInTheDocument()
         expect(screen.getByText(/5 team members/i)).toBeInTheDocument()
         expect(screen.getByText(/42 decisions/i)).toBeInTheDocument()
       })
     })

     it('displays empty state when no projects', async () => {
       vi.mocked(api.getProjects).mockResolvedValue({
         projects: [],
         total: 0,
         limit: 50,
         offset: 0,
       })

       render(<ProjectsPage />, { wrapper })

       await waitFor(() => {
         expect(screen.getByText(/no projects/i)).toBeInTheDocument()
       })
     })

     it('displays error state on failure', async () => {
       vi.mocked(api.getProjects).mockRejectedValue(new Error('Network error'))

       render(<ProjectsPage />, { wrapper })

       await waitFor(() => {
         expect(screen.getByText(/network error/i)).toBeInTheDocument()
         expect(screen.getByRole('button', { name: /retry/i })).toBeInTheDocument()
       })
     })
   })
   ```

2. **Create `tests/components/ProjectCard.test.tsx`**
   ```typescript
   import { describe, it, expect, vi } from 'vitest'
   import { render, screen, fireEvent } from '@testing-library/react'
   import { BrowserRouter } from 'react-router-dom'
   import { ProjectCard } from '../../src/components/ProjectCard'

   const mockNavigate = vi.fn()
   vi.mock('react-router-dom', async () => {
     const actual = await vi.importActual('react-router-dom')
     return {
       ...actual,
       useNavigate: () => mockNavigate,
     }
   })

   const mockProject = {
     id: '1',
     name: 'Test Project',
     description: 'Test description for this project',
     created_at: '2026-01-01T00:00:00Z',
     member_count: 5,
     decision_count: 42,
     latest_decision: '2026-02-01T00:00:00Z',
   }

   describe('ProjectCard', () => {
     it('renders project information correctly', () => {
       render(
         <BrowserRouter>
           <ProjectCard project={mockProject} />
         </BrowserRouter>
       )

       expect(screen.getByText('Test Project')).toBeInTheDocument()
       expect(screen.getByText('Test description for this project')).toBeInTheDocument()
       expect(screen.getByText(/5 team members/i)).toBeInTheDocument()
       expect(screen.getByText(/42 decisions/i)).toBeInTheDocument()
     })

     it('navigates to project detail on click', () => {
       render(
         <BrowserRouter>
           <ProjectCard project={mockProject} />
         </BrowserRouter>
       )

       const card = screen.getByText('Test Project').closest('div[class*="cursor-pointer"]')
       fireEvent.click(card!)

       expect(mockNavigate).toHaveBeenCalledWith('/projects/1')
     })

     it('handles missing description', () => {
       const projectNoDesc = { ...mockProject, description: null }

       render(
         <BrowserRouter>
           <ProjectCard project={projectNoDesc} />
         </BrowserRouter>
       )

       expect(screen.getByText('No description')).toBeInTheDocument()
     })
   })
   ```

---

## Dev Notes

### Component Architecture

```
ProjectsPage
├── Header (navigation + logout)
├── Error Alert (conditional)
├── Loading Skeletons (conditional)
├── Empty State (conditional)
└── Project Grid
    └── ProjectCard (repeating)
        ├── Project name
        ├── Description
        ├── Metrics (members, decisions)
        └── Last activity
```

### Responsive Grid

```css
/* Tailwind classes */
grid grid-cols-1           /* Mobile: 1 column */
md:grid-cols-2             /* Tablet: 2 columns */
lg:grid-cols-3             /* Desktop: 3 columns */
gap-6                      /* 24px gap */
```

### Data Flow

```
1. Page loads → useQuery('projects')
2. Show skeleton loading state
3. Fetch from API → api.getProjects()
4. Store in React Query cache (5 min stale time)
5. Render ProjectCard for each project
6. Click card → Navigate to /projects/:id
```

---

## File List

**Modified/Created:**
- `src/pages/Projects.tsx` (new) - Projects list page
- `src/pages/ProjectDetail.tsx` (new) - Placeholder for next story
- `src/components/ProjectCard.tsx` (new) - Project card component
- `src/lib/utils.ts` (modify) - Add formatting utilities
- `tests/pages/Projects.test.tsx` (new) - Page tests
- `tests/components/ProjectCard.test.tsx` (new) - Component tests
- `package.json` (modify) - Add date-fns

---

## Testing Strategy

### Unit Tests

```typescript
// Test coverage areas:
- ✅ Projects page rendering
- ✅ Loading state display
- ✅ Projects list display
- ✅ Empty state handling
- ✅ Error state with retry
- ✅ Project card rendering
- ✅ Card click navigation
- ✅ Date formatting
- ✅ Responsive grid layout
```

### Manual Testing

```bash
# Test scenarios
1. Start dev server: npm run dev
2. Login and navigate to /projects
3. Verify projects display in grid
4. Click a project card (should navigate)
5. Test responsive design (resize browser)
6. Test empty state (if no projects)
7. Test error state (disconnect network)
```

### Coverage Target

- Minimum: 80%
- Target: 90%+
- Run: `npm run test -- --coverage`

---

## Change Log

| Date | Change |
|------|--------|
| 2026-02-08 | Created story |

---

**Related Stories:** 3.3 (Authentication), 3.5 (Timeline)
**Blocked By:** 3.3
**Blocks:** 3.5 (needs project selection)
