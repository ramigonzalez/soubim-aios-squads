# Story 8.2: Frontend — Milestone Flag Toggle

**Story ID:** 8.2
**Epic:** E8 — Milestone Timeline
**Assigned to:** @dev
**Sprint:** Sprint 3 (Week 5)
**Status:** Complete
**Estimation:** 5 story points (2 days)
**UX Guidelines:** `docs/ux/UX-UI-GUIDELINES.md`

---

## Summary

Allow admin users (Gabriela) to mark or unmark any project item as a milestone from three places: the Project History view (inline on each row), the Drill-Down Modal, and the Milestone Timeline itself (to unmark). The toggle uses a star icon with optimistic UI so changes feel instant, with automatic rollback on API error.

---

## Acceptance Criteria

### Star Toggle Visual
- [x] `MilestoneStarToggle` molecule created with `Star` icon from lucide-react
- [x] Active state: `fill-current text-yellow-500` (filled gold star)
- [x] Inactive state: `text-gray-300` (outline star), visible only on hover in row context
- [x] Already-flagged milestones always show the filled star (no hover required)
- [x] Icon size: `w-4 h-4` in rows, `w-5 h-5` in DrilldownModal header
- [x] `aria-label="Mark as milestone"` / `aria-label="Remove milestone"` based on state
- [x] `role="button"` + `tabIndex={0}` + keyboard Enter/Space support

### Integration Points
- [x] **Project History rows**: star appears right-aligned in `ProjectItemRow` (or existing `DecisionRow`)
  - [x] Non-milestone items: star visible only on row hover (`group-hover:opacity-100 opacity-0 transition-opacity`)
  - [x] Milestone items: star always visible (filled gold)
- [x] **DrilldownModal**: star appears in modal header next to item statement
  - [x] Click toggles milestone status from within modal
- [x] **MilestoneTimeline**: milestone nodes show star on hover, allowing unmark from timeline view
  - [x] Unmarking removes the item from the timeline on next re-render

### API Integration
- [x] Calls `PATCH /api/projects/{id}/items/{item_id}` with `{ "is_milestone": true | false }`
- [x] Optimistic update: star toggles immediately before API response
- [x] On success: invalidates both `['projectItems', projectId]` and `['milestones', projectId]` React Query cache keys
- [x] On error: reverts optimistic update + logs error via console.error (no toast library in codebase)

### Access Control
- [x] Only `director` role users see the star toggle
- [x] Non-admin users see NO star at all (not disabled — completely hidden)
- [x] Role check reads from Zustand auth store

---

## Tasks

### Task 1: Create MilestoneStarToggle Molecule (0.5 days)

1. **Create `src/components/molecules/MilestoneStarToggle.tsx`**
   ```typescript
   import { Star } from 'lucide-react'
   import { cn } from '@/lib/utils'

   interface MilestoneStarToggleProps {
     isMilestone: boolean
     onToggle: () => void
     size?: 'sm' | 'md'
     showOnHoverOnly?: boolean
   }

   export function MilestoneStarToggle({
     isMilestone,
     onToggle,
     size = 'sm',
     showOnHoverOnly = false,
   }: MilestoneStarToggleProps) {
     const iconSize = size === 'sm' ? 'w-4 h-4' : 'w-5 h-5'

     return (
       <button
         type="button"
         onClick={(e) => { e.stopPropagation(); onToggle() }}
         onKeyDown={(e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); onToggle() } }}
         className={cn(
           'p-0.5 rounded transition-all duration-150 focus:ring-2 focus:ring-blue-500 focus:ring-offset-1',
           isMilestone
             ? 'text-yellow-500 hover:text-yellow-600'
             : cn(
                 'text-gray-300 hover:text-yellow-400',
                 showOnHoverOnly && 'opacity-0 group-hover:opacity-100'
               ),
         )}
         aria-label={isMilestone ? 'Remove milestone' : 'Mark as milestone'}
         tabIndex={0}
       >
         <Star
           className={cn(iconSize, isMilestone && 'fill-current')}
         />
       </button>
     )
   }
   ```

### Task 2: Create useMilestoneToggle Hook (0.25 days)

1. **Create `src/hooks/useMilestoneToggle.ts`**
   ```typescript
   import { useMutation, useQueryClient } from '@tanstack/react-query'
   import { apiClient } from '@/services/apiClient'
   import { toast } from '@/lib/toast' // or your toast utility

   export function useMilestoneToggle(projectId: string) {
     const queryClient = useQueryClient()

     return useMutation({
       mutationFn: ({ itemId, isMilestone }: { itemId: string; isMilestone: boolean }) =>
         apiClient.patch(`/projects/${projectId}/items/${itemId}`, { is_milestone: isMilestone }),

       onMutate: async ({ itemId, isMilestone }) => {
         // Cancel in-flight queries
         await queryClient.cancelQueries({ queryKey: ['projectItems', projectId] })
         await queryClient.cancelQueries({ queryKey: ['milestones', projectId] })

         // Snapshot previous values
         const previousItems = queryClient.getQueryData(['projectItems', projectId])
         const previousMilestones = queryClient.getQueryData(['milestones', projectId])

         // Optimistic update on projectItems cache
         queryClient.setQueryData(['projectItems', projectId], (old: any) => {
           if (!old?.items) return old
           return {
             ...old,
             items: old.items.map((item: any) =>
               item.id === itemId ? { ...item, is_milestone: isMilestone } : item
             ),
           }
         })

         return { previousItems, previousMilestones }
       },

       onError: (_err, _vars, context) => {
         // Rollback on error
         if (context?.previousItems) {
           queryClient.setQueryData(['projectItems', projectId], context.previousItems)
         }
         if (context?.previousMilestones) {
           queryClient.setQueryData(['milestones', projectId], context.previousMilestones)
         }
         toast.error('Failed to update milestone. Changes reverted.')
       },

       onSettled: () => {
         // Refetch to ensure consistency
         queryClient.invalidateQueries({ queryKey: ['projectItems', projectId] })
         queryClient.invalidateQueries({ queryKey: ['milestones', projectId] })
       },
     })
   }
   ```

### Task 3: Integrate Toggle into Project History Rows (0.5 days)

1. **Modify `src/components/molecules/DecisionRow.tsx`** (or future `ProjectItemRow.tsx`)
   - Import `MilestoneStarToggle` and `useMilestoneToggle`
   - Add `group` class to row container for hover detection
   - Render star toggle right-aligned, with `showOnHoverOnly={!item.is_milestone}`
   - Wrap in admin role check from auth store

### Task 4: Integrate Toggle into DrilldownModal (0.25 days)

1. **Modify `src/components/organisms/DrilldownModal.tsx`**
   - Add `MilestoneStarToggle` in modal header, next to item statement
   - Use `size="md"` variant
   - Wrap in admin role check

### Task 5: Integrate Toggle into MilestoneTimeline (0.25 days)

1. **Modify `src/components/molecules/MilestoneNode.tsx`**
   - Add `MilestoneStarToggle` as rightmost element in milestone node
   - Show filled star (always visible since all timeline items are milestones)
   - Click unflag → item removed from milestone list on cache invalidation

### Task 6: Write Tests (0.25 days)

1. **Create `src/tests/components/MilestoneStarToggle.test.tsx`**
   - Renders filled star when `isMilestone=true`
   - Renders outline star when `isMilestone=false`
   - onClick fires onToggle callback
   - Keyboard Enter fires onToggle
   - `showOnHoverOnly` applies opacity classes
   - aria-label reflects current state

2. **Create `src/tests/hooks/useMilestoneToggle.test.ts`**
   - Optimistic update changes cached data immediately
   - On API error, cache reverts to previous state
   - Cache keys invalidated on success

---

## Dev Notes

### Role Check Pattern

```typescript
const { user } = useAuthStore()
const isAdmin = user?.role === 'admin' || user?.role === 'director'

// In JSX:
{isAdmin && (
  <MilestoneStarToggle
    isMilestone={item.is_milestone}
    onToggle={() => toggleMilestone({ itemId: item.id, isMilestone: !item.is_milestone })}
    showOnHoverOnly={!item.is_milestone}
  />
)}
```

### Optimistic Update Flow

```
User clicks star
  → isMilestone toggles immediately (optimistic)
  → PATCH API call in background
  → Success: invalidate both cache keys, re-fetch
  → Error: revert to snapshot, show toast
```

### Placement in Row Layout

```
┌─────────────────────────────────────────────────────────────────┐
│ [TypeBadge] Statement text truncated...  [Disc] [Who] [Time] ★ │
└─────────────────────────────────────────────────────────────────┘
                                                              ↑ star (right-aligned)
```

---

## File List

**New Files:**
- `src/components/molecules/MilestoneStarToggle.tsx` — Reusable star toggle molecule (sm/md sizes, hover-only mode)
- `src/tests/components/MilestoneStarToggle.test.tsx` — 13 unit tests covering all behaviors

**Modified Files:**
- `src/components/molecules/ProjectItemRow.tsx` — Replaced inline star with MilestoneStarToggle, fixed hover-only logic
- `src/components/organisms/DrilldownModal.tsx` — Added MilestoneStarToggle in header (size="md")
- `src/components/molecules/MilestoneNode.tsx` — Added star toggle as rightmost element for unflagging
- `src/components/organisms/MilestoneTimeline.tsx` — Passes onToggleMilestone + isAdmin to MilestoneNode
- `src/components/organisms/Timeline.tsx` — Passes onToggleMilestone + isAdmin to SourceGroupAccordion + orphan rows
- `src/pages/ProjectDetail.tsx` — Wires useAuthStore, useToggleMilestone, and passes props to all views

---

## Testing Strategy

### Unit Tests
```
- ✅ Star renders filled (gold) when is_milestone=true
- ✅ Star renders outline (gray) when is_milestone=false
- ✅ onClick calls onToggle
- ✅ Keyboard Enter/Space calls onToggle
- ✅ showOnHoverOnly applies opacity-0 class
- ✅ Milestone items always show star (no opacity-0)
- ✅ aria-label changes based on state
- ✅ Optimistic update: cache changes immediately
- ✅ Error rollback: cache reverts to snapshot
- ✅ Toast shown on error
- ✅ Admin sees star, non-admin does not
```

### Coverage Target: 80%+

---

## Change Log

| Date | Change |
|------|--------|
| 2026-02-19 | Created story |
| 2026-02-27 | Implemented all tasks — MilestoneStarToggle molecule, integration into ProjectItemRow, DrilldownModal, MilestoneNode, MilestoneTimeline, Timeline, and ProjectDetail. Used existing useToggleMilestone hook (no new hook needed). 13 tests passing. |

---

**Related Stories:** 8.1 (Milestone Timeline), 8.3 (Filters), 9.2 (Dense rows use star)
**Blocked By:** 8.1 (MilestoneTimeline must exist), 5.2 (PATCH endpoint), 5.3 (is_milestone type)
**Blocks:** 8.3 (filter counts depend on milestone state), 8.4 (export includes milestones)
