# Story 8.3: Frontend â€” Milestone Timeline Filters

**Story ID:** 8.3
**Epic:** E8 â€” Milestone Timeline
**Assigned to:** @dev
**Sprint:** Sprint 4 (Week 6)
**Status:** Draft
**Estimation:** 5 story points (2 days)
**UX Guidelines:** `docs/ux/UX-UI-GUIDELINES.md`

---

## Summary

Add a filter bar to the Milestone Timeline so Gabriela can narrow the view by source type (Meeting, Email, Document, Manual Input) and item type (Idea, Topic, Decision, Action Item, Information). Filters combine with AND logic, display as chip toggles with icons, and persist in URL params so filtered views can be bookmarked or shared via link.

---

## Acceptance Criteria

### Filter Bar Layout
- [ ] Horizontal filter bar rendered immediately above the Dot Timeline content
- [ ] Two filter groups: "Source" and "Item Type"
- [ ] Active filter count badge: `text-xs bg-blue-600 text-white rounded-full px-1.5 py-0.5` â€” e.g., "3"
- [ ] "Clear filters" button: `text-xs text-blue-600 hover:underline` â€” resets all to unselected
- [ ] Clear button hidden when no filters active

### Source Type Filter Chips
- [ ] Four chips, each with icon + label:
  - [ ] Meeting: `Video` icon, active: `bg-indigo-100 text-indigo-700`, inactive: `bg-gray-100 text-gray-600`
  - [ ] Email: `Mail` icon, active: `bg-sky-100 text-sky-700`
  - [ ] Document: `FileText` icon, active: `bg-orange-100 text-orange-700`
  - [ ] Manual Input: `PenLine` icon, active: `bg-gray-200 text-gray-700`
- [ ] Chip styling: `inline-flex items-center gap-1 text-xs font-medium px-2.5 py-1 rounded-full cursor-pointer transition-colors`
- [ ] Toggle behavior: click activates/deactivates (multi-select â€” can have 0 or N active)

### Item Type Filter Chips
- [ ] Five chips, each with icon + label:
  - [ ] Decision: `CheckCircle2` icon, active: `bg-green-100 text-green-700`
  - [ ] Topic: `MessageCircle` icon, active: `bg-amber-100 text-amber-700`
  - [ ] Action Item: `Target` icon, active: `bg-blue-100 text-blue-700`
  - [ ] Idea: `Lightbulb` icon, active: `bg-purple-100 text-purple-700`
  - [ ] Information: `Info` icon, active: `bg-slate-100 text-slate-700`
- [ ] Same chip styling and toggle behavior as source type chips

### Filter Logic
- [ ] AND across dimensions: selecting "Meeting" + "Decision" shows only milestones from meetings that are decisions
- [ ] OR within dimension: selecting "Meeting" + "Email" shows milestones from either source type
- [ ] Empty filter = show all milestones (no filter active = unfiltered)
- [ ] Client-side filtering of the already-fetched milestone list (no additional API calls)
- [ ] Empty result state: "No milestones match your filters." + "Clear filters" link

### URL Persistence
- [ ] Filter state encoded in URL search params: `?source=meeting,email&type=decision,action_item`
- [ ] On page load: read URL params and restore filter state
- [ ] Changing filters updates URL params without page reload (use `replaceState`)
- [ ] Shareable: copying URL and opening it restores the exact filter state

---

## Tasks

### Task 1: Create MilestoneFilterBar Molecule (0.75 days)

1. **Create `src/components/molecules/MilestoneFilterBar.tsx`**
   ```typescript
   import { Video, Mail, FileText, PenLine, CheckCircle2, MessageCircle, Target, Lightbulb, Info } from 'lucide-react'
   import { cn } from '@/lib/utils'
   import type { SourceType, ItemType } from '@/types/projectItem'

   interface MilestoneFilterBarProps {
     sourceFilters: SourceType[]
     itemTypeFilters: ItemType[]
     onToggleSource: (source: SourceType) => void
     onToggleItemType: (type: ItemType) => void
     onClearAll: () => void
   }

   const SOURCE_CHIPS = [
     { value: 'meeting' as SourceType, label: 'Meeting', icon: Video, activeClass: 'bg-indigo-100 text-indigo-700' },
     { value: 'email' as SourceType, label: 'Email', icon: Mail, activeClass: 'bg-sky-100 text-sky-700' },
     { value: 'document' as SourceType, label: 'Document', icon: FileText, activeClass: 'bg-orange-100 text-orange-700' },
     { value: 'manual_input' as SourceType, label: 'Manual', icon: PenLine, activeClass: 'bg-gray-200 text-gray-700' },
   ]

   const ITEM_TYPE_CHIPS = [
     { value: 'decision' as ItemType, label: 'Decision', icon: CheckCircle2, activeClass: 'bg-green-100 text-green-700' },
     { value: 'topic' as ItemType, label: 'Topic', icon: MessageCircle, activeClass: 'bg-amber-100 text-amber-700' },
     { value: 'action_item' as ItemType, label: 'Action Item', icon: Target, activeClass: 'bg-blue-100 text-blue-700' },
     { value: 'idea' as ItemType, label: 'Idea', icon: Lightbulb, activeClass: 'bg-purple-100 text-purple-700' },
     { value: 'information' as ItemType, label: 'Info', icon: Info, activeClass: 'bg-slate-100 text-slate-700' },
   ]
   ```

### Task 2: Create Filter Logic Utility (0.25 days)

1. **Add to `src/lib/utils.ts`**
   ```typescript
   export function filterMilestones(
     milestones: ProjectItem[],
     sourceFilters: SourceType[],
     itemTypeFilters: ItemType[],
   ): ProjectItem[] {
     return milestones.filter(m => {
       if (sourceFilters.length > 0 && !sourceFilters.includes(m.source_type)) return false
       if (itemTypeFilters.length > 0 && !itemTypeFilters.includes(m.item_type)) return false
       return true
     })
   }
   ```

### Task 3: Create URL Persistence Hook (0.25 days)

1. **Create `src/hooks/useMilestoneFilters.ts`**
   ```typescript
   import { useState, useEffect } from 'react'
   import type { SourceType, ItemType } from '@/types/projectItem'

   export function useMilestoneFilters() {
     const [sourceFilters, setSourceFilters] = useState<SourceType[]>(() => {
       const params = new URLSearchParams(window.location.search)
       const source = params.get('source')
       return source ? source.split(',') as SourceType[] : []
     })

     const [itemTypeFilters, setItemTypeFilters] = useState<ItemType[]>(() => {
       const params = new URLSearchParams(window.location.search)
       const type = params.get('type')
       return type ? type.split(',') as ItemType[] : []
     })

     // Sync to URL
     useEffect(() => {
       const params = new URLSearchParams(window.location.search)
       if (sourceFilters.length > 0) params.set('source', sourceFilters.join(','))
       else params.delete('source')
       if (itemTypeFilters.length > 0) params.set('type', itemTypeFilters.join(','))
       else params.delete('type')

       const newUrl = `${window.location.pathname}${params.toString() ? '?' + params.toString() : ''}${window.location.hash}`
       window.history.replaceState(null, '', newUrl)
     }, [sourceFilters, itemTypeFilters])

     const toggleSource = (source: SourceType) => {
       setSourceFilters(prev =>
         prev.includes(source) ? prev.filter(s => s !== source) : [...prev, source]
       )
     }

     const toggleItemType = (type: ItemType) => {
       setItemTypeFilters(prev =>
         prev.includes(type) ? prev.filter(t => t !== type) : [...prev, type]
       )
     }

     const clearAll = () => {
       setSourceFilters([])
       setItemTypeFilters([])
     }

     const activeCount = sourceFilters.length + itemTypeFilters.length

     return { sourceFilters, itemTypeFilters, toggleSource, toggleItemType, clearAll, activeCount }
   }
   ```

### Task 4: Integrate with MilestoneTimeline (0.25 days)

1. **Modify `src/components/organisms/MilestoneTimeline.tsx`**
   - Import `MilestoneFilterBar` and `useMilestoneFilters`
   - Apply `filterMilestones()` before grouping into stages
   - Render `MilestoneFilterBar` above the timeline
   - Show empty filter result state when filtered list is empty

### Task 5: Write Tests (0.5 days)

1. **Create `src/tests/components/MilestoneFilterBar.test.tsx`**
   - Source chips render all 4 options
   - Item type chips render all 5 options
   - Click toggles chip active state
   - Active chips use correct color classes
   - Active count badge shows correct number
   - Clear all resets both filter dimensions

2. **Create `src/tests/hooks/useMilestoneFilters.test.ts`**
   - Reads initial state from URL params
   - Toggle adds/removes from filter array
   - URL params updated on filter change
   - Clear all empties both arrays and clears URL params

---

## Dev Notes

### Filter Bar Visual Layout

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Source: [ğŸ“¹ Meeting] [âœ‰ï¸ Email] [ğŸ“„ Document] [âœï¸ Manual]                  â”‚
â”‚ Type:   [âœ“ Decision] [ğŸ’¬ Topic] [ğŸ¯ Action] [ğŸ’¡ Idea] [â„¹ï¸ Info]  3 â•³Clear â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### AND/OR Logic

- **Within dimension (OR):** "Meeting" + "Email" â†’ show milestones from EITHER meeting OR email
- **Across dimensions (AND):** "Meeting" + "Decision" â†’ show milestones from meetings that are ALSO decisions
- This matches standard faceted filter behavior

### Performance

Filter runs client-side on the already-fetched milestone list. With typical project sizes (5-50 milestones), there's no performance concern. The `filterMilestones` function is a simple `Array.filter()`.

---

## File List

**New Files:**
- `src/components/molecules/MilestoneFilterBar.tsx` â€” Filter chip bar
- `src/hooks/useMilestoneFilters.ts` â€” URL-persisted filter state hook
- `src/tests/components/MilestoneFilterBar.test.tsx`
- `src/tests/hooks/useMilestoneFilters.test.ts`

**Modified Files:**
- `src/components/organisms/MilestoneTimeline.tsx` â€” Integrate filter bar + apply filtering
- `src/lib/utils.ts` â€” Add `filterMilestones()` utility

---

## Testing Strategy

### Unit Tests
```
- âœ… All 4 source type chips render
- âœ… All 5 item type chips render
- âœ… Click toggles chip active/inactive
- âœ… Active chip applies correct color class
- âœ… Inactive chip applies neutral gray class
- âœ… Active count badge reflects correct number
- âœ… Clear all resets to zero active
- âœ… filterMilestones: no filters = all items returned
- âœ… filterMilestones: source filter restricts by source_type
- âœ… filterMilestones: item filter restricts by item_type
- âœ… filterMilestones: combined filters use AND across, OR within
- âœ… URL params set on filter change
- âœ… URL params read on initial load
- âœ… Empty filter result shows message
```

### Coverage Target: 80%+

---

## Change Log

| Date | Change |
|------|--------|
| 2026-02-19 | Created story |

---

**Related Stories:** 8.1 (Timeline it filters), 8.2 (Milestone state), 8.4 (Export respects filters)
**Blocked By:** 8.1 (MilestoneTimeline), 5.3 (ItemType, SourceType TS types)
**Blocks:** 8.4 (export respects current filter state)
