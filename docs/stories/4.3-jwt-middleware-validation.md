# Story 4.3: JWT Middleware & Token Validation

**Story ID:** 4.3
**Assigned to:** @dev
**Sprint:** Sprint 6 (Week 8)
**Status:** Draft
**Estimation:** 3 story points (1-2 days)

---

## Summary

Create JWT validation middleware that extracts tokens from cookies/headers, verifies signatures and expiration, attaches user info to request context, and handles 401 errors for protected routes.

---

## Acceptance Criteria

- [ ] Middleware extracts JWT from:
  - [ ] HTTP-only cookie (primary)
  - [ ] Authorization header (fallback)
- [ ] Token validation:
  - [ ] Signature verification
  - [ ] Expiration check
  - [ ] User exists in database
- [ ] User object attached to `request.state.user`
- [ ] Returns 401 if token invalid/expired
- [ ] Public routes exempt (`/auth/login`, `/health`)
- [ ] Applied to all protected routes
- [ ] Tests passing: `pytest tests/middleware/test_auth.py`

---

## Tasks

### Task 1: Create Auth Middleware (1 day)

```python
# app/middleware/auth.py
from fastapi import Request, HTTPException
from starlette.middleware.base import BaseHTTPMiddleware
from app.utils.jwt import decode_jwt_token
from app.models.user import User
from app.database import SessionLocal

PUBLIC_PATHS = ["/api/auth/login", "/health", "/docs", "/openapi.json"]

class AuthMiddleware(BaseHTTPMiddleware):
    async def dispatch(self, request: Request, call_next):
        # Skip public paths
        if any(request.url.path.startswith(path) for path in PUBLIC_PATHS):
            return await call_next(request)
        
        # Extract token
        token = request.cookies.get("access_token")
        if not token:
            auth_header = request.headers.get("Authorization", "")
            if auth_header.startswith("Bearer "):
                token = auth_header.replace("Bearer ", "")
        
        if not token:
            raise HTTPException(status_code=401, detail="Unauthorized")
        
        # Validate token
        try:
            payload = decode_jwt_token(token)
        except ValueError as e:
            raise HTTPException(status_code=401, detail=str(e))
        
        # Load user
        db = SessionLocal()
        try:
            user = db.query(User).filter(
                User.id == payload["user_id"],
                User.deleted_at.is_(None)
            ).first()
            
            if not user:
                raise HTTPException(status_code=401, detail="User not found")
            
            # Attach user to request
            request.state.user = user
        finally:
            db.close()
        
        return await call_next(request)
```

### Task 2: Apply Middleware (0.25 days)

```python
# app/main.py
from app.middleware.auth import AuthMiddleware

app = FastAPI()
app.add_middleware(AuthMiddleware)
```

### Task 3: Create Dependency Injection Helper (0.25 days)

```python
# app/api/dependencies.py
from fastapi import Request, Depends

def get_current_user(request: Request):
    if not hasattr(request.state, "user"):
        raise HTTPException(status_code=401, detail="Unauthorized")
    return request.state.user
```

### Task 4: Write Tests (0.5 days)

```python
# tests/middleware/test_auth.py
def test_valid_token_allows_access(client, test_user, auth_token):
    response = client.get(
        "/api/projects",
        cookies={"access_token": auth_token}
    )
    assert response.status_code == 200

def test_missing_token_returns_401(client):
    response = client.get("/api/projects")
    assert response.status_code == 401

def test_expired_token_returns_401(client, expired_token):
    response = client.get(
        "/api/projects",
        cookies={"access_token": expired_token}
    )
    assert response.status_code == 401

def test_public_paths_accessible(client):
    response = client.post("/api/auth/login", json={"email": "test@ex.com", "password": "pw"})
    # Should not require token (will fail auth, but not middleware)
    assert response.status_code in [200, 401]
```

---

## File List

**Modified/Created:**
- `app/middleware/auth.py` (new)
- `app/api/dependencies.py` (new)
- `app/main.py` (modify - add middleware)
- `tests/middleware/test_auth.py` (new)

---

**Related Stories:** 4.2 (JWT Auth), 4.4 (Role-Based Authorization)
**Blocked By:** 4.2
**Blocks:** 4.4
