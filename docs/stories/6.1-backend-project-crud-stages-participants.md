# Story 6.1: Backend — Project CRUD, Stage Schedule & Participants

**Story ID:** 6.1
**Epic:** E6 — Project Management Foundation
**Assigned to:** @dev
**Sprint:** Sprint 2 (Week 3)
**Status:** Draft
**Estimation:** 8 story points (3 days)
**Review:** @architect (Aria) — schema & API validation

---

## Summary

Build backend API endpoints for full project lifecycle management: extended Project CRUD (create with title, description, project_type), stage schedule management (ordered stages with date ranges, predefined templates), and project participant roster CRUD (name, email, discipline). This enables Gabriela to set up projects before the first meeting and provides the stage schedule data required for the Milestone Timeline (E8).

---

## Architect Review Notes Incorporated

| Advisory | Resolution |
|----------|------------|
| A5: ProjectParticipant partial unique indexes | Implemented in Story 5.1 migration; enforced at API level here |
| A6: Drop `is_current`, use `actual_stage_id` only | Single FK on Project, no boolean on stage |

---

## Acceptance Criteria

### Project CRUD (Extended)
- [ ] `POST /api/projects` extended with: `title` (required), `description`, `project_type`, `stages[]`, `participants[]`
  - [ ] Creates project + stage schedule + participants in one transaction
  - [ ] Returns created project with stages and participant count
- [ ] `PATCH /api/projects/{id}` updates: `title`, `description`, `project_type`, `actual_stage_id`
  - [ ] `actual_stage_id` must reference an existing stage for this project
- [ ] `DELETE /api/projects/{id}` archives project (sets `archived_at`, does NOT hard-delete)
- [ ] `GET /api/projects/{id}` extended response includes: `stages[]`, `participant_count`, `current_stage`, `project_type`
- [ ] `GET /api/projects` list includes: `current_stage_name` badge, `project_type`, `item_count` (replaces `decision_count`)

### Stage Schedule
- [ ] `GET /api/projects/{id}/stages` — List stages ordered by `sort_order`
- [ ] `POST /api/projects/{id}/stages` — Set stage schedule (replaces all stages)
  - [ ] Accepts array of `{stage_name, stage_from, stage_to}`
  - [ ] Auto-generates `sort_order` from array position
  - [ ] Date validation: `stage_from < stage_to` for each stage
  - [ ] Date validation: no overlapping date ranges between stages
  - [ ] Date validation: stages sequential (stage N's `stage_to` ≤ stage N+1's `stage_from`)
- [ ] `PATCH /api/projects/{id}/stages/{stage_id}` — Update single stage (name, dates)
  - [ ] Re-validates date constraints after update
- [ ] `actual_stage_id` updated via `PATCH /api/projects/{id}` (not on stage endpoint)

### Stage Templates
- [ ] `GET /api/stage-templates` — List predefined templates
- [ ] `stage_templates` table seeded with at least 2 templates:
  - [ ] **Architecture Full:** Briefing (30d) → Levantamento (45d) → Estudo Preliminar (60d) → Anteprojeto (60d) → Projeto Legal (30d) → Projeto Executivo (90d) → Acompanhamento de Obra (180d)
  - [ ] **Architecture Legal:** Briefing (15d) → Estudo Preliminar (30d) → Projeto Legal (45d) → Projeto Executivo (60d)
- [ ] Template response includes: `id`, `project_type`, `template_name`, `stages[]` with `{stage_name, default_duration_days}`

### Project Participants
- [ ] `GET /api/projects/{id}/participants` — List participants
- [ ] `POST /api/projects/{id}/participants` — Add participant
  - [ ] Required: `name`, `discipline`
  - [ ] Optional: `email`, `role`
  - [ ] Validates discipline against Discipline enum (15 values)
  - [ ] Enforces unique email per project (when email provided)
  - [ ] Enforces unique name per project (when no email provided)
- [ ] `PATCH /api/projects/{id}/participants/{id}` — Update participant
- [ ] `DELETE /api/projects/{id}/participants/{id}` — Remove participant
- [ ] Participant count included in project detail response

### Database (Migration 003)
- [ ] `project_stages` table created (if not already in 5.1)
- [ ] `stage_templates` table created and seeded
- [ ] `projects` table extended: `project_type VARCHAR(100)`, `actual_stage_id UUID FK → project_stages`
- [ ] Indexes: `idx_stages_project`, `idx_stages_sort`

### Backward Compatibility
- [ ] Existing project listing still works (V1 projects without stages show `null` current_stage)
- [ ] `GET /api/projects` response shape extends, does not break V1 consumers
- [ ] Projects without stages are valid (stages optional)

---

## Tasks

### Task 1: Create Migration 003 — Stages & Templates (0.5 days)

1. **Create `decision-log-backend/app/database/migrations/003_add_stages_templates.py`**
   ```python
   def upgrade():
       # Create project_stages table
       op.create_table('project_stages',
           sa.Column('id', GUID(), primary_key=True),
           sa.Column('project_id', GUID(), sa.ForeignKey('projects.id', ondelete='CASCADE'), nullable=False),
           sa.Column('stage_name', sa.String(255), nullable=False),
           sa.Column('stage_from', sa.Date, nullable=False),
           sa.Column('stage_to', sa.Date, nullable=False),
           sa.Column('sort_order', sa.Integer, nullable=False),
           sa.Column('created_at', sa.DateTime, server_default=func.now()),
           sa.Column('updated_at', sa.DateTime, server_default=func.now()),
           sa.CheckConstraint('stage_from < stage_to', name='ck_stage_dates'),
       )
       op.create_index('idx_stages_project', 'project_stages', ['project_id'])
       op.create_index('idx_stages_sort', 'project_stages', ['project_id', 'sort_order'])

       # Create stage_templates table
       op.create_table('stage_templates',
           sa.Column('id', GUID(), primary_key=True),
           sa.Column('project_type', sa.String(100), nullable=False),
           sa.Column('template_name', sa.String(255), nullable=False),
           sa.Column('stages', JSONType, nullable=False),
           sa.Column('created_at', sa.DateTime, server_default=func.now()),
       )

       # Extend projects table
       op.add_column('projects', sa.Column('project_type', sa.String(100)))
       op.add_column('projects', sa.Column('actual_stage_id', GUID(),
           sa.ForeignKey('project_stages.id', ondelete='SET NULL')))

       # Seed stage templates
       op.execute("""
           INSERT INTO stage_templates (id, project_type, template_name, stages) VALUES
           (gen_random_uuid(), 'architecture_full', 'Architecture Full Project', '[
               {"stage_name":"Briefing","default_duration_days":30},
               {"stage_name":"Levantamento","default_duration_days":45},
               {"stage_name":"Estudo Preliminar","default_duration_days":60},
               {"stage_name":"Anteprojeto","default_duration_days":60},
               {"stage_name":"Projeto Legal","default_duration_days":30},
               {"stage_name":"Projeto Executivo","default_duration_days":90},
               {"stage_name":"Acompanhamento de Obra","default_duration_days":180}
           ]'),
           (gen_random_uuid(), 'architecture_legal', 'Architecture Legal Project', '[
               {"stage_name":"Briefing","default_duration_days":15},
               {"stage_name":"Estudo Preliminar","default_duration_days":30},
               {"stage_name":"Projeto Legal","default_duration_days":45},
               {"stage_name":"Projeto Executivo","default_duration_days":60}
           ]');
       """)
   ```

### Task 2: Create Pydantic Models (0.25 days)

1. **Create `decision-log-backend/app/api/models/project.py`** (extended)
   ```python
   class ProjectCreate(BaseModel):
       title: str
       description: Optional[str] = None
       project_type: Optional[str] = None
       stages: Optional[List[StageCreate]] = None
       participants: Optional[List[ParticipantCreate]] = None

   class StageCreate(BaseModel):
       stage_name: str
       stage_from: date
       stage_to: date

       @validator('stage_to')
       def end_after_start(cls, v, values):
           if 'stage_from' in values and v <= values['stage_from']:
               raise ValueError('stage_to must be after stage_from')
           return v

   class ParticipantCreate(BaseModel):
       name: str
       email: Optional[str] = None
       discipline: Discipline
       role: Optional[str] = None

   class StageResponse(BaseModel):
       id: str
       stage_name: str
       stage_from: str
       stage_to: str
       sort_order: int
       is_current: bool  # Computed: project.actual_stage_id == stage.id

   class StageTemplateResponse(BaseModel):
       id: str
       project_type: str
       template_name: str
       stages: List[dict]  # [{stage_name, default_duration_days}]
   ```

### Task 3: Create Stages Router (0.75 days)

1. **Create `decision-log-backend/app/api/routes/stages.py`**
   - `GET /api/projects/{id}/stages`
   - `POST /api/projects/{id}/stages` with date validation
   - `PATCH /api/projects/{id}/stages/{stage_id}`
   - `GET /api/stage-templates`

2. **Date validation logic**
   ```python
   def validate_stage_schedule(stages: List[StageCreate]):
       """Validate no overlaps, sequential ordering."""
       sorted_stages = sorted(stages, key=lambda s: s.stage_from)
       for i, stage in enumerate(sorted_stages):
           if stage.stage_from >= stage.stage_to:
               raise HTTPException(400, f"Stage '{stage.stage_name}': start must be before end")
           if i > 0 and stage.stage_from < sorted_stages[i-1].stage_to:
               raise HTTPException(400,
                   f"Stage '{stage.stage_name}' overlaps with '{sorted_stages[i-1].stage_name}'")
   ```

### Task 4: Create Participants Router (0.5 days)

1. **Create `decision-log-backend/app/api/routes/participants.py`**
   - Full CRUD: GET list, POST create, PATCH update, DELETE remove
   - Validate discipline against enum
   - Handle unique constraint violations gracefully (409 Conflict)

### Task 5: Extend Project Router (0.5 days)

1. **Modify `decision-log-backend/app/api/routes/projects.py`**
   - Extended `POST /api/projects` — accepts stages + participants in body
   - Extended `PATCH /api/projects/{id}` — accepts `actual_stage_id`
   - Extended `GET /api/projects/{id}` — includes stages, participant_count, current_stage
   - Extended `GET /api/projects` — includes current_stage_name, project_type, item_count

### Task 6: Update ORM Models & Write Tests (0.5 days)

1. **Update `models.py`** — Add `ProjectStage`, `StageTemplate` models
2. **Create `tests/unit/test_stages_api.py`**
   - Stage CRUD operations
   - Date validation (overlap rejection, sequential enforcement)
   - Template listing
   - Actual stage setting
3. **Create `tests/unit/test_participants_api.py`**
   - Participant CRUD operations
   - Unique constraint enforcement
   - Discipline validation

---

## Dev Notes

### API Response Examples

**POST /api/projects (Extended)**
```json
{
  "title": "Residential Tower Alpha",
  "description": "50-floor residential tower in downtown São Paulo",
  "project_type": "architecture_full",
  "stages": [
    {"stage_name": "Briefing", "stage_from": "2026-03-01", "stage_to": "2026-03-31"},
    {"stage_name": "Levantamento", "stage_from": "2026-04-01", "stage_to": "2026-05-15"},
    {"stage_name": "Estudo Preliminar", "stage_from": "2026-05-16", "stage_to": "2026-07-15"}
  ],
  "participants": [
    {"name": "Gabriela", "email": "gabriela@soubim.com", "discipline": "architecture", "role": "Director"},
    {"name": "Carlos", "email": "carlos@soubim.com", "discipline": "structural", "role": "Lead Engineer"}
  ]
}
```

**GET /api/projects (Extended Response)**
```json
{
  "projects": [
    {
      "id": "uuid",
      "name": "Residential Tower Alpha",
      "project_type": "architecture_full",
      "current_stage": {"name": "Estudo Preliminar", "stage_from": "2026-05-16", "stage_to": "2026-07-15"},
      "participant_count": 6,
      "item_count": 127,
      "created_at": "2026-03-01T10:00:00Z"
    }
  ]
}
```

### Route File Organization

```
app/api/routes/
├── projects.py       (MODIFIED — extended CRUD)
├── stages.py         (NEW — stage schedule)
├── participants.py   (NEW — participant roster)
├── project_items.py  (from 5.2)
├── decisions.py      (backward compat)
├── auth.py           (existing)
└── webhooks.py       (existing)
```

---

## File List

**New Files:**
- `decision-log-backend/app/database/migrations/003_add_stages_templates.py`
- `decision-log-backend/app/api/models/project.py` — Extended project Pydantic models
- `decision-log-backend/app/api/routes/stages.py` — Stage schedule router
- `decision-log-backend/app/api/routes/participants.py` — Participants router
- `decision-log-backend/tests/unit/test_stages_api.py`
- `decision-log-backend/tests/unit/test_participants_api.py`

**Modified Files:**
- `decision-log-backend/app/database/models.py` — Add ProjectStage, StageTemplate models
- `decision-log-backend/app/api/routes/projects.py` — Extended CRUD
- `decision-log-backend/app/main.py` — Register new routers

---

## Testing Strategy

### Unit Tests
```
- ✅ Create project with stages and participants
- ✅ Stage date validation (overlap, sequential, from<to)
- ✅ Stage template listing returns seeded templates
- ✅ Set actual_stage_id on project
- ✅ Participant CRUD with discipline validation
- ✅ Unique email constraint per project
- ✅ Unique name constraint (when no email)
- ✅ V1 projects without stages display correctly
- ✅ Archive project (soft delete)
```

### Coverage Target
- 85%+
- Run: `cd decision-log-backend && python3 -m pytest tests/unit/test_stages_api.py tests/unit/test_participants_api.py -v`

---

## Change Log

| Date | Change |
|------|--------|
| 2026-02-16 | Created story with architect advisories incorporated |

---

**Related Stories:** 5.1 (DB Migration), 6.2 (Frontend Form), 6.3 (Project List)
**Blocked By:** 5.1 (Migration — needs project_participants table, extended projects table)
**Blocks:** 6.2 (Frontend form needs these endpoints), 8.1 (Milestone Timeline needs stage data)
