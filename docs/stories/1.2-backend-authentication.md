# Story 1.2: Backend Authentication (JWT)

**Story ID:** 1.2
**Assigned to:** @dev
**Sprint:** Sprint 1 (Week 1)
**Status:** Draft
**Estimation:** 5 story points (1.5 days)

---

## Summary

Implement user authentication endpoints: login, me, logout. Use JWT tokens with bcrypt password hashing. Enable secure user authentication for the entire system.

---

## Acceptance Criteria

- [ ] `POST /api/auth/login` - Returns JWT token + user info
  - [ ] Email/password validation
  - [ ] Password checked with bcrypt
  - [ ] JWT created (HS256, 7-day expiration)
  - [ ] User info returned in response
  - [ ] 401 error on invalid credentials
- [ ] `GET /api/auth/me` - Get current user
  - [ ] JWT extracted from Authorization header
  - [ ] Token validated and user loaded from DB
  - [ ] 401 error on invalid/expired token
  - [ ] Returns user object + project list
- [ ] `POST /api/auth/logout` - Logout endpoint
  - [ ] Returns 204 No Content
  - [ ] Client removes token
- [ ] JWT middleware
  - [ ] Validates token on all protected endpoints
  - [ ] Extracts user_id, email, role
  - [ ] Raises 401 on invalid token
- [ ] Tests passing: `pytest tests/unit/test_auth.py` (80%+ coverage)
- [ ] Postman collection working with login flow

---

## Tasks

### Task 1: Implement Login Endpoint (1 day)
- [ ] Create `app/services/auth_service.py`
  - [ ] `authenticate_user(email, password)` - Verify password + return user
  - [ ] Query database for user by email
  - [ ] Check password with `bcrypt.checkpw()`
  - [ ] Raise exception if not found or password wrong
- [ ] Update `app/api/routes/auth.py` POST /auth/login
  - [ ] Accept LoginRequest (email, password)
  - [ ] Call auth_service.authenticate_user()
  - [ ] Call utils.security.create_access_token()
  - [ ] Return TokenResponse with user object
  - [ ] Handle exceptions → 401 response
- [ ] Test with Postman
  - [ ] Valid credentials → 200 + token
  - [ ] Invalid password → 401
  - [ ] Missing email → 400

### Task 2: Implement Me Endpoint
- [ ] Create middleware to extract JWT token
  - [ ] Read Authorization: Bearer <token> header
  - [ ] Call utils.security.decode_access_token()
  - [ ] Load user from database
  - [ ] Attach to request context
- [ ] Update `GET /api/auth/me`
  - [ ] Extract user from middleware
  - [ ] Load user's projects from database
  - [ ] Return UserResponse with projects list
  - [ ] 401 if token invalid/expired
- [ ] Test: Valid token → user + projects list

### Task 3: Implement Logout Endpoint
- [ ] Create `POST /api/auth/logout`
  - [ ] Returns 204 No Content
  - [ ] Validates JWT (prevents 404 errors)
  - [ ] Client handles token removal
- [ ] Test: Valid token → 204

### Task 4: JWT Middleware
- [ ] Create `app/api/middleware/auth.py`
  - [ ] Extract token from Authorization header
  - [ ] Validate with `decode_access_token()`
  - [ ] Load user from database
  - [ ] Attach to request.state.user
  - [ ] Raise 401 on failure
- [ ] Add middleware to FastAPI app
  - [ ] Add to main.py before routes
  - [ ] Wrap protected endpoints
- [ ] Test: Verify middleware called on protected routes

### Task 5: Write Tests
- [ ] Create `tests/unit/test_auth.py`
  - [ ] Test login with valid credentials
  - [ ] Test login with invalid password
  - [ ] Test login with missing email
  - [ ] Test me endpoint with valid token
  - [ ] Test me endpoint with invalid token
  - [ ] Test logout returns 204
  - [ ] Test middleware rejects bad tokens
- [ ] Min 80% coverage of auth.py and auth_service.py
- [ ] Run: `pytest tests/unit/test_auth.py --cov`

---

## Dev Notes

**Database Required:**
- Requires Story 1.1 (database schema) to be completed
- Must have test user seeded

**Security Checklist:**
- ✅ Passwords hashed with bcrypt cost=12
- ✅ JWT uses HS256 (not RS256, ok for MVP)
- ✅ 7-day expiration reasonable
- ✅ No token refresh (implement Phase 2)
- ✅ No password reset yet (implement Phase 2)

**Testing Strategy:**
- Unit tests for service functions
- Integration tests for endpoints
- Test with curl/Postman before frontend integration

---

## File List

**Modified/Created:**
- `app/services/auth_service.py` (new) - Auth business logic
- `app/api/middleware/auth.py` (new) - JWT validation
- `app/api/routes/auth.py` (modify) - Implement endpoints
- `app/utils/security.py` (existing - already has JWT utils)
- `tests/unit/test_auth.py` (new) - Unit tests

---

## Completion Notes

_Fill in after completing the story_

- **Date Completed:**
- **Actual Points:**
- **Issues Encountered:**
- **Lessons Learned:**

---

## Change Log

| Date | Change |
|------|--------|
| 2026-02-07 | Created story |

---

**Related Stories:** 1.1 (Database), 1.4 (Frontend Login)
**Blocked By:** 1.1 (database schema required)
**Blocks:** 1.3, 1.5 (need auth to test other endpoints)
